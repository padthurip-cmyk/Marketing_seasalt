<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#dc2626">
<meta name="apple-mobile-web-app-title" content="SeaSalt Intel">
<link rel="manifest" href="/manifest.json">
<title>SeaSalt Intelligence Hub</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="/_config.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg-deep:#f8f9fa;--bg-surface:#ffffff;--bg-card:#ffffff;--bg-elevated:#f1f3f5;--border:#e2e5e9;--border-subtle:#eceef1;--text-primary:#1a1a2e;--text-secondary:#4a5568;--text-muted:#8896a6;--accent-red:#dc2626;--accent-orange:#ea580c;--accent-amber:#d97706;--accent-emerald:#059669;--accent-blue:#2563eb;--accent-violet:#7c3aed;--accent-pink:#db2777;--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg-deep);color:var(--text-primary);min-height:100vh;min-height:100dvh;display:flex;overflow:hidden;-webkit-tap-highlight-color:transparent}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#d0d5dd;border-radius:10px}
/* â•â•â• SIDEBAR â€” Desktop â•â•â• */
.sidebar{width:240px;min-width:240px;background:#ffffff;border-right:1px solid var(--border);display:flex;flex-direction:column;height:100vh;height:100dvh;z-index:50;box-shadow:2px 0 8px rgba(0,0,0,.04);transition:all .25s}
.sidebar-brand{padding:20px 20px 16px;border-bottom:1px solid var(--border-subtle)}.sidebar-brand h1{font-size:18px;font-weight:800}.sidebar-brand p{font-size:11px;color:var(--accent-red);font-weight:600;letter-spacing:1.5px;text-transform:uppercase;margin-top:2px}
.sidebar-section{padding:16px 12px 4px;font-size:10px;font-weight:700;color:var(--text-muted);letter-spacing:1.8px;text-transform:uppercase}
.sidebar-nav{flex:1;overflow-y:auto;padding:4px 8px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;font-size:13.5px;font-weight:500;color:var(--text-secondary);transition:all .15s;margin-bottom:2px;position:relative;text-decoration:none;-webkit-touch-callout:none;user-select:none}
.nav-item:hover{background:#f1f3f5;color:var(--text-primary)}.nav-item.active{background:linear-gradient(135deg,rgba(220,38,38,.08),rgba(234,88,12,.05));color:var(--accent-red);font-weight:600}
.nav-item.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:20px;background:var(--accent-red);border-radius:0 3px 3px 0}
.nav-item .icon{font-size:16px;width:22px;text-align:center}
.sidebar-footer{padding:12px 16px;border-top:1px solid var(--border-subtle)}.status-dot{width:7px;height:7px;border-radius:50%;display:inline-block;animation:pulse-dot 2s infinite}
@keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:.4}}
.sidebar-links{display:flex;gap:4px;flex-wrap:wrap;padding:0 8px 8px}
/* â•â•â• MOBILE BOTTOM NAV â•â•â• */
.mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:#ffffff;border-top:1px solid var(--border);z-index:60;padding:4px 0 calc(4px + var(--safe-bottom));box-shadow:0 -4px 20px rgba(0,0,0,.08)}
.mobile-nav-inner{display:flex;justify-content:space-around;align-items:center}
.mob-tab{display:flex;flex-direction:column;align-items:center;gap:1px;padding:6px 4px;border-radius:8px;cursor:pointer;font-size:9px;font-weight:600;color:var(--text-muted);transition:all .15s;min-width:48px;-webkit-touch-callout:none;user-select:none}
.mob-tab.active{color:var(--accent-red)}.mob-tab .mob-icon{font-size:18px}
.mob-tab:active{transform:scale(.92);background:rgba(220,38,38,.05)}
/* â•â•â• MOBILE MENU OVERLAY â•â•â• */
.mobile-menu-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:55;backdrop-filter:blur(2px)}
.mobile-menu{position:fixed;left:0;top:0;bottom:0;width:280px;background:#fff;z-index:56;transform:translateX(-100%);transition:transform .25s ease;overflow-y:auto;box-shadow:4px 0 20px rgba(0,0,0,.15);padding-top:var(--safe-top)}
.mobile-menu.open{transform:translateX(0)}
.mobile-menu-overlay.show{display:block}
/* â•â•â• MAIN CONTENT â•â•â• */
.main-content{flex:1;display:flex;flex-direction:column;height:100vh;height:100dvh;overflow:hidden}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;background:#ffffff;border-bottom:1px solid var(--border);min-height:58px;padding-top:calc(14px + var(--safe-top))}
.topbar-left h2{font-size:18px;font-weight:700}.topbar-left .subtitle{font-size:12px;color:var(--text-muted)}
.hamburger{display:none;width:36px;height:36px;border-radius:8px;border:1px solid var(--border);background:transparent;cursor:pointer;font-size:18px;align-items:center;justify-content:center}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;font-size:12.5px;font-weight:600;cursor:pointer;border:none;transition:all .15s;font-family:inherit;-webkit-touch-callout:none;user-select:none}
.btn:active{transform:scale(.96)}
.btn-primary{background:var(--accent-red);color:#fff}.btn-primary:hover{background:#dc2626}.btn-ghost{background:#f8f9fa;color:var(--text-secondary);border:1px solid var(--border)}.btn-ghost:hover{background:var(--border);color:var(--text-primary)}
.btn-blue{background:var(--accent-blue);color:#fff}.btn-emerald{background:var(--accent-emerald);color:#fff}.btn-orange{background:var(--accent-orange);color:#fff}.btn-violet{background:var(--accent-violet);color:#fff}
.btn-sm{padding:6px 12px;font-size:11.5px}.btn:disabled{opacity:.5;cursor:not-allowed}
.page-content{flex:1;overflow-y:auto;padding:24px 28px;-webkit-overflow-scrolling:touch}.page{display:none}.page.active{display:block}
.card{background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:20px;transition:all .2s;box-shadow:0 1px 3px rgba(0,0,0,.06)}.card:hover{border-color:var(--accent-blue);box-shadow:0 4px 12px rgba(0,0,0,.08)}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}.card-title{font-size:14px;font-weight:700}.card-subtitle{font-size:11px;color:var(--text-muted);margin-top:2px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:18px 20px;position:relative;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.stat-card.red::before{background:var(--accent-red)}.stat-card.blue::before{background:var(--accent-blue)}.stat-card.emerald::before{background:var(--accent-emerald)}.stat-card.amber::before{background:var(--accent-amber)}.stat-card.violet::before{background:var(--accent-violet)}.stat-card.orange::before{background:var(--accent-orange)}.stat-card.pink::before{background:var(--accent-pink)}
.stat-label{font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.8px}.stat-value{font-size:28px;font-weight:800;margin:6px 0 2px;letter-spacing:-1px}.stat-change{font-size:11px;font-weight:600}.stat-change.up{color:var(--accent-emerald)}.stat-change.down{color:var(--accent-red)}
.data-table{width:100%;border-collapse:collapse}.data-table th{text-align:left;font-size:10px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;padding:10px 14px;border-bottom:1px solid var(--border-subtle)}
.data-table td{padding:12px 14px;font-size:13px;color:var(--text-secondary);border-bottom:1px solid var(--border-subtle)}.data-table tr:hover td{background:#f8f9fa;color:var(--text-primary)}.data-table tr:last-child td{border-bottom:none}
.badge{display:inline-flex;align-items:center;padding:3px 8px;border-radius:6px;font-size:10.5px;font-weight:700}
.badge-red{background:rgba(220,38,38,.1);color:#dc2626}.badge-green{background:rgba(5,150,105,.1);color:#059669}.badge-blue{background:rgba(37,99,235,.1);color:#2563eb}.badge-amber{background:rgba(217,119,6,.1);color:#d97706}.badge-violet{background:rgba(124,58,237,.1);color:#7c3aed}.badge-orange{background:rgba(234,88,12,.1);color:#ea580c}
.stars{color:#fbbf24;font-size:13px}.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}.comp-dot{width:10px;height:10px;border-radius:50%;display:inline-block}
.chart-bar-container{display:flex;align-items:end;gap:6px;height:120px;padding-top:8px}.chart-bar{flex:1;border-radius:4px 4px 0 0;transition:height .5s;position:relative;min-width:24px}.chart-bar-label{position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);font-size:9px;color:var(--text-muted);white-space:nowrap}
.intel-input{background:#f8f9fa;border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text-primary);font-size:13px;font-family:inherit;width:100%;transition:border-color .2s}.intel-input:focus{outline:none;border-color:var(--accent-blue);box-shadow:0 0 0 3px rgba(37,99,235,.1)}.intel-input::placeholder{color:var(--text-muted)}
textarea.intel-input{resize:vertical;min-height:80px}select.intel-input{appearance:none;padding-right:32px}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}.animate-in{animation:fadeIn .35s ease-out}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(4px);z-index:100;align-items:center;justify-content:center}.modal-overlay.show{display:flex}
.modal-box{background:#ffffff;border:1px solid var(--border);border-radius:16px;padding:28px;width:90%;max-width:600px;max-height:85vh;overflow-y:auto;animation:slideUp .3s ease;box-shadow:0 20px 60px rgba(0,0,0,.15);-webkit-overflow-scrolling:touch}
.modal-title{font-size:18px;font-weight:700;margin-bottom:4px}
.toast-container{position:fixed;top:calc(20px + var(--safe-top));right:20px;z-index:200;display:flex;flex-direction:column;gap:8px}
.toast{background:#ffffff;border:1px solid var(--border);border-radius:10px;padding:12px 18px;font-size:13px;font-weight:500;display:flex;align-items:center;gap:8px;animation:slideUp .3s ease;box-shadow:0 8px 30px rgba(0,0,0,.12)}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-muted)}.empty-state .es-icon{font-size:48px;margin-bottom:12px}.empty-state h3{font-size:18px;font-weight:700;color:var(--text-secondary);margin-bottom:6px}.empty-state p{font-size:13px;max-width:400px;margin:0 auto 16px}
.insight-card{background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:20px;border-left:3px solid;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.insight-card.opportunity{border-left-color:var(--accent-emerald)}.insight-card.threat{border-left-color:var(--accent-red)}.insight-card.trend{border-left-color:var(--accent-blue)}.insight-card.action{border-left-color:var(--accent-amber)}
.social-profile{display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;transition:background .15s}.social-profile:hover{background:#f1f3f5}
.social-avatar{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent-red);border-radius:50%;animation:spin .6s linear infinite;display:inline-block}@keyframes spin{to{transform:rotate(360deg)}}
.field-group{margin-bottom:12px}.field-label{font-size:11px;font-weight:600;color:var(--text-muted);display:block;margin-bottom:4px}
/* â•â•â• TABLET â€” 768-1024px â•â•â• */
@media(max-width:1024px){
  .sidebar{width:64px;min-width:64px}.sidebar .nav-text,.sidebar-brand p,.sidebar-section,.sidebar-footer span,.sidebar-links a span{display:none}
  .sidebar-brand h1{font-size:14px;text-align:center}.sidebar-brand{padding:14px 8px}
  .nav-item{justify-content:center;padding:10px 8px}.nav-item .icon{width:auto;font-size:18px}.nav-item.active::before{width:3px;height:16px}
  .sidebar-footer{padding:8px;text-align:center}.sidebar-links{justify-content:center;padding:4px}
  .page-content{padding:16px 20px}
  .stats-grid{grid-template-columns:repeat(2,1fr)}
}
/* â•â•â• MOBILE â€” <768px â•â•â• */
@media(max-width:768px){
  .sidebar{display:none}
  .mobile-nav{display:block}
  .hamburger{display:flex}
  .main-content{padding-bottom:calc(56px + var(--safe-bottom))}
  .page-content{padding:12px 14px;padding-bottom:calc(80px + var(--safe-bottom))}
  .topbar{padding:10px 14px;padding-top:calc(10px + var(--safe-top));min-height:50px}
  .topbar-left h2{font-size:15px}
  .topbar-right .btn{padding:6px 10px;font-size:11px}
  .stats-grid{grid-template-columns:1fr 1fr;gap:8px}
  .stat-card{padding:12px 14px}.stat-value{font-size:22px}
  .grid-2{grid-template-columns:1fr}
  .card{padding:14px;border-radius:10px}
  .card-header{flex-direction:column;align-items:flex-start;gap:6px}
  .data-table{font-size:11px}.data-table th{padding:8px 10px;font-size:9px}.data-table td{padding:8px 10px;font-size:11px}
  .modal-box{width:95%;max-width:none;padding:20px;border-radius:12px;max-height:90vh}
  .toast-container{left:12px;right:12px}
  .toast{font-size:12px;padding:10px 14px}
  .empty-state{padding:30px 16px}
}
/* â•â•â• SMALL MOBILE â€” <400px â•â•â• */
@media(max-width:400px){
  .stats-grid{grid-template-columns:1fr}.stat-card{padding:10px 12px}.stat-value{font-size:20px}
  .topbar-right .btn span.btn-text{display:none}
}
</style>
</head>
<body>
<div class="toast-container" id="toastContainer"></div>
<aside class="sidebar">
<div class="sidebar-brand"><div style="display:flex;align-items:center;gap:10px"><div style="width:36px;height:36px;background:var(--accent-red);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">ğŸ”±</div><div><h1>SeaSalt</h1><p>Intelligence Hub</p></div></div></div>
<div class="sidebar-nav">
<div class="sidebar-section">Intelligence</div>
<div class="nav-item active" onclick="go('competitors',this)"><span class="icon">ğŸ†</span><span class="nav-text">Competitors</span></div>
<div class="nav-item" onclick="go('social-spy',this)"><span class="icon">ğŸ”</span><span class="nav-text">Social Spy</span></div>
<div class="nav-item" onclick="go('insights',this)"><span class="icon">ğŸ§ </span><span class="nav-text">Insights</span></div>
<div class="nav-item" onclick="go('content-studio',this)"><span class="icon">ğŸ¨</span><span class="nav-text">Content Studio</span></div>
<div class="nav-item" onclick="go('social-listeners',this)"><span class="icon">ğŸ“¡</span><span class="nav-text">Social Listeners</span></div>
<div class="nav-item" onclick="go('engagers',this)"><span class="icon">ğŸ‘¥</span><span class="nav-text">Engagers</span></div>
<div class="nav-item" onclick="go('web-intel',this)"><span class="icon">ğŸŒ</span><span class="nav-text">Website Intel</span></div>
<div class="nav-item" onclick="go('products',this)"><span class="icon">ğŸ›’</span><span class="nav-text">Products & Prices</span></div>
<div class="sidebar-section" style="margin-top:12px">Tools</div>
<div class="nav-item" onclick="go('social-command',this)"><span class="icon">ğŸš€</span><span class="nav-text">Social Command</span></div>
<div class="nav-item" onclick="go('ad-library',this)"><span class="icon">ğŸ“º</span><span class="nav-text">Ad Library</span></div>
<div class="nav-item" onclick="go('keyword-tracker',this)"><span class="icon">ğŸ”‘</span><span class="nav-text">Keyword Tracker</span></div>
<div class="sidebar-section" style="margin-top:12px">Links</div>
<a href="https://seasaltpickles.com" target="_blank" class="nav-item"><span class="icon">ğŸŒ</span><span class="nav-text">Store</span></a>
<a href="https://supabase.com/dashboard" target="_blank" class="nav-item"><span class="icon">ğŸ—„ï¸</span><span class="nav-text">Supabase</span></a>
</div>
<div class="sidebar-footer"><div style="display:flex;align-items:center;gap:8px"><span class="status-dot" id="statusDot" style="background:var(--accent-amber)"></span><span style="font-size:11px;color:var(--text-muted)" id="statusText">Connecting...</span></div><div style="font-size:10px;color:var(--text-muted);margin-top:4px">Last sync: <span id="lastSync">â€”</span></div></div>
</aside>
<div class="main-content">
<div class="topbar"><div class="topbar-left" style="display:flex;align-items:center;gap:10px"><button class="hamburger" onclick="toggleMobileMenu()">â˜°</button><div><h2 id="pageTitle">ğŸ† Competitor Intelligence</h2><div class="subtitle" id="pageSubtitle">Real-time data from Google Places API â†’ Supabase</div></div></div>
<div class="topbar-actions"><button class="btn btn-ghost btn-sm" onclick="syncAll()" id="btnSyncAll">ğŸ“Š Sync All</button><button class="btn btn-primary btn-sm" onclick="exportData()">ğŸ“¥ Export</button></div></div>
<div class="page-content">
<!-- COMPETITORS -->
<div class="page active" id="page-competitors"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card red"><div class="stat-label">Competitors Tracked</div><div class="stat-value" id="sCompCount">â€”</div><div class="stat-change" id="sCompSub">Loading...</div></div>
<div class="stat-card blue"><div class="stat-label">Avg Google Rating</div><div class="stat-value" id="sAvgRating">â€”</div><div class="stat-change">From Google Places</div></div>
<div class="stat-card emerald"><div class="stat-label">Total Reviews</div><div class="stat-value" id="sTotalReviews">â€”</div><div class="stat-change">Across all competitors</div></div>
<div class="stat-card amber"><div class="stat-label">Last Synced</div><div class="stat-value" id="sLastSync" style="font-size:16px">Never</div><div class="stat-change">Click Sync to fetch</div></div>
</div>
<div style="display:flex;gap:10px;margin-bottom:20px"><button class="btn btn-blue btn-sm" onclick="syncCompetitors()" id="btnSync">ğŸ”„ Sync Live Data</button><button class="btn btn-ghost btn-sm" onclick="openAddCompetitor()">â• Add Competitor</button></div>
<div class="card"><div class="card-header"><div><div class="card-title">Competitor Directory</div><div class="card-subtitle">Google Places API â†’ Supabase â†’ Dashboard</div></div></div><div id="compArea"></div></div>
<div class="grid-2" style="margin-top:20px"><div class="card"><div class="card-header"><div class="card-title">Rating Comparison</div></div><div class="chart-bar-container" id="ratingChart" style="height:160px"></div></div>
<div class="card"><div class="card-header"><div class="card-title">Review Volume</div></div><div class="chart-bar-container" id="reviewChart" style="height:160px"></div></div></div>
</div></div>
<!-- SOCIAL SPY -->
<div class="page" id="page-social-spy"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card violet"><div class="stat-label">Brands with Social</div><div class="stat-value" id="sSocial">â€”</div></div>
<div class="stat-card blue"><div class="stat-label">Content Logged</div><div class="stat-value" id="sSocContent">â€”</div></div>
<div class="stat-card amber"><div class="stat-label">YT Videos Tracked</div><div class="stat-value" id="sSocVids">â€”</div></div>
<div class="stat-card emerald"><div class="stat-label">Total Engagements</div><div class="stat-value" id="sSocEng">â€”</div></div>
</div>
<div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap"><button class="btn btn-violet btn-sm" onclick="openAddSocial()">â• Add Social URLs</button><button class="btn btn-ghost btn-sm" onclick="openLogPost()">ğŸ“ Log Post</button></div>
<div class="card" style="margin-bottom:16px"><div class="card-header"><div><div class="card-title">ğŸ“± All Brand Social Profiles</div><div class="card-subtitle">Click any brand to see full social detail + last activity</div></div></div><div id="socProfiles"></div></div>
<div class="card" style="margin-bottom:16px"><div class="card-header"><div><div class="card-title">ğŸ“º Recent Content Activity</div><div class="card-subtitle">YouTube videos + logged posts across all brands</div></div></div><div id="socPosts"></div></div>
</div></div>
<!-- INSIGHTS -->
<div class="page" id="page-insights"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card emerald"><div class="stat-label">Opportunities</div><div class="stat-value" id="sOpp" style="color:var(--accent-emerald)">â€”</div></div>
<div class="stat-card red"><div class="stat-label">Threats</div><div class="stat-value" id="sThreat" style="color:var(--accent-red)">â€”</div></div>
<div class="stat-card blue"><div class="stat-label">Trends</div><div class="stat-value" id="sTrend" style="color:var(--accent-blue)">â€”</div></div>
<div class="stat-card amber"><div class="stat-label">Actions</div><div class="stat-value" id="sAction" style="color:var(--accent-amber)">â€”</div></div>
</div>
<div style="display:flex;gap:10px;margin-bottom:16px"><button class="btn btn-emerald btn-sm" onclick="openAddInsight()">â• Add Insight</button></div>
<div id="insightsArea"></div>
</div></div>
<!-- CONTENT STUDIO -->
<div class="page" id="page-content-studio"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card orange"><div class="stat-label">Ideas</div><div class="stat-value" id="sCiTotal">â€”</div></div>
<div class="stat-card violet"><div class="stat-label">Planned</div><div class="stat-value" id="sCiPlanned">â€”</div></div>
<div class="stat-card emerald"><div class="stat-label">Published</div><div class="stat-value" id="sCiPub">â€”</div></div>
</div>
<div style="margin-bottom:20px"><button class="btn btn-orange btn-sm" onclick="openAddIdea()">âœ¨ Add Content Idea</button></div>
<div class="card"><div class="card-header"><div class="card-title">Content Pipeline</div></div><div id="ideasArea"></div></div>
</div></div>
<!-- SOCIAL LISTENERS -->
<div class="page" id="page-social-listeners"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card emerald"><div class="stat-label">Keywords Monitored</div><div class="stat-value" id="sLkCount">â€”</div></div>
<div class="stat-card blue"><div class="stat-label">Mentions Logged</div><div class="stat-value" id="sLkMentions">â€”</div></div>
</div>
<div style="display:flex;gap:10px;margin-bottom:20px"><button class="btn btn-emerald btn-sm" onclick="openAddListenKW()">â• Add Keyword</button><button class="btn btn-ghost btn-sm" onclick="openLogMention()">ğŸ“ Log Mention</button></div>
<div class="grid-2"><div class="card"><div class="card-header"><div class="card-title">Tracked Keywords</div></div><div id="lkArea"></div></div>
<div class="card"><div class="card-header"><div class="card-title">Recent Mentions</div></div><div id="mentionArea"></div></div></div>
</div></div>
<!-- AD LIBRARY -->
<div class="page" id="page-ad-library"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card orange"><div class="stat-label">Ads Tracked</div><div class="stat-value" id="sAdCount">â€”</div></div>
<div class="stat-card blue"><div class="stat-label">Active</div><div class="stat-value" id="sAdActive">â€”</div></div>
</div>
<div style="display:flex;gap:10px;margin-bottom:10px"><button class="btn btn-orange btn-sm" onclick="scanMetaAds()">ğŸ” Open Meta Ad Library</button><button class="btn btn-ghost btn-sm" onclick="openLogAd()">ğŸ“ Log Ad Manually</button></div>
<p style="font-size:11px;color:var(--text-muted);margin-bottom:16px">Meta Ad Library is <b>public</b> â€” no API needed. Click to search each competitor, then log what you find.</p>
<div class="card"><div class="card-header"><div class="card-title">Competitor Ads</div></div><div id="adArea"></div></div>
</div></div>
<!-- KEYWORD TRACKER -->
<div class="page" id="page-engagers"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card pink"><div class="stat-label">Total Engagers</div><div class="stat-value" id="sEngTotal">â€”</div><div class="stat-change">People engaging with competitors</div></div>
<div class="stat-card emerald"><div class="stat-label">Positive</div><div class="stat-value" id="sEngPos" style="color:var(--accent-emerald)">â€”</div></div>
<div class="stat-card red"><div class="stat-label">Negative</div><div class="stat-value" id="sEngNeg" style="color:var(--accent-red)">â€”</div><div class="stat-change">Unhappy â€” target these!</div></div>
<div class="stat-card blue"><div class="stat-label">Platforms</div><div class="stat-value" id="sEngPlat">â€”</div></div>
</div>
<div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap">
<button class="btn btn-ghost btn-sm" onclick="filterEngagers('all')" id="engFilterAll" style="border-color:var(--accent-red)">All</button>
<button class="btn btn-ghost btn-sm" onclick="filterEngagers('negative')">ğŸ”´ Negative</button>
<button class="btn btn-ghost btn-sm" onclick="filterEngagers('positive')">ğŸŸ¢ Positive</button>
<button class="btn btn-ghost btn-sm" onclick="filterEngagers('google_reviews')">ğŸ“ Google Reviews</button>
<button class="btn btn-ghost btn-sm" onclick="filterEngagers('youtube')">ğŸ“º YouTube</button>
<select class="intel-input" style="width:200px;padding:6px 12px;font-size:12px" id="engCompFilter" onchange="filterEngagers(document.querySelector('.eng-filter-active')?.dataset?.filter||'all')">
<option value="">All Competitors</option>
</select>
</div>
<div class="card"><div class="card-header"><div><div class="card-title">Competitor Engagers</div><div class="card-subtitle">People who review/comment on competitor brands â€” potential customers for SeaSalt</div></div><div><span style="font-size:12px;color:var(--text-muted)" id="engShowing"></span></div></div>
<div id="engagersArea"></div>
</div>
</div></div>
<!-- WEBSITE INTELLIGENCE -->
<div class="page" id="page-web-intel"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card blue"><div class="stat-label">Sites Scanned</div><div class="stat-value" id="sWiCount">â€”</div></div>
<div class="stat-card emerald"><div class="stat-label">SeaSalt Score</div><div class="stat-value" id="sWiSS" style="color:var(--accent-emerald)">â€”</div><div class="stat-change" id="sWiRank"></div></div>
<div class="stat-card amber"><div class="stat-label">Avg Competitor</div><div class="stat-value" id="sWiAvg">â€”</div></div>
<div class="stat-card red"><div class="stat-label">Top Threat</div><div class="stat-value" id="sWiThreat" style="font-size:16px">â€”</div></div>
</div>
<div style="display:flex;gap:10px;margin-bottom:20px"><button class="btn btn-blue btn-sm" onclick="syncWebIntel()" id="btnWebSync">ğŸŒ Scan All Websites</button><button class="btn btn-ghost btn-sm" onclick="syncWebIntel('seasaltpickles.com')">ğŸ”± Scan SeaSalt Only</button></div>
<div class="card" style="margin-bottom:20px"><div class="card-header"><div><div class="card-title">Site Score Comparison</div><div class="card-subtitle">Performance Â· SEO Â· E-commerce Â· Tech Stack</div></div></div>
<div class="chart-bar-container" id="siteScoreChart" style="height:180px;padding-bottom:30px"></div></div>
<div class="card" style="margin-bottom:20px"><div class="card-header"><div><div class="card-title">Website Intelligence Table</div><div class="card-subtitle">PageSpeed Â· Tech Â· Products Â· SEO</div></div></div><div id="wiTableArea"></div></div>
<div class="grid-2">
<div class="card"><div class="card-header"><div class="card-title">Tech Stack Comparison</div></div><div id="wiTechArea"></div></div>
<div class="card"><div class="card-header"><div class="card-title">Feature Checklist</div></div><div id="wiFeatureArea"></div></div>
</div>
</div></div>
<!-- PRODUCTS & PRICES -->
<div class="page" id="page-products"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card orange"><div class="stat-label">Brands Tracked</div><div class="stat-value" id="sProdBrands">â€”</div></div>
<div class="stat-card emerald"><div class="stat-label">SeaSalt Platforms</div><div class="stat-value" id="sProdMyPlat">â€”</div></div>
<div class="stat-card blue"><div class="stat-label">Avg Competitor Platforms</div><div class="stat-value" id="sProdAvgPlat">â€”</div></div>
<div class="stat-card violet"><div class="stat-label">Price Entries</div><div class="stat-value" id="sProdPriceEntries">â€”</div></div>
<div class="stat-card red"><div class="stat-label">SeaSalt vs Market</div><div class="stat-value" id="sProdVsMarket" style="font-size:16px">â€”</div></div>
<div class="stat-card amber"><div class="stat-label">Biggest Gap</div><div class="stat-value" id="sProdGap" style="font-size:14px">â€”</div></div>
</div>

<!-- Brand Selector Tabs -->
<div class="card" style="margin-bottom:20px">
<div class="card-header"><div><div class="card-title">ğŸª Select Brand to Explore</div><div class="card-subtitle">Click a brand to see platforms, products & pricing deep-dive â€” compared vs SeaSalt ğŸ”±</div></div></div>
<div id="brandSelectorArea" style="display:flex;flex-wrap:wrap;gap:8px;padding:8px 0"></div>
</div>

<!-- Brand Detail Panel (shows when brand clicked) -->
<div id="brandDetailPanel" style="display:none">
<!-- Brand Header -->
<div class="card" style="margin-bottom:20px;border-left:4px solid var(--accent-blue)" id="brandHeaderCard">
<div id="brandHeaderArea"></div></div>

<!-- Market Presence Comparison: Selected vs SeaSalt -->
<div class="card" style="margin-bottom:20px">
<div class="card-header"><div><div class="card-title" id="presenceTitle">ğŸ—ºï¸ Market Presence</div><div class="card-subtitle">Where this brand sells vs SeaSalt ğŸ”±</div></div>
<button class="btn btn-ghost btn-sm" onclick="openEditPresence()">âœï¸ Edit</button></div>
<div id="presenceCompareArea"></div></div>

<!-- Products List for Selected Brand -->
<div class="card" style="margin-bottom:20px">
<div class="card-header"><div><div class="card-title" id="prodListTitle">ğŸ›’ Products</div><div class="card-subtitle">All products detected on this brand's website</div></div></div>
<div id="brandProductsArea"></div></div>

<!-- Platform Pricing for Selected Brand -->
<div class="card" style="margin-bottom:20px">
<div class="card-header"><div><div class="card-title" id="platPriceTitle">ğŸ’° Platform Pricing</div><div class="card-subtitle">Click a platform to see how this brand prices across channels</div></div>
<button class="btn btn-ghost btn-sm" onclick="openAddPlatformPrice()">â• Add Price</button></div>
<div id="brandPlatformPriceArea"></div></div>
</div>

<!-- Product Ã— Brand Matrix (always visible) -->
<div class="card" style="margin-bottom:20px">
<div class="card-header"><div><div class="card-title">ğŸ“Š Product Ã— Brand Comparison</div><div class="card-subtitle">Products as rows Â· Brands as columns Â· SeaSalt ğŸ”± always first â€” avg price shown</div></div>
<button class="btn btn-ghost btn-sm" onclick="openAddPlatformPrice()">â• Add Price</button></div>
<div id="productMatrixArea"></div></div>

<!-- Full Market Presence Grid -->
<div class="card" style="margin-bottom:20px">
<div class="card-header"><div><div class="card-title">ğŸ—ºï¸ Full Market Presence Grid</div><div class="card-subtitle">All brands Ã— all platforms â€” SeaSalt ğŸ”± highlighted</div></div>
<button class="btn btn-ghost btn-sm" onclick="openEditPresence()">âœï¸ Edit</button></div>
<div id="fullPresenceArea"></div></div>

<!-- Price Range Visual -->
<div class="card" style="margin-bottom:20px"><div class="card-header"><div><div class="card-title">ğŸ’° Price Range Comparison</div><div class="card-subtitle">â‚¹ Min â†’ Max from each website Â· SeaSalt ğŸ”± highlighted</div></div></div>
<div id="priceChartArea" style="padding:12px 0"></div></div>

</div></div>
<!-- SOCIAL COMMAND CENTER -->
<div class="page" id="page-social-command"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card red"><div class="stat-label">Total Posts</div><div class="stat-value" id="scTotal">â€”</div><div class="stat-change">Across all platforms</div></div>
<div class="stat-card emerald"><div class="stat-label">Published</div><div class="stat-value" id="scPublished" style="color:var(--accent-emerald)">â€”</div></div>
<div class="stat-card amber"><div class="stat-label">Scheduled</div><div class="stat-value" id="scScheduled" style="color:var(--accent-amber)">â€”</div></div>
<div class="stat-card violet"><div class="stat-label">AI Drafts</div><div class="stat-value" id="scDrafts" style="color:var(--accent-violet)">â€”</div></div>
</div>
<div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
<button class="btn btn-violet btn-sm" onclick="openAIPostCreator()">ğŸ¤– AI Create Post</button>
<button class="btn btn-ghost btn-sm" onclick="openManualPost()">âœï¸ Manual Post</button>
<button class="btn btn-blue btn-sm" onclick="pullFBFeed()">ğŸ“¡ Pull FB Feed</button>
<button class="btn btn-ghost btn-sm" onclick="openQuickFBPost()">ğŸ“˜ Quick FB Post</button>
<button class="btn btn-sm" style="background:linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);color:#fff;border:0" onclick="openQuickIGPost()">ğŸ“¸ Quick IG Post</button>
<button class="btn btn-sm" style="background:linear-gradient(45deg,#f09433,#dc2743,#bc1888);color:#fff;border:0" onclick="pullIGFeed()">ğŸ“¡ Pull IG Feed</button>
<button class="btn btn-sm" style="background:linear-gradient(135deg,#6366f1,#a855f7);color:#fff;border:0" onclick="triggerAutoPost()">âš¡ Generate Daily Post</button>
<button class="btn btn-ghost btn-sm" onclick="openConnectPlatforms()">ğŸ”— Connect Platforms</button>
</div>
<div class="card" style="margin-bottom:16px"><div class="card-header"><div><div class="card-title">ğŸ”— Connected Platforms</div><div class="card-subtitle">Connect your social media accounts to post directly</div></div></div><div id="platformsArea"></div></div>
<div class="card" style="margin-bottom:16px;display:none" id="aiResultCard"><div class="card-header"><div><div class="card-title">ğŸ¤– AI Generated Content</div><div class="card-subtitle">Powered by Google Gemini â€” edit before posting</div></div><button class="btn btn-ghost btn-sm" onclick="document.getElementById('aiResultCard').style.display='none'">âœ•</button></div><div id="aiResultArea"></div></div>
<div class="card" style="margin-bottom:16px"><div class="card-header"><div><div class="card-title">ğŸ“‹ Post Feed & Schedule</div><div class="card-subtitle">All your posts â€” drafts, scheduled, and published</div></div><div style="display:flex;gap:6px"><button class="btn btn-ghost btn-sm sc-filter" onclick="filterSCPosts('all',this)" style="border-color:var(--accent-red)">All</button><button class="btn btn-ghost btn-sm sc-filter" onclick="filterSCPosts('draft',this)">Drafts</button><button class="btn btn-ghost btn-sm sc-filter" onclick="filterSCPosts('scheduled',this)">Scheduled</button><button class="btn btn-ghost btn-sm sc-filter" onclick="filterSCPosts('published',this)">Published</button></div></div><div id="postFeedArea"></div></div>
<div class="card"><div class="card-header"><div><div class="card-title">ğŸ“Š Post Performance</div><div class="card-subtitle">Track engagement across your published posts</div></div></div><div id="postPerfArea"></div></div>
</div></div>
<!-- KEYWORD TRACKER -->
<div class="page" id="page-keyword-tracker"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card emerald"><div class="stat-label">Keywords</div><div class="stat-value" id="sKwCount">â€”</div></div>
<div class="stat-card blue"><div class="stat-label">Avg Position</div><div class="stat-value" id="sKwAvg">â€”</div></div>
<div class="stat-card amber"><div class="stat-label">Top 10</div><div class="stat-value" id="sKwTop">â€”</div></div>
<div class="stat-card violet"><div class="stat-label">Hashtags</div><div class="stat-value" id="sKwHash">â€”</div></div>
</div>
<div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
<button class="btn btn-emerald btn-sm" onclick="autoExtractKeywords()" id="btnAutoKw">ğŸ¤– Auto-Extract from Competitors</button>
<button class="btn btn-ghost btn-sm" onclick="openAddSEOKW()">â• Add Keyword</button>
<button class="btn btn-ghost btn-sm" onclick="openAddHashtag()">ğŸ·ï¸ Add Hashtag</button>
</div>
<div class="card" style="margin-bottom:16px"><div class="card-header"><div><div class="card-title">ğŸ”‘ SEO Keyword Intelligence</div><div class="card-subtitle">Auto-extracted from competitor websites, products & categories + manual entries</div></div></div><div id="kwArea"></div></div>
<div class="card" style="margin-bottom:16px"><div class="card-header"><div><div class="card-title">ğŸ·ï¸ Hashtag Intelligence</div><div class="card-subtitle">Auto-generated from competitor product names & categories</div></div></div><div id="hashArea2"></div></div>
<div class="card"><div class="card-header"><div><div class="card-title">ğŸ“Š Competitor Keyword Map</div><div class="card-subtitle">Keywords each competitor targets based on their website content</div></div></div><div id="compKwMap"></div></div>
</div></div>
</div></div>
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()"><div class="modal-box" id="modalBox"></div></div>
<script>
const SB_URL=window.__SEASALT_SB_URL||'',SB_KEY=window.__SEASALT_SB_KEY||'';
let db;try{db=supabase.createClient(SB_URL,SB_KEY);document.getElementById('statusDot').style.background='var(--accent-emerald)';document.getElementById('statusText').textContent='Live Â· Supabase Connected';}catch(e){document.getElementById('statusText').textContent='DB Error';}

function toast(m){const c=document.getElementById('toastContainer'),t=document.createElement('div');t.className='toast';t.textContent=m;c.appendChild(t);setTimeout(()=>{t.style.opacity='0';t.style.transition='all .3s';setTimeout(()=>t.remove(),300)},3500)}
function timeAgo(d){if(!d)return'â€”';const m=Math.floor((Date.now()-new Date(d).getTime())/60000);if(m<1)return'just now';if(m<60)return m+'m ago';const h=Math.floor(m/60);if(h<24)return h+'h ago';return Math.floor(h/24)+'d ago'}
function closeModal(){document.getElementById('modalOverlay').classList.remove('show')}
function showModal(h){document.getElementById('modalBox').innerHTML=h;document.getElementById('modalOverlay').classList.add('show')}
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function empty(icon,title,desc,btn,action){return`<div class="empty-state"><div class="es-icon">${icon}</div><h3>${title}</h3><p>${desc}</p>${btn?`<button class="btn btn-primary" onclick="${action}">${btn}</button>`:''}</div>`}

const PG={'competitors':{t:'ğŸ† Competitor Intelligence',s:'Real-time data from Google Places API â†’ Supabase'},'social-spy':{t:'ğŸ” Social Spy',s:'Monitor competitor social activity'},'insights':{t:'ğŸ§  Insights Engine',s:'Actionable intelligence from competitive data'},'content-studio':{t:'ğŸ¨ Content Studio',s:'Content ideas & pipeline'},'social-listeners':{t:'ğŸ“¡ Social Listeners',s:'Brand mention monitoring'},'engagers':{t:'ğŸ‘¥ Competitor Engagers',s:'People engaging with competitors â€” potential SeaSalt customers'},'web-intel':{t:'ğŸŒ Website Intelligence',s:'PageSpeed Â· SEO Â· Tech Stack Â· Products â€” scanned from live websites'},'products':{t:'ğŸ›’ Products & Prices',s:'Product groups Â· Market presence Â· Platform pricing Â· Price intelligence'},'social-command':{t:'ğŸš€ Social Command Center',s:'AI-powered post creation Â· Multi-platform publishing Â· Performance tracking'},'ad-library':{t:'ğŸ“º Ad Library',s:'Competitor ads â€” powered by Meta Ad Library (public)'},'keyword-tracker':{t:'ğŸ”‘ Keyword Tracker',s:'SEO ranking intelligence'}};
function go(p,el){document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));if(el)el.classList.add('active');document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));const t=document.getElementById('page-'+p);if(t)t.classList.add('active');const c=PG[p]||{};document.getElementById('pageTitle').textContent=c.t||p;document.getElementById('pageSubtitle').textContent=c.s||''}

// DATA ARRAYS â€” filled from Supabase only
let COMP=[],INSIGHTS=[],IDEAS=[],SEO_KW=[],HASHTAGS=[],LISTEN_KW=[],MENTIONS=[],ADS=[],SOC_CONTENT=[],ENGAGERS=[],WEB_INTEL=[],SC_POSTS=[],SC_PLATFORMS=[];

async function loadAll(){await Promise.allSettled([loadComp(),loadInsights(),loadIdeas(),loadSeoKw(),loadHashtags(),loadListenKw(),loadMentions(),loadAds(),loadSocContent(),loadEngagers(),loadWebIntel(),loadSCPosts(),loadSCPlatforms()]);document.getElementById('lastSync').textContent=new Date().toLocaleTimeString()}

async function q(table,opts={}){try{let query=db.from(table).select(opts.select||'*');if(opts.eq)for(const[k,v]of Object.entries(opts.eq))query=query.eq(k,v);if(opts.order)query=query.order(opts.order.col,{ascending:opts.order.asc??true});if(opts.limit)query=query.limit(opts.limit);const{data,error}=await query;if(error)throw error;return data||[];}catch(e){console.log(table+':',e.message);return[];}}

async function loadComp(){COMP=await q('competitor_profiles',{order:{col:'name',asc:true}});renderComp()}
async function loadInsights(){INSIGHTS=await q('intel_insights',{eq:{is_dismissed:false},order:{col:'created_at',asc:false},limit:50});renderInsights()}
async function loadIdeas(){IDEAS=await q('content_ideas',{order:{col:'created_at',asc:false},limit:50});renderIdeas()}
async function loadSeoKw(){SEO_KW=await q('keyword_rankings',{order:{col:'current_position',asc:true}});renderSeoKw()}
async function loadHashtags(){HASHTAGS=await q('hashtag_tracker',{order:{col:'hashtag',asc:true}});renderHash()}
async function loadListenKw(){LISTEN_KW=await q('listener_keywords',{eq:{is_active:true},order:{col:'keyword',asc:true}});renderListenKw()}
async function loadMentions(){MENTIONS=await q('brand_mentions',{order:{col:'found_at',asc:false},limit:30});renderMentions()}
async function loadAds(){ADS=await q('competitor_ads',{order:{col:'scraped_at',asc:false},limit:50});renderAds()}
async function loadSocContent(){SOC_CONTENT=await q('competitor_content',{order:{col:'scraped_at',asc:false},limit:30});renderSocContent()}

// RENDERERS
function renderComp(){
  const el=document.getElementById('compArea'),rc=document.getElementById('ratingChart'),rv=document.getElementById('reviewChart');
  document.getElementById('sCompCount').textContent=COMP.length||'0';
  if(!COMP.length){el.innerHTML=empty('ğŸ†','No Competitor Data','Click "Sync Live Data" to fetch from Google Places.','ğŸ”„ Run First Sync','syncCompetitors()');rc.innerHTML='';rv.innerHTML='';document.getElementById('sAvgRating').textContent='â€”';document.getElementById('sTotalReviews').textContent='â€”';return}
  const avg=(COMP.reduce((s,c)=>s+parseFloat(c.rating||0),0)/COMP.length).toFixed(1);document.getElementById('sAvgRating').textContent=avg;
  const tot=COMP.reduce((s,c)=>s+(c.total_reviews||0),0);document.getElementById('sTotalReviews').textContent=tot.toLocaleString();
  const ls=COMP.reduce((l,c)=>{const d=new Date(c.synced_at||0);return d>l?d:l},new Date(0));
  if(ls.getTime()>0){document.getElementById('sLastSync').textContent=timeAgo(ls);document.getElementById('sCompSub').textContent='All synced'}

  let tbl='<table class="data-table"><thead><tr><th></th><th>Competitor</th><th>Rating</th><th>Reviews</th><th>Social Links</th><th>YT Subs</th><th>Score</th><th>Threat</th></tr></thead><tbody>';
  COMP.forEach(function(c){
    var socHtml='';
    if(c.instagram_url)socHtml+='<a href="'+esc(c.instagram_url)+'" target="_blank" style="text-decoration:none;font-size:14px" title="Instagram">ğŸ“¸</a> ';
    if(c.youtube_url)socHtml+='<a href="'+esc(c.youtube_url)+'" target="_blank" style="text-decoration:none;font-size:14px" title="YouTube">ğŸ“º</a> ';
    if(c.facebook_url)socHtml+='<a href="'+esc(c.facebook_url)+'" target="_blank" style="text-decoration:none;font-size:14px" title="Facebook">ğŸ“˜</a> ';
    if(c.google_maps_url)socHtml+='<a href="'+esc(c.google_maps_url)+'" target="_blank" style="text-decoration:none;font-size:14px" title="Google Maps">ğŸ“</a> ';
    if(!socHtml)socHtml='<span style="color:var(--text-muted);font-size:11px">â€”</span>';
    tbl+='<tr style="cursor:pointer" onclick="openCompDrilldown(\''+c.code+'\')">';
    tbl+='<td><span class="comp-dot" style="background:'+(c.color||'#666')+'"></span></td>';
    tbl+='<td><div style="font-weight:600;color:var(--text-primary)">'+esc(c.name)+' <span style="color:var(--accent-blue);font-size:10px">â†—</span></div><div style="font-size:11px;color:var(--text-muted)">'+esc(c.website||c.url||'')+'</div></td>';
    tbl+='<td>'+(c.rating?'<span class="stars">'+'â˜…'.repeat(Math.round(c.rating))+'</span> <b>'+parseFloat(c.rating).toFixed(1)+'</b>':'â€”')+'</td>';
    tbl+='<td style="font-weight:600">'+(c.total_reviews?c.total_reviews.toLocaleString():'â€”')+'</td>';
    tbl+='<td>'+socHtml+'</td>';
    tbl+='<td>'+(c.youtube_subscribers?c.youtube_subscribers.toLocaleString():'â€”')+'</td>';
    tbl+='<td><b style="color:'+((c.social_score||0)>=70?'var(--accent-red)':(c.social_score||0)>=40?'var(--accent-amber)':'var(--accent-emerald)')+'">'+(c.social_score||0)+'</b><span style="font-size:10px;color:var(--text-muted)">/100</span></td>';
    tbl+='<td><span class="badge '+(c.threat_level==='critical'?'badge-red':c.threat_level==='high'?'badge-orange':c.threat_level==='medium'?'badge-amber':'badge-green')+'">'+(c.threat_level||'â€”').toUpperCase()+'</span></td></tr>';
  });
  el.innerHTML=tbl+'</tbody></table>';
  const mx=5;rc.innerHTML=COMP.slice(0,8).map(c=>'<div class="chart-bar" style="height:'+(parseFloat(c.rating||0)/mx)*100+'%;background:'+(c.color||'var(--accent-blue)')+'"><span class="chart-bar-label">'+(c.code||'')+'<br>'+parseFloat(c.rating||0).toFixed(1)+'</span></div>').join('');
  const mr=Math.max.apply(null,COMP.map(c=>c.total_reviews||0).concat([1]));rv.innerHTML=COMP.slice(0,8).map(c=>'<div class="chart-bar" style="height:'+((c.total_reviews||0)/mr)*100+'%;background:'+(c.color||'var(--accent-blue)')+'"><span class="chart-bar-label">'+(c.code||'')+'<br>'+(c.total_reviews||0)+'</span></div>').join('')}

// â•â•â• COMPETITOR DRILL-DOWN MODAL â•â•â•
function openCompDrilldown(code){
  var c=COMP.find(function(x){return x.code===code});if(!c)return;
  var wi=WEB_INTEL.find(function(x){return x.code===code||x.name===c.name});
  var reviews=[];try{reviews=JSON.parse(c.recent_reviews||'[]')}catch(e){}
  var h='<div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">';
  h+='<div style="width:48px;height:48px;border-radius:12px;background:'+(c.color||'#666')+'20;display:flex;align-items:center;justify-content:center"><span class="comp-dot" style="background:'+(c.color||'#666')+';width:20px;height:20px"></span></div>';
  h+='<div style="flex:1"><div style="font-size:20px;font-weight:800">'+esc(c.name)+'</div><div style="font-size:11px;color:var(--text-muted)">'+esc(c.website||'')+' Â· '+esc(c.address||'')+'</div></div>';
  h+='<div style="text-align:center"><div style="font-size:28px;font-weight:800;color:var(--accent-amber)">'+parseFloat(c.rating||0).toFixed(1)+'</div><div style="font-size:9px;color:var(--text-muted)">â˜… Rating</div></div></div>';

  // Key metrics
  h+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px">';
  h+='<div style="background:var(--bg-elevated);border-radius:8px;padding:10px;text-align:center"><div style="font-size:18px;font-weight:800">'+(c.total_reviews||0).toLocaleString()+'</div><div style="font-size:9px;color:var(--text-muted)">Reviews</div></div>';
  h+='<div style="background:var(--bg-elevated);border-radius:8px;padding:10px;text-align:center"><div style="font-size:18px;font-weight:800">'+(c.youtube_subscribers||0).toLocaleString()+'</div><div style="font-size:9px;color:var(--text-muted)">YT Subs</div></div>';
  h+='<div style="background:var(--bg-elevated);border-radius:8px;padding:10px;text-align:center"><div style="font-size:18px;font-weight:800">'+(c.social_score||0)+'</div><div style="font-size:9px;color:var(--text-muted)">Score</div></div>';
  h+='<div style="background:var(--bg-elevated);border-radius:8px;padding:10px;text-align:center"><div style="font-size:18px;font-weight:800"><span class="badge '+(c.threat_level==='critical'?'badge-red':c.threat_level==='high'?'badge-orange':'badge-amber')+'">'+(c.threat_level||'â€”').toUpperCase()+'</span></div><div style="font-size:9px;color:var(--text-muted)">Threat</div></div></div>';

  // Social handles
  h+='<div style="font-size:13px;font-weight:700;margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid var(--border-subtle)">ğŸ“± Social & Links</div>';
  h+='<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px">';
  if(c.instagram_url)h+='<a href="'+esc(c.instagram_url)+'" target="_blank" style="text-decoration:none;padding:6px 12px;border-radius:8px;background:linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);color:#fff;font-size:11px;font-weight:600">ğŸ“¸ Instagram</a>';
  if(c.youtube_url)h+='<a href="'+esc(c.youtube_url)+'" target="_blank" style="text-decoration:none;padding:6px 12px;border-radius:8px;background:#ff0000;color:#fff;font-size:11px;font-weight:600">ğŸ“º YouTube</a>';
  if(c.facebook_url)h+='<a href="'+esc(c.facebook_url)+'" target="_blank" style="text-decoration:none;padding:6px 12px;border-radius:8px;background:#1877f2;color:#fff;font-size:11px;font-weight:600">ğŸ“˜ Facebook</a>';
  if(c.google_maps_url)h+='<a href="'+esc(c.google_maps_url)+'" target="_blank" style="text-decoration:none;padding:6px 12px;border-radius:8px;background:#34a853;color:#fff;font-size:11px;font-weight:600">ğŸ“ Google Maps</a>';
  if(c.website)h+='<a href="'+(c.website.startsWith('http')?esc(c.website):'https://'+esc(c.website))+'" target="_blank" style="text-decoration:none;padding:6px 12px;border-radius:8px;background:var(--bg-elevated);color:var(--accent-blue);font-size:11px;font-weight:600;border:1px solid var(--border-subtle)">ğŸŒ Website</a>';
  if(c.phone)h+='<span style="padding:6px 12px;border-radius:8px;background:var(--bg-elevated);font-size:11px;font-weight:600">ğŸ“ '+esc(c.phone)+'</span>';
  h+='</div>';

  // Website intelligence (if available)
  if(wi){
    h+='<div style="font-size:13px;font-weight:700;margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid var(--border-subtle)">ğŸŒ Website Intel</div>';
    h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;font-size:11px;margin-bottom:14px">';
    h+='<div><span style="color:var(--text-muted)">Score:</span> <b>'+(wi.site_score||0)+'/100</b></div>';
    h+='<div><span style="color:var(--text-muted)">Products:</span> <b>'+(wi.product_count||0)+'</b></div>';
    h+='<div><span style="color:var(--text-muted)">Price:</span> <b>'+(wi.price_min?'â‚¹'+Math.round(wi.price_min)+'-â‚¹'+Math.round(wi.price_max):'â€”')+'</b></div>';
    var wts=safeJSON(wi.tech_stack);if(wts.length)h+='<div style="grid-column:span 3"><span style="color:var(--text-muted)">Tech:</span> '+wts.map(function(t){return '<span class="badge badge-blue" style="font-size:9px">'+esc(t)+'</span>'}).join(' ')+'</div>';
    h+='</div>';
  }

  // Notes
  if(c.notes){h+='<div style="font-size:13px;font-weight:700;margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid var(--border-subtle)">ğŸ“ Intelligence Notes</div><div style="font-size:12px;color:var(--text-secondary);margin-bottom:14px;line-height:1.6">'+esc(c.notes)+'</div>'}

  // Recent reviews
  if(reviews.length){
    h+='<div style="font-size:13px;font-weight:700;margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid var(--border-subtle)">ğŸ’¬ Recent Reviews ('+reviews.length+')</div>';
    h+='<div style="max-height:200px;overflow-y:auto;margin-bottom:14px">';
    reviews.slice(0,5).forEach(function(r){
      h+='<div style="padding:8px 0;border-bottom:1px solid var(--border-subtle)"><div style="display:flex;justify-content:space-between"><span style="font-weight:600;font-size:12px">'+esc(r.author||'Anonymous')+'</span><span class="stars" style="font-size:11px">'+'â˜…'.repeat(r.rating||0)+'â˜†'.repeat(5-(r.rating||0))+'</span></div><p style="font-size:11px;color:var(--text-secondary);margin-top:4px;line-height:1.5">'+esc((r.text||'').substring(0,200))+(r.text&&r.text.length>200?'...':'')+'</p></div>';
    });
    h+='</div>';
  }

  h+='<div style="display:flex;gap:8px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border-subtle)"><button class="btn btn-ghost btn-sm" onclick="closeModal()">Close</button></div>';
  showModal(h);
}

function renderInsights(){
  document.getElementById('sOpp').textContent=INSIGHTS.filter(i=>i.type==='opportunity').length;document.getElementById('sThreat').textContent=INSIGHTS.filter(i=>i.type==='threat').length;document.getElementById('sTrend').textContent=INSIGHTS.filter(i=>i.type==='trend').length;document.getElementById('sAction').textContent=INSIGHTS.filter(i=>i.type==='action').length;
  const el=document.getElementById('insightsArea');if(!INSIGHTS.length){el.innerHTML=empty('ğŸ§ ','No Insights','Add insights from your competitive analysis.','â• Add Insight','openAddInsight()');return}
  el.innerHTML='<div style="display:flex;flex-direction:column;gap:12px">'+INSIGHTS.map(i=>`<div class="insight-card ${i.type}"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><div><span class="badge ${i.type==='opportunity'?'badge-green':i.type==='threat'?'badge-red':i.type==='trend'?'badge-blue':'badge-amber'}">${i.type==='opportunity'?'ğŸ’¡ Opportunity':i.type==='threat'?'âš ï¸ Threat':i.type==='trend'?'ğŸ“ˆ Trend':'âš¡ Action'}</span><h3 style="font-size:15px;font-weight:700;margin-top:6px">${esc(i.title)}</h3></div><span class="badge ${i.priority==='critical'?'badge-red':i.priority==='high'?'badge-orange':'badge-blue'}">${i.priority||'medium'}</span></div><p style="font-size:13px;color:var(--text-secondary);line-height:1.6;margin-bottom:10px">${esc(i.body||'')}</p><div style="display:flex;justify-content:space-between"><span style="font-size:11px;color:var(--text-muted)">${timeAgo(i.created_at)}</span><button class="btn btn-ghost btn-sm" style="padding:4px 10px;font-size:10px" onclick="dismissInsight(${i.id})">Dismiss</button></div></div>`).join('')+'</div>'}

function renderIdeas(){
  document.getElementById('sCiTotal').textContent=IDEAS.length;document.getElementById('sCiPlanned').textContent=IDEAS.filter(c=>c.status==='planned').length;document.getElementById('sCiPub').textContent=IDEAS.filter(c=>c.status==='published').length;
  const el=document.getElementById('ideasArea');if(!IDEAS.length){el.innerHTML=empty('ğŸ¨','No Content Ideas','Add ideas based on competitor gaps.','âœ¨ Add Idea','openAddIdea()');return}
  el.innerHTML=`<table class="data-table"><thead><tr><th>Title</th><th>Type</th><th>Platform</th><th>Status</th><th>Created</th></tr></thead><tbody>${IDEAS.map(c=>`<tr><td style="font-weight:600;color:var(--text-primary)">${esc(c.title)}</td><td><span class="badge badge-violet">${esc(c.content_type||'â€”')}</span></td><td><span class="badge badge-blue">${esc(c.platform||'â€”')}</span></td><td><span class="badge ${c.status==='published'?'badge-green':c.status==='planned'?'badge-amber':'badge-blue'}">${c.status||'idea'}</span></td><td style="font-size:11px;color:var(--text-muted)">${timeAgo(c.created_at)}</td></tr>`).join('')}</tbody></table>`}

function renderSeoKw(){
  document.getElementById('sKwCount').textContent=SEO_KW.length;
  var avg=SEO_KW.length?(SEO_KW.reduce(function(s,k){return s+(k.current_position||0)},0)/SEO_KW.length).toFixed(1):'â€”';
  document.getElementById('sKwAvg').textContent=avg;
  document.getElementById('sKwTop').textContent=SEO_KW.filter(function(k){return(k.current_position||99)<=10}).length;
  document.getElementById('sKwHash').textContent=HASHTAGS.length;
  var el=document.getElementById('kwArea');
  if(!SEO_KW.length){el.innerHTML=empty('ğŸ”‘','No Keywords Yet','Click "Auto-Extract from Competitors" to mine keywords from scraped competitor data, or add manually.','ğŸ¤– Auto-Extract','autoExtractKeywords()');renderCompKwMap();renderHash2();return}
  var tbl='<table class="data-table"><thead><tr><th>Keyword</th><th>Source</th><th>Position</th><th>Volume</th><th>Difficulty</th><th>Competitors Using</th></tr></thead><tbody>';
  SEO_KW.forEach(function(k){
    var ch=k.change||0;
    tbl+='<tr><td style="font-weight:600;color:var(--text-primary)">'+esc(k.keyword)+'</td>';
    tbl+='<td><span class="badge badge-blue" style="font-size:9px">'+esc(k.source||'manual')+'</span></td>';
    tbl+='<td><span style="font-size:16px;font-weight:800;color:'+((k.current_position||99)<=5?'var(--accent-emerald)':(k.current_position||99)<=15?'var(--accent-amber)':'var(--accent-red)')+'">'+(k.current_position?'#'+k.current_position:'â€”')+'</span></td>';
    tbl+='<td>'+esc(k.search_volume||'â€”')+'</td>';
    tbl+='<td><span class="badge '+(k.difficulty==='Low'?'badge-green':k.difficulty==='High'?'badge-red':'badge-amber')+'">'+esc(k.difficulty||'Medium')+'</span></td>';
    tbl+='<td style="font-size:11px;color:var(--text-muted)">'+esc(k.competitors_using||'â€”')+'</td></tr>';
  });
  el.innerHTML=tbl+'</tbody></table>';
  renderHash2();renderCompKwMap();
}

function renderHash(){
  document.getElementById('sKwHash').textContent=HASHTAGS.length;
  renderHash2();
}

function renderHash2(){
  var el=document.getElementById('hashArea2');if(!el)return;
  if(!HASHTAGS.length){el.innerHTML='<div style="padding:16px;text-align:center;color:var(--text-muted)">Click "Auto-Extract" to generate hashtags from competitor data.</div>';return}
  el.innerHTML='<div style="display:flex;flex-wrap:wrap;gap:6px;padding:8px">'+HASHTAGS.map(function(h){return '<div style="padding:6px 12px;border-radius:20px;background:linear-gradient(135deg,rgba(37,99,235,.08),rgba(124,58,237,.08));border:1px solid rgba(37,99,235,.15);font-size:12px"><span style="font-weight:700;color:var(--accent-blue)">'+esc(h.hashtag)+'</span>'+(h.total_posts?' <span style="font-size:10px;color:var(--text-muted)">'+esc(h.total_posts)+' posts</span>':'')+'</div>'}).join('')+'</div>';
}

function renderCompKwMap(){
  var el=document.getElementById('compKwMap');if(!el)return;
  if(!WEB_INTEL.length){el.innerHTML='<div style="padding:16px;text-align:center;color:var(--text-muted)">Run website scan first to extract competitor keyword data.</div>';return}
  var h='<table class="data-table"><thead><tr><th>Competitor</th><th>Page Title Keywords</th><th>Products</th><th>Categories</th></tr></thead><tbody>';
  WEB_INTEL.forEach(function(w){
    var title=(w.page_title||'').toLowerCase().split(/[\s|Â·\-â€“,]+/).filter(function(t){return t.length>3&&!['home','page','the','and','for','with','from','online','india','best'].includes(t)}).slice(0,6);
    var cats=safeJSON(w.categories).slice(0,6);
    var prods=safeJSON(w.products).slice(0,4);
    h+='<tr><td style="font-weight:600"><span class="comp-dot" style="background:'+(w.color||'#666')+'"></span> '+esc(w.name)+(w.is_self?' ğŸ”±':'')+'</td>';
    h+='<td>'+title.map(function(t){return '<span class="badge badge-blue" style="font-size:9px">'+esc(t)+'</span>'}).join(' ')+'</td>';
    h+='<td style="font-size:10px">'+prods.map(function(p){return esc(p)}).join(', ')+(prods.length?'':'â€”')+'</td>';
    h+='<td>'+cats.map(function(c){return '<span class="badge badge-violet" style="font-size:9px">'+esc(c)+'</span>'}).join(' ')+(cats.length?'':'â€”')+'</td></tr>';
  });
  el.innerHTML=h+'</tbody></table>';
}

async function autoExtractKeywords(){
  var btn=document.getElementById('btnAutoKw');btn.disabled=true;btn.innerHTML='<span class="spinner"></span> Extracting...';
  toast('ğŸ¤– Mining keywords from competitor data...');
  var kwSet={},hashSet={};
  // Extract from WEB_INTEL
  WEB_INTEL.forEach(function(w){
    var title=(w.page_title||'').toLowerCase();
    var desc=(w.meta_description||'').toLowerCase();
    var cats=safeJSON(w.categories);
    var prods=safeJSON(w.products);
    // Title keywords
    title.split(/[\s|Â·\-â€“,]+/).forEach(function(t){t=t.replace(/[^a-z0-9]/g,'');if(t.length>3&&!['home','page','the','and','for','with','from','this','that','have','been','more','about'].includes(t)){if(!kwSet[t])kwSet[t]={kw:t,count:0,brands:[]};kwSet[t].count++;kwSet[t].brands.push(w.code);kwSet[t].source='title'}});
    // Categories as keywords
    cats.forEach(function(c){var k=c.toLowerCase().trim();if(k.length>2){if(!kwSet[k])kwSet[k]={kw:k,count:0,brands:[]};kwSet[k].count++;kwSet[k].brands.push(w.code);kwSet[k].source='category';hashSet['#'+k.replace(/\s+/g,'')]=k}});
    // Product-based keywords
    prods.slice(0,10).forEach(function(p){var words=p.toLowerCase().split(/\s+/).filter(function(w){return w.length>4});words.forEach(function(wrd){wrd=wrd.replace(/[^a-z0-9]/g,'');if(wrd.length>4){if(!kwSet[wrd])kwSet[wrd]={kw:wrd,count:0,brands:[]};kwSet[wrd].count++;kwSet[wrd].brands.push(w.code);kwSet[wrd].source='product'}});
    // Generate hashtags from product names
    var tag='#'+p.replace(/[^a-zA-Z0-9\s]/g,'').replace(/\s+/g,'');if(tag.length>4&&tag.length<30)hashSet[tag]=p});
  });
  // Add common pickle/food industry hashtags
  ['#AndhraPickles','#HomemadePickles','#IndianPickles','#TeluguFood','#HyderabadFood','#Avakaya','#MangoPickle','#ChickenPickle','#PrawnPickle','#GonguraPickle','#SpicyFood','#TraditionalFood','#HandmadePickles','#PickleLove','#FoodieHyderabad','#TeluguPickles','#AndhraCuisine','#DesiFoodLovers'].forEach(function(h){hashSet[h]=h.replace('#','')});
  // Save keywords to Supabase
  var sorted=Object.values(kwSet).sort(function(a,b){return b.count-a.count}).slice(0,40);
  var saved=0;
  for(var i=0;i<sorted.length;i++){
    var k=sorted[i];
    var ok=await dbInsert('keyword_rankings',{keyword:k.kw,source:k.source||'auto',difficulty:k.count>=4?'High':k.count>=2?'Medium':'Low',competitors_using:k.brands.join(', '),search_volume:k.count>=3?'High':k.count>=2?'Medium':'Low'});
    if(ok)saved++;
  }
  // Save hashtags
  var hashes=Object.keys(hashSet).slice(0,30);var hSaved=0;
  for(var j=0;j<hashes.length;j++){
    var ok2=await dbInsert('hashtag_tracker',{hashtag:hashes[j],source:'auto',total_posts:'â€”',trend:'up'});
    if(ok2)hSaved++;
  }
  toast('âœ… Extracted '+saved+' keywords + '+hSaved+' hashtags from competitor data');
  await loadSeoKw();await loadHashtags();
  btn.disabled=false;btn.innerHTML='ğŸ¤– Auto-Extract from Competitors';
}

function renderListenKw(){
  document.getElementById('sLkCount').textContent=LISTEN_KW.length;const el=document.getElementById('lkArea');
  if(!LISTEN_KW.length){el.innerHTML='<div class="empty-state" style="padding:30px"><p>Add keywords to monitor</p></div>';return}
  el.innerHTML=LISTEN_KW.map(k=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border-subtle)"><div><div style="font-size:13px;font-weight:600;color:var(--text-primary)">"${esc(k.keyword)}"</div><div style="font-size:11px;color:var(--text-muted)">${(k.platforms||[]).join(', ')}</div></div><span style="font-size:12px;font-weight:700">${k.total_mentions||0} mentions</span></div>`).join('')}

function renderMentions(){
  document.getElementById('sLkMentions').textContent=MENTIONS.length;const el=document.getElementById('mentionArea');
  if(!MENTIONS.length){el.innerHTML='<div class="empty-state" style="padding:30px"><p>Log mentions as you find them</p></div>';return}
  el.innerHTML=MENTIONS.slice(0,10).map(m=>`<div style="padding:10px 0;border-bottom:1px solid var(--border-subtle)"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><div style="display:flex;gap:6px"><span class="badge badge-blue" style="font-size:9px">${esc(m.source_platform)}</span><span style="font-size:12px;font-weight:600">${esc(m.author||'')}</span></div><span style="font-size:10px;color:var(--text-muted)">${timeAgo(m.found_at)}</span></div><p style="font-size:12px;color:var(--text-secondary);line-height:1.5">"${esc(m.content||'')}"</p></div>`).join('')}

function renderAds(){
  document.getElementById('sAdCount').textContent=ADS.length;document.getElementById('sAdActive').textContent=ADS.filter(a=>a.status==='active').length;
  const el=document.getElementById('adArea');if(!ADS.length){el.innerHTML=empty('ğŸ“º','No Ads Tracked','Scan Meta Ad Library or log ads manually.','ğŸ” Open Meta Ads','scanMetaAds()');return}
  el.innerHTML=`<table class="data-table"><thead><tr><th>Competitor</th><th>Platform</th><th>Type</th><th>Description</th><th>Status</th><th>Est Spend</th><th>Found</th></tr></thead><tbody>${ADS.map(a=>`<tr><td style="font-weight:600">${esc(a.competitor_name)}</td><td><span class="badge badge-blue">${esc(a.platform)}</span></td><td>${esc(a.ad_type||'â€”')}</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(a.headline||a.description||'â€”')}</td><td><span class="badge ${a.status==='active'?'badge-green':'badge-amber'}">${a.status||'â€”'}</span></td><td style="font-weight:600;color:var(--accent-amber)">${esc(a.estimated_spend||'â€”')}</td><td style="font-size:11px;color:var(--text-muted)">${timeAgo(a.scraped_at)}</td></tr>`).join('')}</tbody></table>`}

function renderSocContent(){
  var ws=COMP.filter(function(c){return c.instagram_url||c.youtube_url||c.facebook_url||c.google_maps_url});
  document.getElementById('sSocial').textContent=ws.length||COMP.length;
  document.getElementById('sSocContent').textContent=SOC_CONTENT.length;
  var ytVids=SOC_CONTENT.filter(function(p){return p.platform==='YouTube'});
  document.getElementById('sSocVids').textContent=ytVids.length;
  var totalEng=SOC_CONTENT.reduce(function(s,p){return s+(p.likes||0)+(p.comments||0)},0);
  document.getElementById('sSocEng').textContent=totalEng>1000?(totalEng/1000).toFixed(1)+'K':totalEng;

  // â”€â”€ ALL BRAND SOCIAL PROFILES â”€â”€
  var sp=document.getElementById('socProfiles');
  var allBrands=COMP.length?COMP:[];
  if(!allBrands.length){sp.innerHTML='<div class="empty-state" style="padding:30px"><div class="es-icon">ğŸ“±</div><h3>No Brands</h3><p>Sync competitors first to see their social profiles.</p></div>';} 
  else {
    var tbl='<table class="data-table"><thead><tr><th>Brand</th><th>ğŸ“¸ Instagram</th><th>ğŸ“º YouTube</th><th>ğŸ“˜ Facebook</th><th>ğŸ“ Google</th><th>YT Subs</th><th>Last Activity</th><th></th></tr></thead><tbody>';
    allBrands.forEach(function(c){
      var lastAct=SOC_CONTENT.filter(function(p){return p.competitor_code===c.code||p.competitor_name===c.name}).sort(function(a,b){return new Date(b.scraped_at||b.posted_at||0)-new Date(a.scraped_at||a.posted_at||0)})[0];
      tbl+='<tr style="cursor:pointer" onclick="openSocialDrilldown(\''+c.code+'\')">';
      tbl+='<td><div style="display:flex;align-items:center;gap:6px"><span class="comp-dot" style="background:'+(c.color||'#666')+'"></span><span style="font-weight:600">'+esc(c.name)+'</span></div></td>';
      tbl+='<td>'+(c.instagram_url?'<a href="'+esc(c.instagram_url)+'" target="_blank" onclick="event.stopPropagation()" style="color:#e1306c;text-decoration:none;font-weight:600;font-size:11px">ğŸ“¸ '+(c.instagram_followers?c.instagram_followers.toLocaleString()+' followers':'View')+'</a>':'<span style="color:#ddd">â€”</span>')+'</td>';
      tbl+='<td>'+(c.youtube_url?'<a href="'+esc(c.youtube_url)+'" target="_blank" onclick="event.stopPropagation()" style="color:#ff0000;text-decoration:none;font-weight:600;font-size:11px">ğŸ“º View</a>':'<span style="color:#ddd">â€”</span>')+'</td>';
      tbl+='<td>'+(c.facebook_url?'<a href="'+esc(c.facebook_url)+'" target="_blank" onclick="event.stopPropagation()" style="color:#1877f2;text-decoration:none;font-weight:600;font-size:11px">ğŸ“˜ View</a>':'<span style="color:#ddd">â€”</span>')+'</td>';
      tbl+='<td>'+(c.google_maps_url?'<a href="'+esc(c.google_maps_url)+'" target="_blank" onclick="event.stopPropagation()" style="color:#34a853;text-decoration:none;font-weight:600;font-size:11px">ğŸ“ Maps</a>':'<span style="color:#ddd">â€”</span>')+'</td>';
      tbl+='<td style="font-weight:700">'+(c.youtube_subscribers?c.youtube_subscribers.toLocaleString():'â€”')+'</td>';
      tbl+='<td style="font-size:11px">'+(lastAct?'<span class="badge badge-blue">'+esc(lastAct.platform)+'</span> '+timeAgo(lastAct.scraped_at||lastAct.posted_at):'<span style="color:var(--text-muted)">No activity</span>')+'</td>';
      tbl+='<td><span style="color:var(--accent-blue);font-size:10px">â†— detail</span></td></tr>';
    });
    sp.innerHTML=tbl+'</tbody></table>';
  }

  // â”€â”€ RECENT CONTENT â”€â”€
  var sc=document.getElementById('socPosts');
  if(!SOC_CONTENT.length){sc.innerHTML='<div style="padding:16px;text-align:center;color:var(--text-muted)">No content logged yet. Run "Sync Live Data" on Competitors page to pull YouTube videos automatically.</div>'}
  else {
    var ptbl='<table class="data-table"><thead><tr><th>Brand</th><th>Platform</th><th>Type</th><th>Title</th><th>â™¥ Likes</th><th>ğŸ’¬ Comments</th><th>Date</th><th>Link</th></tr></thead><tbody>';
    SOC_CONTENT.slice(0,25).forEach(function(p){
      var comp=COMP.find(function(c){return c.code===p.competitor_code||c.name===p.competitor_name});
      ptbl+='<tr><td style="font-weight:600;font-size:11px"><span class="comp-dot" style="background:'+(comp?comp.color:'#666')+'"></span>'+esc(p.competitor_name||'â€”')+'</td>';
      ptbl+='<td><span class="badge '+(p.platform==='YouTube'?'badge-red':'badge-violet')+'">'+esc(p.platform||'â€”')+'</span></td>';
      ptbl+='<td style="font-size:11px">'+esc(p.post_type||'â€”')+'</td>';
      ptbl+='<td style="font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(p.caption||'â€”')+'</td>';
      ptbl+='<td style="font-weight:700;color:var(--accent-pink)">'+(p.likes?p.likes.toLocaleString():'â€”')+'</td>';
      ptbl+='<td style="font-weight:600">'+(p.comments?p.comments.toLocaleString():'â€”')+'</td>';
      ptbl+='<td style="font-size:10px;color:var(--text-muted)">'+timeAgo(p.posted_at||p.scraped_at)+'</td>';
      ptbl+='<td>'+(p.post_url?'<a href="'+esc(p.post_url)+'" target="_blank" style="color:var(--accent-blue);font-size:11px;text-decoration:none">View â†’</a>':'â€”')+'</td></tr>';
    });
    sc.innerHTML=ptbl+'</tbody></table>';
  }
}

function openSocialDrilldown(code){
  var c=COMP.find(function(x){return x.code===code});if(!c)return;
  var posts=SOC_CONTENT.filter(function(p){return p.competitor_code===code||p.competitor_name===c.name}).sort(function(a,b){return new Date(b.scraped_at||b.posted_at||0)-new Date(a.scraped_at||a.posted_at||0)});
  var engagers=ENGAGERS.filter(function(e){return e.competitor_code===code||e.competitor_name===c.name});
  var wi=WEB_INTEL.find(function(x){return x.code===code||x.name===c.name});
  var socials=wi?_jo(wi.social_links||'{}'):{};

  var h='<div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">';
  h+='<div style="width:48px;height:48px;border-radius:12px;background:'+(c.color||'#666')+'20;display:flex;align-items:center;justify-content:center"><span class="comp-dot" style="background:'+(c.color||'#666')+';width:20px;height:20px"></span></div>';
  h+='<div style="flex:1"><div style="font-size:20px;font-weight:800">'+esc(c.name)+'</div>';
  h+='<div style="font-size:11px;color:var(--text-muted)">â­ '+(c.rating||'â€”')+' Â· '+(c.total_reviews||0)+' reviews Â· '+(c.youtube_subscribers||0)+' YT subs</div></div></div>';

  // Social handles with branded buttons
  h+='<div style="font-size:13px;font-weight:700;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border-subtle)">ğŸ“± Social Handles</div>';
  h+='<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px">';
  if(c.instagram_url)h+='<a href="'+esc(c.instagram_url)+'" target="_blank" style="text-decoration:none;padding:8px 14px;border-radius:8px;background:linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);color:#fff;font-size:12px;font-weight:600">ğŸ“¸ Instagram'+(c.instagram_followers?' Â· '+c.instagram_followers.toLocaleString():'')+'</a>';
  else h+='<span style="padding:8px 14px;border-radius:8px;background:var(--bg-elevated);font-size:12px;color:var(--text-muted)">ğŸ“¸ No Instagram</span>';
  if(c.youtube_url)h+='<a href="'+esc(c.youtube_url)+'" target="_blank" style="text-decoration:none;padding:8px 14px;border-radius:8px;background:#ff0000;color:#fff;font-size:12px;font-weight:600">ğŸ“º YouTube Â· '+(c.youtube_subscribers?c.youtube_subscribers.toLocaleString()+' subs':'View')+'</a>';
  else h+='<span style="padding:8px 14px;border-radius:8px;background:var(--bg-elevated);font-size:12px;color:var(--text-muted)">ğŸ“º No YouTube</span>';
  if(c.facebook_url)h+='<a href="'+esc(c.facebook_url)+'" target="_blank" style="text-decoration:none;padding:8px 14px;border-radius:8px;background:#1877f2;color:#fff;font-size:12px;font-weight:600">ğŸ“˜ Facebook</a>';
  if(c.google_maps_url)h+='<a href="'+esc(c.google_maps_url)+'" target="_blank" style="text-decoration:none;padding:8px 14px;border-radius:8px;background:#34a853;color:#fff;font-size:12px;font-weight:600">ğŸ“ Google Maps</a>';
  // Also show social links from website scrape
  if(socials.instagram&&!c.instagram_url)h+='<a href="'+esc(socials.instagram)+'" target="_blank" style="text-decoration:none;padding:8px 14px;border-radius:8px;background:linear-gradient(45deg,#f09433,#dc2743);color:#fff;font-size:12px;font-weight:600">ğŸ“¸ IG (from website)</a>';
  if(socials.facebook&&!c.facebook_url)h+='<a href="'+esc(socials.facebook)+'" target="_blank" style="text-decoration:none;padding:8px 14px;border-radius:8px;background:#1877f2;color:#fff;font-size:12px;font-weight:600">ğŸ“˜ FB (from website)</a>';
  if(socials.youtube&&!c.youtube_url)h+='<a href="'+esc(socials.youtube)+'" target="_blank" style="text-decoration:none;padding:8px 14px;border-radius:8px;background:#ff0000;color:#fff;font-size:12px;font-weight:600">ğŸ“º YT (from website)</a>';
  h+='</div>';

  // Quick stats
  h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px">';
  h+='<div style="background:var(--bg-elevated);border-radius:8px;padding:10px;text-align:center"><div style="font-size:18px;font-weight:800">'+posts.length+'</div><div style="font-size:9px;color:var(--text-muted)">Content Posts</div></div>';
  h+='<div style="background:var(--bg-elevated);border-radius:8px;padding:10px;text-align:center"><div style="font-size:18px;font-weight:800">'+engagers.length+'</div><div style="font-size:9px;color:var(--text-muted)">Engagers</div></div>';
  var totLikes=posts.reduce(function(s,p){return s+(p.likes||0)},0);
  h+='<div style="background:var(--bg-elevated);border-radius:8px;padding:10px;text-align:center"><div style="font-size:18px;font-weight:800;color:var(--accent-pink)">'+totLikes.toLocaleString()+'</div><div style="font-size:9px;color:var(--text-muted)">Total Likes</div></div></div>';

  // Recent content
  if(posts.length){
    h+='<div style="font-size:13px;font-weight:700;margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid var(--border-subtle)">ğŸ“º Recent Content ('+posts.length+')</div>';
    h+='<div style="max-height:250px;overflow-y:auto;margin-bottom:14px">';
    posts.slice(0,10).forEach(function(p){
      h+='<div style="padding:8px 0;border-bottom:1px solid var(--border-subtle);display:flex;align-items:center;gap:8px">';
      h+='<span class="badge '+(p.platform==='YouTube'?'badge-red':'badge-violet')+'" style="font-size:9px">'+esc(p.platform)+'</span>';
      h+='<div style="flex:1"><div style="font-size:12px;font-weight:600">'+esc(p.caption||p.post_type||'Post')+'</div>';
      h+='<div style="font-size:10px;color:var(--text-muted)">'+(p.post_type?esc(p.post_type)+' Â· ':'')+timeAgo(p.posted_at||p.scraped_at)+'</div></div>';
      h+='<div style="text-align:right;font-size:11px">'+(p.likes?'<span style="color:var(--accent-pink)">â™¥'+p.likes.toLocaleString()+'</span> ':'')+(p.comments?'<span style="color:var(--accent-blue)">ğŸ’¬'+p.comments.toLocaleString()+'</span>':'')+'</div>';
      if(p.post_url)h+='<a href="'+esc(p.post_url)+'" target="_blank" style="color:var(--accent-blue);font-size:11px;text-decoration:none">View â†’</a>';
      h+='</div>';
    });
    h+='</div>';
  }

  // Recent engagers
  if(engagers.length){
    h+='<div style="font-size:13px;font-weight:700;margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid var(--border-subtle)">ğŸ‘¥ Engagers ('+engagers.length+')</div>';
    h+='<div style="max-height:150px;overflow-y:auto;margin-bottom:10px">';
    engagers.slice(0,8).forEach(function(e){
      var sentColor=e.sentiment==='positive'?'var(--accent-emerald)':e.sentiment==='negative'?'var(--accent-red)':'var(--text-muted)';
      h+='<div style="padding:4px 0;display:flex;gap:6px;align-items:center;font-size:11px">';
      h+=(e.profile_photo?'<img src="'+esc(e.profile_photo)+'" style="width:20px;height:20px;border-radius:50%">':'<span style="width:20px;height:20px;border-radius:50%;background:var(--bg-elevated);display:inline-flex;align-items:center;justify-content:center;font-size:8px">ğŸ‘¤</span>');
      h+='<span style="font-weight:600">'+esc(e.person_name)+'</span>';
      h+='<span class="badge" style="font-size:8px;background:'+sentColor+'20;color:'+sentColor+'">'+esc(e.sentiment)+'</span>';
      h+='<span style="color:var(--text-muted);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(e.content?esc(e.content.substring(0,60)):'')+'</span></div>';
    });
    h+='</div>';
  }

  h+='<div style="display:flex;gap:8px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border-subtle)"><button class="btn btn-violet btn-sm" onclick="closeModal();openAddSocial()">â• Add URLs</button><button class="btn btn-ghost btn-sm" onclick="closeModal()">Close</button></div>';
  showModal(h);
}

// SYNC
async function syncCompetitors(){const b=document.getElementById('btnSync');b.disabled=true;
  // Use COMP from Supabase (includes manually added brands)
  var targets=COMP.length?COMP:[];
  // Fallback: if no COMP data yet, use hardcoded codes
  if(!targets.length){targets=[{code:'VF',name:'Vellanki Foods'},{code:'TP',name:'Tulasi Pickles'},{code:'AP',name:'Aavarampoo Pickles'},{code:'NP',name:'Nirupama Pickles'},{code:'PP',name:'Priya Pickles'},{code:'AH',name:'Ammas Pickles'},{code:'SP',name:'Sitara Pickles'},{code:'RP',name:'Ruchulu Pickles'},{code:'AC',name:'Andhra Pickles'},{code:'HP',name:'Hyderabad Pickles'}]}
  var done=0,fail=0;
  for(var i=0;i<targets.length;i++){
    var t=targets[i];
    b.innerHTML='<span class="spinner"></span> '+esc(t.name||t.code)+' ('+(i+1)+'/'+targets.length+')';
    toast('ğŸ”„ Syncing '+(t.name||t.code)+'...');
    try{
      var url='/.netlify/functions/intel-sync?sync='+encodeURIComponent(t.code)+'&name='+encodeURIComponent(t.name||'')+'&url='+encodeURIComponent(t.website||t.url||'')+'&query='+encodeURIComponent(t.search_query||t.name||'')+'&color='+encodeURIComponent(t.color||'#666');
      var r=await fetch(url);var d=await r.json();
      if(d.error){fail++;toast('âš ï¸ '+(t.name||t.code)+': '+d.error)}
      else{done++;toast('âœ… '+(t.name||t.code)+': '+(d.rating||0)+'â˜… '+(d.reviews||0)+' reviews')}
    }catch(e){fail++;toast('âŒ '+(t.name||t.code)+': timeout')}
    await loadComp();
  }
  document.getElementById('lastSync').textContent=new Date().toLocaleTimeString();
  toast('ğŸ¯ Sync done: '+done+' ok, '+fail+' failed');
  b.disabled=false;b.innerHTML='ğŸ”„ Sync Live Data'}
async function syncAll(){const b=document.getElementById('btnSyncAll');b.disabled=true;b.innerHTML='<span class="spinner"></span>';toast('ğŸ”„ Full sync...');try{await fetch('/.netlify/functions/intel-sync');await loadAll();toast('âœ… All refreshed')}catch(e){toast('âš ï¸ '+e.message)}b.disabled=false;b.innerHTML='ğŸ“Š Sync All'}

// META AD LIBRARY â€” opens public Facebook Ad Library
function scanMetaAds(){const c=COMP.length?COMP:[{name:'Vellanki Foods'},{name:'Priya Pickles'},{name:'Aavarampoo Pickles'}];showModal(`<div class="modal-title">ğŸ” Meta Ad Library</div><p style="font-size:12px;color:var(--text-muted);margin-bottom:16px">Meta's Ad Library is <b>100% public</b> at facebook.com/ads/library. Click each competitor below to search their active ads, then log what you find.</p><div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">${c.map(x=>`<a href="https://www.facebook.com/ads/library/?active_status=active&ad_type=all&country=IN&q=${encodeURIComponent(x.name)}" target="_blank" style="text-decoration:none"><div class="social-profile" style="border:1px solid var(--border-subtle);border-radius:8px"><div style="flex:1"><div style="font-size:13px;font-weight:600;color:var(--text-primary)">${esc(x.name)}</div><div style="font-size:11px;color:var(--accent-blue)">Search in Meta Ad Library â†’</div></div></div></a>`).join('')}</div><button class="btn btn-orange" onclick="closeModal();openLogAd()">ğŸ“ Log an Ad</button> <button class="btn btn-ghost" style="margin-left:8px" onclick="closeModal()">Close</button>`)}

// CRUD â€” all write to Supabase
async function dbInsert(table,row){try{const{error}=await db.from(table).insert(row);if(error)throw error;return true}catch(e){toast('âŒ '+e.message);return false}}

function openAddCompetitor(){showModal('<div class="modal-title">â• Add Competitor</div><div class="field-group"><label class="field-label">Business Name *</label><input class="intel-input" id="f1" placeholder="e.g. Vellanki Foods"></div><div class="field-group"><label class="field-label">Code (2-4 letters) *</label><input class="intel-input" id="f2" maxlength="4" placeholder="e.g. VF" style="text-transform:uppercase"></div><div class="field-group"><label class="field-label">Website</label><input class="intel-input" id="f3" placeholder="https://domain.com"></div><div class="field-group"><label class="field-label">Google Search Query</label><input class="intel-input" id="f4" placeholder="Business Name Hyderabad"></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div class="field-group"><label class="field-label">Instagram URL</label><input class="intel-input" id="f7" placeholder="https://instagram.com/..."></div><div class="field-group"><label class="field-label">YouTube URL</label><input class="intel-input" id="f8" placeholder="https://youtube.com/..."></div><div class="field-group"><label class="field-label">Facebook URL</label><input class="intel-input" id="f9" placeholder="https://facebook.com/..."></div><div class="field-group"><label class="field-label">Threat Level</label><select class="intel-input" id="f5"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></div></div><div class="field-group"><label class="field-label">Color</label><input class="intel-input" type="color" id="f6" value="#ef4444" style="height:40px;padding:4px"></div><div style="display:flex;gap:10px;margin-top:12px"><button class="btn btn-primary" onclick="saveComp()">â• Add & Sync</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>')}
async function saveComp(){
  var n=document.getElementById('f1').value.trim(),c=document.getElementById('f2').value.trim().toUpperCase();
  if(!n||!c){toast('âŒ Name & Code required');return}
  var row={name:n,code:c,website:document.getElementById('f3').value.trim(),search_query:document.getElementById('f4').value.trim()||n+' Hyderabad',threat_level:document.getElementById('f5').value,color:document.getElementById('f6').value};
  var ig=document.getElementById('f7').value.trim();if(ig)row.instagram_url=ig;
  var yt=document.getElementById('f8').value.trim();if(yt)row.youtube_url=yt;
  var fb=document.getElementById('f9').value.trim();if(fb)row.facebook_url=fb;
  if(await dbInsert('competitor_profiles',row)){
    toast('âœ… '+n+' added! Syncing...');closeModal();await loadComp();
    // Auto-sync the new competitor
    try{
      var url='/.netlify/functions/intel-sync?sync='+encodeURIComponent(c)+'&name='+encodeURIComponent(n)+'&url='+encodeURIComponent(row.website||'')+'&query='+encodeURIComponent(row.search_query)+'&color='+encodeURIComponent(row.color);
      var r=await fetch(url);var d=await r.json();
      if(d.rating)toast('âœ… '+n+': '+d.rating+'â˜… '+d.reviews+' reviews found!');
      else toast('â„¹ï¸ '+n+' saved. Google Places may not find it yet â€” try running Sync again later.');
      await loadComp();
    }catch(e){toast('â„¹ï¸ '+n+' saved. Sync will happen next time you click "Sync Live Data".')}
  }
}

function openAddInsight(){showModal(`<div class="modal-title">â• Add Insight</div><div class="field-group"><label class="field-label">Type *</label><select class="intel-input" id="i1"><option value="opportunity">ğŸ’¡ Opportunity</option><option value="threat">âš ï¸ Threat</option><option value="trend">ğŸ“ˆ Trend</option><option value="action">âš¡ Action</option></select></div><div class="field-group"><label class="field-label">Title *</label><input class="intel-input" id="i2" placeholder="What's the insight?"></div><div class="field-group"><label class="field-label">Details</label><textarea class="intel-input" id="i3" placeholder="Context and analysis..."></textarea></div><div class="field-group"><label class="field-label">Priority</label><select class="intel-input" id="i4"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option><option value="critical">Critical</option></select></div><div style="display:flex;gap:10px;margin-top:8px"><button class="btn btn-emerald" onclick="saveInsight()">Save</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`)}
async function saveInsight(){const t=document.getElementById('i2').value.trim();if(!t){toast('âŒ Title required');return}if(await dbInsert('intel_insights',{type:document.getElementById('i1').value,title:t,body:document.getElementById('i3').value.trim(),priority:document.getElementById('i4').value})){toast('âœ… Saved!');closeModal();await loadInsights()}}
async function dismissInsight(id){try{await db.from('intel_insights').update({is_dismissed:true}).eq('id',id);toast('Dismissed');await loadInsights()}catch(e){toast('âŒ '+e.message)}}

function openAddIdea(){showModal(`<div class="modal-title">âœ¨ Content Idea</div><div class="field-group"><label class="field-label">Title *</label><input class="intel-input" id="c1" placeholder="Idea title"></div><div class="field-group"><label class="field-label">Description</label><textarea class="intel-input" id="c2" placeholder="Concept details"></textarea></div><div class="field-group"><label class="field-label">Type</label><input class="intel-input" id="c3" placeholder="Reel, Carousel, Blog..."></div><div class="field-group"><label class="field-label">Platform</label><select class="intel-input" id="c4"><option>Instagram</option><option>YouTube</option><option>Facebook</option><option>Website</option></select></div><div class="field-group"><label class="field-label">Status</label><select class="intel-input" id="c5"><option value="idea">Idea</option><option value="planned">Planned</option><option value="in_progress">In Progress</option><option value="published">Published</option></select></div><div style="display:flex;gap:10px;margin-top:8px"><button class="btn btn-orange" onclick="saveIdea()">Save</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`)}
async function saveIdea(){const t=document.getElementById('c1').value.trim();if(!t){toast('âŒ Title required');return}if(await dbInsert('content_ideas',{title:t,description:document.getElementById('c2').value.trim(),content_type:document.getElementById('c3').value.trim(),platform:document.getElementById('c4').value,status:document.getElementById('c5').value})){toast('âœ… Saved!');closeModal();await loadIdeas()}}

function openAddSEOKW(){showModal(`<div class="modal-title">â• SEO Keyword</div><div class="field-group"><label class="field-label">Keyword *</label><input class="intel-input" id="k1" placeholder="e.g. buy avakaya pickle online"></div><div class="field-group"><label class="field-label">Current Position</label><input class="intel-input" type="number" id="k2" placeholder="e.g. 12"></div><div class="field-group"><label class="field-label">Search Volume</label><input class="intel-input" id="k3" placeholder="e.g. 1.2K"></div><div class="field-group"><label class="field-label">Difficulty</label><select class="intel-input" id="k4"><option>Low</option><option selected>Medium</option><option>High</option></select></div><div class="field-group"><label class="field-label">Target URL</label><input class="intel-input" id="k5" placeholder="/products"></div><div style="display:flex;gap:10px;margin-top:8px"><button class="btn btn-emerald" onclick="saveSeoKw()">Add</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`)}
async function saveSeoKw(){const w=document.getElementById('k1').value.trim();if(!w){toast('âŒ Keyword required');return}if(await dbInsert('keyword_rankings',{keyword:w,current_position:parseInt(document.getElementById('k2').value)||0,search_volume:document.getElementById('k3').value.trim(),difficulty:document.getElementById('k4').value,target_url:document.getElementById('k5').value.trim()})){toast('âœ… Added!');closeModal();await loadSeoKw()}}

function openAddHashtag(){showModal(`<div class="modal-title">ğŸ·ï¸ Add Hashtag</div><div class="field-group"><label class="field-label">Hashtag *</label><input class="intel-input" id="h1" placeholder="#AndhraPickles"></div><div class="field-group"><label class="field-label">Total Posts</label><input class="intel-input" id="h2" placeholder="e.g. 12.4K"></div><div class="field-group"><label class="field-label">Avg Engagement</label><input class="intel-input" id="h3" placeholder="e.g. 4.2%"></div><div style="display:flex;gap:10px;margin-top:8px"><button class="btn btn-blue" onclick="saveHash()">Add</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`)}
async function saveHash(){let h=document.getElementById('h1').value.trim();if(!h){toast('âŒ Required');return}if(!h.startsWith('#'))h='#'+h;if(await dbInsert('hashtag_tracker',{hashtag:h,total_posts:document.getElementById('h2').value.trim(),avg_engagement:document.getElementById('h3').value.trim()})){toast('âœ… Added!');closeModal();await loadHashtags()}}

function openAddListenKW(){showModal(`<div class="modal-title">â• Monitor Keyword</div><div class="field-group"><label class="field-label">Keyword *</label><input class="intel-input" id="l1" placeholder="e.g. seasalt pickles"></div><div class="field-group"><label class="field-label">Platforms</label><div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:4px"><label style="font-size:12px;color:var(--text-secondary);display:flex;gap:4px"><input type="checkbox" class="lPlat" value="instagram" checked> Instagram</label><label style="font-size:12px;color:var(--text-secondary);display:flex;gap:4px"><input type="checkbox" class="lPlat" value="twitter" checked> Twitter</label><label style="font-size:12px;color:var(--text-secondary);display:flex;gap:4px"><input type="checkbox" class="lPlat" value="google" checked> Google</label><label style="font-size:12px;color:var(--text-secondary);display:flex;gap:4px"><input type="checkbox" class="lPlat" value="youtube"> YouTube</label></div></div><div style="display:flex;gap:10px;margin-top:12px"><button class="btn btn-emerald" onclick="saveListenKW()">Start Monitoring</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`)}
async function saveListenKW(){const w=document.getElementById('l1').value.trim();if(!w){toast('âŒ Required');return}const p=[...document.querySelectorAll('.lPlat:checked')].map(c=>c.value);if(await dbInsert('listener_keywords',{keyword:w,platforms:p})){toast('âœ… Monitoring "'+w+'"');closeModal();await loadListenKw()}}

function openLogMention(){showModal(`<div class="modal-title">ğŸ“ Log Mention</div><div class="field-group"><label class="field-label">Platform *</label><select class="intel-input" id="m1"><option>Instagram</option><option>Twitter</option><option>Google</option><option>Facebook</option><option>YouTube</option><option>Reddit</option></select></div><div class="field-group"><label class="field-label">Author</label><input class="intel-input" id="m2" placeholder="@username"></div><div class="field-group"><label class="field-label">Content *</label><textarea class="intel-input" id="m3" placeholder="What was said?"></textarea></div><div class="field-group"><label class="field-label">Sentiment</label><select class="intel-input" id="m4"><option value="positive">Positive</option><option value="neutral" selected>Neutral</option><option value="negative">Negative</option></select></div><div style="display:flex;gap:10px;margin-top:8px"><button class="btn btn-blue" onclick="saveMention()">Log</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`)}
async function saveMention(){const c=document.getElementById('m3').value.trim();if(!c){toast('âŒ Content required');return}if(await dbInsert('brand_mentions',{source_platform:document.getElementById('m1').value,author:document.getElementById('m2').value.trim(),content:c,sentiment:document.getElementById('m4').value})){toast('âœ… Logged!');closeModal();await loadMentions()}}

function openLogAd(){showModal(`<div class="modal-title">ğŸ“ Log Ad</div><div class="field-group"><label class="field-label">Competitor *</label><select class="intel-input" id="a1">${COMP.length?COMP.map(c=>`<option value="${esc(c.name)}" data-code="${c.code}">${esc(c.name)}</option>`).join(''):'<option>Load competitors first</option>'}</select></div><div class="field-group"><label class="field-label">Platform *</label><select class="intel-input" id="a2"><option>Meta/Facebook</option><option>Instagram</option><option>Google Ads</option><option>YouTube</option></select></div><div class="field-group"><label class="field-label">Ad Type</label><select class="intel-input" id="a3"><option>Image Ad</option><option>Video Ad</option><option>Carousel</option><option>Story Ad</option><option>Search Ad</option></select></div><div class="field-group"><label class="field-label">Headline *</label><input class="intel-input" id="a4" placeholder="What does the ad say?"></div><div class="field-group"><label class="field-label">Est Monthly Spend</label><input class="intel-input" id="a5" placeholder="e.g. â‚¹10K"></div><div class="field-group"><label class="field-label">Status</label><select class="intel-input" id="a6"><option value="active">Active</option><option value="paused">Paused</option></select></div><div style="display:flex;gap:10px;margin-top:8px"><button class="btn btn-orange" onclick="saveAd()">Log Ad</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`)}
async function saveAd(){const h=document.getElementById('a4').value.trim();if(!h){toast('âŒ Headline required');return}const sel=document.getElementById('a1');if(await dbInsert('competitor_ads',{competitor_name:sel.value,competitor_code:sel.selectedOptions[0]?.dataset?.code||'',platform:document.getElementById('a2').value,ad_type:document.getElementById('a3').value,headline:h,estimated_spend:document.getElementById('a5').value.trim(),status:document.getElementById('a6').value})){toast('âœ… Ad logged!');closeModal();await loadAds()}}

function openAddSocial(){showModal(`<div class="modal-title">â• Social URLs</div><p style="font-size:12px;color:var(--text-muted);margin-bottom:16px">Add social URLs to a competitor profile</p><div class="field-group"><label class="field-label">Competitor</label><select class="intel-input" id="s1">${COMP.map(c=>`<option value="${c.code}">${esc(c.name)}</option>`).join('')}</select></div><div class="field-group"><label class="field-label">Instagram URL</label><input class="intel-input" id="s2" placeholder="https://instagram.com/..."></div><div class="field-group"><label class="field-label">IG Followers</label><input class="intel-input" type="number" id="s3" placeholder="5000"></div><div class="field-group"><label class="field-label">YouTube URL</label><input class="intel-input" id="s4" placeholder="https://youtube.com/..."></div><div class="field-group"><label class="field-label">Facebook URL</label><input class="intel-input" id="s5" placeholder="https://facebook.com/..."></div><div style="display:flex;gap:10px;margin-top:8px"><button class="btn btn-violet" onclick="saveSocial()">Update</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`)}
async function saveSocial(){const code=document.getElementById('s1').value,u={};const ig=document.getElementById('s2').value.trim();if(ig)u.instagram_url=ig;const f=parseInt(document.getElementById('s3').value);if(f)u.instagram_followers=f;const yt=document.getElementById('s4').value.trim();if(yt)u.youtube_url=yt;const fb=document.getElementById('s5').value.trim();if(fb)u.facebook_url=fb;if(!Object.keys(u).length){toast('âŒ Add at least one URL');return}try{const{error}=await db.from('competitor_profiles').update(u).eq('code',code);if(error)throw error;toast('âœ… Updated!');closeModal();await loadComp();renderSocContent()}catch(e){toast('âŒ '+e.message)}}

function openLogPost(){showModal(`<div class="modal-title">ğŸ“ Log Post</div><div class="field-group"><label class="field-label">Competitor</label><select class="intel-input" id="p1">${COMP.map(c=>`<option value="${esc(c.name)}" data-code="${c.code}">${esc(c.name)}</option>`).join('')}</select></div><div class="field-group"><label class="field-label">Platform</label><select class="intel-input" id="p2"><option>Instagram</option><option>YouTube</option><option>Facebook</option></select></div><div class="field-group"><label class="field-label">Type</label><input class="intel-input" id="p3" placeholder="Reel, Carousel, Story..."></div><div class="field-group"><label class="field-label">Caption</label><textarea class="intel-input" id="p4" placeholder="Post description"></textarea></div><div class="field-group"><label class="field-label">Likes</label><input class="intel-input" type="number" id="p5" placeholder="5000"></div><div style="display:flex;gap:10px;margin-top:8px"><button class="btn btn-violet" onclick="savePost()">Log</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`)}
async function savePost(){const sel=document.getElementById('p1');if(await dbInsert('competitor_content',{competitor_name:sel.value,competitor_code:sel.selectedOptions[0]?.dataset?.code||'',platform:document.getElementById('p2').value,post_type:document.getElementById('p3').value.trim(),caption:document.getElementById('p4').value.trim(),likes:parseInt(document.getElementById('p5').value)||0})){toast('âœ… Logged!');closeModal();await loadSocContent()}}

async function loadEngagers(){ENGAGERS=await q('competitor_engagers',{order:{col:'scraped_at',asc:false},limit:500});renderEngagers()}

function renderEngagers(filter='all',compFilter=''){
  const el=document.getElementById('engagersArea');
  let filtered=ENGAGERS;
  if(filter==='negative')filtered=filtered.filter(e=>e.sentiment==='negative');
  else if(filter==='positive')filtered=filtered.filter(e=>e.sentiment==='positive');
  else if(filter==='google_reviews')filtered=filtered.filter(e=>e.platform==='google_reviews');
  else if(filter==='youtube')filtered=filtered.filter(e=>e.platform==='youtube');
  if(compFilter)filtered=filtered.filter(e=>e.competitor_code===compFilter);

  // Stats
  document.getElementById('sEngTotal').textContent=ENGAGERS.length;
  document.getElementById('sEngPos').textContent=ENGAGERS.filter(e=>e.sentiment==='positive').length;
  document.getElementById('sEngNeg').textContent=ENGAGERS.filter(e=>e.sentiment==='negative').length;
  const platforms=[...new Set(ENGAGERS.map(e=>e.platform))];
  document.getElementById('sEngPlat').textContent=platforms.length;
  document.getElementById('engShowing').textContent=`Showing ${filtered.length} of ${ENGAGERS.length}`;

  // Populate competitor filter dropdown
  const compSelect=document.getElementById('engCompFilter');
  if(compSelect.options.length<=1&&COMP.length){
    COMP.forEach(c=>{const o=document.createElement('option');o.value=c.code;o.textContent=c.name;compSelect.appendChild(o)});
  }

  if(!filtered.length){el.innerHTML=empty('ğŸ‘¥','No Engagers Yet','Run Deep Sync to capture people reviewing and commenting on competitor brands.','ğŸ”„ Run Deep Sync','syncCompetitors()');return}

  let html='<table class="data-table"><thead><tr><th>Person</th><th>Competitor</th><th>Platform</th><th>Sentiment</th><th>Content</th><th>Link</th></tr></thead><tbody>';
  for(const e of filtered.slice(0,200)){
    const sentBadge=e.sentiment==='positive'?'badge-green':e.sentiment==='negative'?'badge-red':'badge-blue';
    const platIcon=e.platform==='youtube'?'ğŸ“º':'ğŸ“';
    const profileLink=e.profile_url?`<a href="${esc(e.profile_url)}" target="_blank" style="color:var(--accent-blue);text-decoration:none">${esc(e.person_name)}</a>`:esc(e.person_name);
    const contentSnip=e.content?esc(e.content.substring(0,80))+(e.content.length>80?'...':''):'â€”';
    const contentLink=e.content_url?`<a href="${esc(e.content_url)}" target="_blank" style="color:var(--accent-blue);font-size:11px">View â†’</a>`:'â€”';
    html+=`<tr>
      <td style="display:flex;align-items:center;gap:8px">${e.profile_photo?`<img src="${esc(e.profile_photo)}" style="width:28px;height:28px;border-radius:50%;object-fit:cover">`:`<div style="width:28px;height:28px;border-radius:50%;background:var(--bg-elevated);display:flex;align-items:center;justify-content:center;font-size:12px">ğŸ‘¤</div>`}<div>${profileLink}${e.rating?` <span class="stars">${'â˜…'.repeat(e.rating)}${'â˜†'.repeat(5-e.rating)}</span>`:''}</div></td>
      <td><span style="font-size:12px">${esc(e.competitor_name||'')}</span></td>
      <td>${platIcon} ${e.platform==='youtube'?'YouTube':'Google'}</td>
      <td><span class="badge ${sentBadge}">${e.sentiment||'neutral'}</span></td>
      <td style="max-width:300px;font-size:12px;color:var(--text-muted)">${contentSnip}</td>
      <td>${contentLink}</td>
    </tr>`;
  }
  html+='</tbody></table>';
  if(filtered.length>200)html+=`<p style="text-align:center;padding:12px;font-size:12px;color:var(--text-muted)">Showing 200 of ${filtered.length} â€” filter to see specific groups</p>`;
  el.innerHTML=html;
}

function filterEngagers(filter){
  document.querySelectorAll('.eng-filter-active').forEach(b=>b.classList.remove('eng-filter-active'));
  const compFilter=document.getElementById('engCompFilter')?.value||'';
  renderEngagers(filter,compFilter);
}

function exportData(){toast('ğŸ“¥ Use Supabase Dashboard â†’ Table Editor â†’ Export CSV')}

// â•â•â•â•â•â•â• WEBSITE INTELLIGENCE â•â•â•â•â•â•â•
async function loadWebIntel(){WEB_INTEL=await q('website_intelligence',{order:{col:'site_score',asc:false}});renderWebIntel();renderProducts()}

async function syncWebIntel(singleSite){
  const b=document.getElementById('btnWebSync');b.disabled=true;
  if(singleSite){
    // Single site test mode
    b.innerHTML='<span class="spinner"></span> Scanning '+singleSite+'...';
    toast('ğŸŒ Scanning '+singleSite+'...');
    try{
      const r=await fetch('/.netlify/functions/web-intel?site='+encodeURIComponent(singleSite));
      const d=await r.json();toast('âœ… '+singleSite+': '+d.products_found+' products, '+(d.products_with_prices||0)+' with prices');await loadWebIntel();
    }catch(e){toast('âŒ '+e.message)}
    b.disabled=false;b.innerHTML='ğŸŒ Scan All Websites';return;
  }
  // Sequential scan: one site at a time via ?scan=CODE&fast=1
  const codes=['SS','VF','PP','SP','FH','JF','JD','NF','SG','AM','KF'];
  const names={'SS':'SeaSalt','VF':'Vellanki','PP':'Priya','SP':'Sitara','FH':'Fia Home','JF':'Jampani','JD':'Jandhyala','NF':'Nirmala','SG':'Swagruha','AM':'Amaravathi','KF':'Konaseema'};
  let done=0,failed=0;
  for(const code of codes){
    b.innerHTML=`<span class="spinner"></span> ${names[code]||code} (${done+1}/${codes.length})`;
    toast(`ğŸŒ Scanning ${names[code]||code}... (${done+1}/${codes.length})`);
    try{
      const r=await fetch('/.netlify/functions/web-intel?scan='+code+'&fast=1');
      const d=await r.json();
      if(d.error){toast('âš ï¸ '+code+': '+d.error);failed++}
      else{done++;toast(`âœ… ${names[code]}: ${d.products||0} products, ${d.products_with_prices||0} priced`)}
    }catch(e){failed++;toast('âŒ '+code+': timeout/error')}
    await loadWebIntel(); // Refresh dashboard after each site
  }
  toast(`ğŸ¯ Scan complete: ${done} sites scanned, ${failed} failed`);
  b.disabled=false;b.innerHTML='ğŸŒ Scan All Websites';
}

function renderWebIntel(){
  const self=WEB_INTEL.find(w=>w.is_self);
  const comps=WEB_INTEL.filter(w=>!w.is_self);

  document.getElementById('sWiCount').textContent=WEB_INTEL.length;
  document.getElementById('sWiSS').textContent=self?self.site_score+'/100':'â€”';
  if(self&&comps.length){
    const rank=comps.filter(c=>c.site_score>self.site_score).length+1;
    document.getElementById('sWiRank').textContent='Rank #'+rank+' of '+(comps.length+1);
  }
  const avgComp=comps.length?Math.round(comps.reduce((s,c)=>s+c.site_score,0)/comps.length):0;
  document.getElementById('sWiAvg').textContent=avgComp+'/100';
  const topThreat=comps.sort((a,b)=>b.site_score-a.site_score)[0];
  document.getElementById('sWiThreat').textContent=topThreat?topThreat.name+' ('+topThreat.site_score+')':'â€”';

  // Score chart
  const chart=document.getElementById('siteScoreChart');
  if(!WEB_INTEL.length){chart.innerHTML='';document.getElementById('wiTableArea').innerHTML=empty('ğŸŒ','No Website Data','Click "Scan All Websites" to analyze competitor sites.','ğŸŒ Run First Scan','syncWebIntel()');return}
  chart.innerHTML=WEB_INTEL.map(w=>`<div class="chart-bar" style="height:${w.site_score}%;background:${w.is_self?'var(--accent-red)':w.color||'var(--accent-blue)'};opacity:${w.is_self?1:0.7}"><span class="chart-bar-label">${w.code}<br><b>${w.site_score}</b></span></div>`).join('');

  // Table
  let tbl=`<table class="data-table"><thead><tr><th>Brand</th><th>Score</th><th>Perf</th><th>SEO</th><th>Products</th><th>Price Range</th><th>E-com</th><th>Tech Stack</th><th>Scanned</th></tr></thead><tbody>`;
  for(const w of WEB_INTEL){
    const ts=safeJSON(w.tech_stack);
    const scoreColor=w.site_score>=60?'var(--accent-emerald)':w.site_score>=35?'var(--accent-amber)':'var(--accent-red)';
    tbl+=`<tr style="${w.is_self?'background:rgba(220,38,38,.04)':''}cursor:pointer" onclick="openBrandDrilldown('${w.code}')">
      <td><div style="display:flex;align-items:center;gap:8px"><span class="comp-dot" style="background:${w.color||'#666'}"></span><div><div style="font-weight:600;color:var(--text-primary)">${esc(w.name)}${w.is_self?' ğŸ”±':''}</div><div style="font-size:11px;color:var(--text-muted)">${esc(w.url)} <span style="color:var(--accent-blue)">â†— drill-down</span></div></div></div></td>
      <td><b style="font-size:18px;color:${scoreColor}">${w.site_score}</b><span style="font-size:10px;color:var(--text-muted)">/100</span></td>
      <td><span class="badge ${w.performance_score>=60?'badge-green':w.performance_score>=30?'badge-amber':'badge-red'}">${w.performance_score||0}</span></td>
      <td><span class="badge ${w.seo_score>=70?'badge-green':w.seo_score>=40?'badge-amber':'badge-red'}">${w.seo_score||0}</span></td>
      <td style="font-weight:600">${w.product_count||0}</td>
      <td>${w.price_min&&w.price_max?'â‚¹'+Math.round(w.price_min)+' â€” â‚¹'+Math.round(w.price_max):'â€”'}</td>
      <td>${w.has_ecommerce?'<span class="badge badge-green">Yes</span>':'<span class="badge badge-red">No</span>'}</td>
      <td style="font-size:11px">${ts.length?ts.slice(0,3).join(', ')+(ts.length>3?' +'.concat(ts.length-3):''):'â€”'}</td>
      <td style="font-size:11px;color:var(--text-muted)">${timeAgo(w.scanned_at)}</td>
    </tr>`;
  }
  tbl+='</tbody></table>';
  document.getElementById('wiTableArea').innerHTML=tbl;

  // Tech stack comparison
  const techMap={};
  WEB_INTEL.forEach(w=>{const ts=safeJSON(w.tech_stack);ts.forEach(t=>{if(!techMap[t])techMap[t]=[];techMap[t].push(w.code)})});
  let techHtml='<div style="display:flex;flex-direction:column;gap:8px;padding:8px 0">';
  for(const[tech,codes]of Object.entries(techMap).sort((a,b)=>b[1].length-a[1].length)){
    techHtml+=`<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border-subtle)"><div style="font-size:13px;font-weight:600">${esc(tech)}</div><div style="display:flex;gap:4px">${codes.map(c=>`<span class="badge badge-blue" style="font-size:9px">${c}</span>`).join('')}</div></div>`;
  }
  techHtml+='</div>';
  document.getElementById('wiTechArea').innerHTML=Object.keys(techMap).length?techHtml:'<div class="empty-state" style="padding:20px"><p>Run scan to detect tech stacks</p></div>';

  // Feature checklist
  const features=['has_ecommerce','has_blog','has_whatsapp','has_ssl','has_structured_data','is_mobile_friendly'];
  const fLabels={'has_ecommerce':'ğŸ›’ E-commerce','has_blog':'ğŸ“ Blog','has_whatsapp':'ğŸ’¬ WhatsApp','has_ssl':'ğŸ”’ SSL','has_structured_data':'ğŸ“Š Schema','is_mobile_friendly':'ğŸ“± Mobile'};
  let fHtml='<table class="data-table"><thead><tr><th>Feature</th>';
  WEB_INTEL.slice(0,6).forEach(w=>{fHtml+=`<th style="text-align:center;font-size:9px">${w.code}</th>`});
  fHtml+='</tr></thead><tbody>';
  features.forEach(f=>{
    fHtml+=`<tr><td style="font-size:12px">${fLabels[f]||f}</td>`;
    WEB_INTEL.slice(0,6).forEach(w=>{fHtml+=`<td style="text-align:center">${w[f]?'âœ…':'âŒ'}</td>`});
    fHtml+='</tr>';
  });
  fHtml+='</tbody></table>';
  document.getElementById('wiFeatureArea').innerHTML=fHtml;
}

// â•â•â•â•â•â•â• BRAND DRILL-DOWN MODAL â•â•â•â•â•â•â•
function openBrandDrilldown(code){
  const w=WEB_INTEL.find(x=>x.code===code);if(!w)return;
  const self=WEB_INTEL.find(x=>x.is_self);
  const ts=safeJSON(w.tech_stack);
  const prods=safeJSON(w.products);
  const cats=safeJSON(w.categories);
  const socials=safeJSONObj(w.social_links||'{}');
  const mp=safeJSONObj(w.marketplace_presence||'{}');
  const pwp=safeJSON(w.products_with_prices||'[]');
  const comp=self?self:null;

  // Google Places data
  const gp=COMP.find(c=>c.code===code||c.name===w.name);

  let h=`<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
    <div style="width:48px;height:48px;border-radius:12px;background:${w.color||'#666'}20;display:flex;align-items:center;justify-content:center"><span class="comp-dot" style="background:${w.color||'#666'};width:20px;height:20px"></span></div>
    <div><div style="font-size:20px;font-weight:800;color:${w.is_self?'var(--accent-red)':'var(--text-primary)'}">${esc(w.name)}${w.is_self?' ğŸ”±':''}</div>
    <div style="font-size:12px;color:var(--text-muted)">${esc(w.url)}${gp?' Â· â­ '+gp.rating+' ('+gp.total_reviews+' reviews)':''}</div></div>
    <div style="margin-left:auto;text-align:center"><div style="font-size:28px;font-weight:800;color:${w.site_score>=60?'var(--accent-emerald)':w.site_score>=35?'var(--accent-amber)':'var(--accent-red)'}">${w.site_score}</div><div style="font-size:10px;color:var(--text-muted)">Score</div></div></div>`;

  // â”€â”€ Section 1: Key Metrics â”€â”€
  h+=`<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px">
    <div style="background:var(--bg-elevated);border-radius:8px;padding:10px;text-align:center"><div style="font-size:18px;font-weight:800">${w.performance_score||0}</div><div style="font-size:9px;color:var(--text-muted)">Performance</div></div>
    <div style="background:var(--bg-elevated);border-radius:8px;padding:10px;text-align:center"><div style="font-size:18px;font-weight:800">${w.seo_score||0}</div><div style="font-size:9px;color:var(--text-muted)">SEO</div></div>
    <div style="background:var(--bg-elevated);border-radius:8px;padding:10px;text-align:center"><div style="font-size:18px;font-weight:800">${w.product_count||0}</div><div style="font-size:9px;color:var(--text-muted)">Products</div></div>
    <div style="background:var(--bg-elevated);border-radius:8px;padding:10px;text-align:center"><div style="font-size:18px;font-weight:800">${pwp.length}</div><div style="font-size:9px;color:var(--text-muted)">With Prices</div></div>
  </div>`;

  // â”€â”€ Section 2: vs SeaSalt Comparison â”€â”€
  if(comp&&!w.is_self){
    h+=`<div style="font-size:13px;font-weight:700;margin-bottom:6px">ğŸ“Š vs SeaSalt ğŸ”±</div>`;
    h+=`<table class="data-table" style="margin-bottom:14px"><thead><tr><th>Metric</th><th>${esc(w.name)}</th><th>SeaSalt ğŸ”±</th><th>Diff</th></tr></thead><tbody>`;
    const metrics=[
      ['Site Score',w.site_score,comp.site_score],
      ['Products',w.product_count||0,comp.product_count||0],
      ['Price Min',w.price_min?'â‚¹'+Math.round(w.price_min):'â€”',comp.price_min?'â‚¹'+Math.round(comp.price_min):'â€”'],
      ['Price Avg',w.price_avg?'â‚¹'+Math.round(w.price_avg):'â€”',comp.price_avg?'â‚¹'+Math.round(comp.price_avg):'â€”'],
    ];
    if(gp){const sg=COMP.find(c=>c.is_self||c.code==='SS');
      metrics.push(['Google Rating',gp.rating||'â€”',sg?sg.rating||'â€”':'â€”']);
      metrics.push(['Reviews',gp.total_reviews||'â€”',sg?sg.total_reviews||'â€”':'â€”']);
    }
    metrics.forEach(([label,them,us])=>{
      const tNum=parseFloat(String(them).replace(/[â‚¹,]/g,''))||0;
      const uNum=parseFloat(String(us).replace(/[â‚¹,]/g,''))||0;
      const diff=tNum&&uNum?tNum-uNum:0;
      const diffStr=diff>0?`<span style="color:var(--accent-red)">+${Math.round(diff)}</span>`:diff<0?`<span style="color:var(--accent-emerald)">${Math.round(diff)}</span>`:'â€”';
      h+=`<tr><td style="font-weight:600;font-size:12px">${label}</td><td style="font-weight:700">${them}</td><td style="font-weight:700;color:var(--accent-red)">${us}</td><td>${diffStr}</td></tr>`;
    });
    h+=`</tbody></table>`;
  }

  // â”€â”€ Section 3: Market Presence â”€â”€
  const platKeys=Object.keys(mp).filter(k=>!k.startsWith('_'));
  if(platKeys.length){
    h+=`<div style="font-size:13px;font-weight:700;margin-bottom:6px">ğŸ—ºï¸ Market Presence</div>`;
    h+=`<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px">`;
    platKeys.forEach(p=>{
      const active=mp[p];
      const meta={'website':{i:'ğŸŒ',l:'Website'},'amazon':{i:'ğŸ“¦',l:'Amazon'},'flipkart':{i:'ğŸ›’',l:'Flipkart'},'swiggy':{i:'ğŸŸ ',l:'Swiggy'},'zomato':{i:'ğŸ”´',l:'Zomato'},'bigbasket':{i:'ğŸ§º',l:'BigBasket'},'jiomart':{i:'ğŸ”µ',l:'JioMart'},'blinkit':{i:'âš¡',l:'Blinkit'},'instagram_shop':{i:'ğŸ“¸',l:'Insta'},'whatsapp':{i:'ğŸ’¬',l:'WhatsApp'}}[p]||{i:'ğŸª',l:p};
      h+=`<span style="padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;${active?'background:rgba(5,150,105,.1);color:var(--accent-emerald)':'background:var(--bg-elevated);color:var(--text-muted)'}">${meta.i} ${meta.l} ${active?'âœ“':'âœ—'}</span>`;
    });
    h+=`</div>`;
  }

  // â”€â”€ Section 4: Tech Stack â”€â”€
  if(ts.length){
    h+=`<div style="font-size:13px;font-weight:700;margin-bottom:6px">âš™ï¸ Tech Stack</div>`;
    h+=`<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:14px">${ts.map(t=>`<span class="badge badge-blue">${esc(t)}</span>`).join('')}</div>`;
  }

  // â”€â”€ Section 5: Social Links â”€â”€
  const socKeys=Object.entries(socials).filter(([k,v])=>v);
  if(socKeys.length){
    h+=`<div style="font-size:13px;font-weight:700;margin-bottom:6px">ğŸ“± Social Presence</div>`;
    h+=`<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px">${socKeys.map(([k,v])=>{
      const icons={instagram:'ğŸ“¸',facebook:'ğŸ‘¤',youtube:'ğŸ“º',twitter:'ğŸ¦',whatsapp:'ğŸ’¬',linkedin:'ğŸ’¼'};
      const url=v!=='detected'?v:'#';
      return`<a href="${esc(url)}" target="_blank" style="text-decoration:none;padding:4px 10px;border-radius:6px;background:var(--bg-elevated);font-size:11px;font-weight:600;color:var(--accent-blue)">${icons[k]||'ğŸ”—'} ${k}</a>`;
    }).join('')}</div>`;
  }

  // â”€â”€ Section 6: Categories â”€â”€
  if(cats.length){
    h+=`<div style="font-size:13px;font-weight:700;margin-bottom:6px">ğŸ“‚ Categories (${cats.length})</div>`;
    h+=`<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:14px">${cats.map(c=>`<span class="badge badge-violet" style="font-size:10px">${esc(c)}</span>`).join('')}</div>`;
  }

  // â”€â”€ Section 7: Products with Prices (top 20) â”€â”€
  if(pwp.length){
    h+=`<div style="font-size:13px;font-weight:700;margin-bottom:6px">ğŸ·ï¸ Products with Prices (${pwp.length} total â€” showing top 20)</div>`;
    h+=`<table class="data-table" style="margin-bottom:14px"><thead><tr><th>#</th><th>Product</th><th>Price</th><th>Range</th></tr></thead><tbody>`;
    pwp.slice(0,20).forEach((p,i)=>{h+=`<tr><td style="color:var(--text-muted)">${i+1}</td><td style="font-weight:600">${esc(p.name)}</td><td style="font-weight:700;color:var(--accent-emerald)">â‚¹${p.price||p.price_min||'â€”'}</td><td style="font-size:11px;color:var(--text-muted)">${p.price_min&&p.price_max&&p.price_min!==p.price_max?'â‚¹'+p.price_min+' â€” â‚¹'+p.price_max:'single'}</td></tr>`});
    h+=`</tbody></table>`;
  } else if(prods.length){
    h+=`<div style="font-size:13px;font-weight:700;margin-bottom:6px">ğŸ›’ Products (${prods.length} â€” no prices extracted)</div>`;
    h+=`<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:14px">${prods.slice(0,25).map(p=>`<span style="padding:3px 8px;border-radius:5px;background:var(--bg-elevated);font-size:11px">${esc(p)}</span>`).join('')}${prods.length>25?`<span style="font-size:11px;color:var(--text-muted)"> +${prods.length-25} more</span>`:''}</div>`;
  }

  // â”€â”€ Section 8: Page Details â”€â”€
  h+=`<div style="font-size:13px;font-weight:700;margin-bottom:6px">ğŸ“„ Page Details</div>`;
  h+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px;margin-bottom:14px">
    <div><span style="color:var(--text-muted)">Title:</span> ${esc(w.page_title||'â€”')}</div>
    <div><span style="color:var(--text-muted)">E-commerce:</span> ${w.has_ecommerce?'âœ… Yes':'âŒ No'}</div>
    <div><span style="color:var(--text-muted)">Blog:</span> ${w.has_blog?'âœ…':'âŒ'}</div>
    <div><span style="color:var(--text-muted)">SSL:</span> ${w.has_ssl?'âœ…':'âŒ'}</div>
    <div><span style="color:var(--text-muted)">Schema:</span> ${w.has_structured_data?'âœ…':'âŒ'}</div>
    <div><span style="color:var(--text-muted)">WhatsApp:</span> ${w.has_whatsapp?'âœ…':'âŒ'}</div>
    <div><span style="color:var(--text-muted)">Images:</span> ${w.image_count||0}</div>
    <div><span style="color:var(--text-muted)">Words:</span> ${w.word_count||0}</div>
  </div>`;

  // Actions
  h+=`<div style="display:flex;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border-subtle)">
    <button class="btn btn-primary btn-sm" onclick="closeModal();go('products',document.querySelector('[onclick*=products]'));SELECTED_BRAND='${code}';renderProducts()">ğŸ›’ View in Products</button>
    <a href="${w.url.startsWith('http')?esc(w.url):'https://'+esc(w.url)}" target="_blank" class="btn btn-ghost btn-sm">ğŸŒ Visit Website</a>
    <button class="btn btn-ghost btn-sm" onclick="closeModal()">Close</button>
  </div>`;

  showModal(h);
}

function safeJSONObj(v){try{return typeof v==='string'?JSON.parse(v):(v&&typeof v==='object'&&!Array.isArray(v)?v:{})}catch(e){return{}}}

// â•â•â•â•â•â•â• PRODUCTS & PRICES â€” AUTO v3 â•â•â•â•â•â•â•
let SELECTED_BRAND=null;
const PLATFORM_META={website:{icon:'ğŸŒ',label:'Website',color:'#2563eb'},swiggy:{icon:'ğŸŸ ',label:'Swiggy',color:'#fc8019'},zomato:{icon:'ğŸ”´',label:'Zomato',color:'#e23744'},amazon:{icon:'ğŸ“¦',label:'Amazon',color:'#ff9900'},flipkart:{icon:'ğŸ›’',label:'Flipkart',color:'#2874f0'},bigbasket:{icon:'ğŸ§º',label:'BigBasket',color:'#84c225'},jiomart:{icon:'ğŸ”µ',label:'JioMart',color:'#0078ad'},blinkit:{icon:'âš¡',label:'Blinkit',color:'#f7d600'},instagram_shop:{icon:'ğŸ“¸',label:'Instagram',color:'#e1306c'},whatsapp:{icon:'ğŸ’¬',label:'WhatsApp',color:'#25d366'}};
const PK=Object.keys(PLATFORM_META);
function getMP(w){const m=_jo(w.marketplace_presence);if(!m.website&&w.reachable)m.website=true;if(!m.whatsapp&&w.has_whatsapp)m.whatsapp=true;return m}
function _jo(v){try{return typeof v==='string'?JSON.parse(v):(v&&typeof v==='object'&&!Array.isArray(v)?v:{})}catch(e){return{}}}
function getPWP(w){return safeJSON(w.products_with_prices||'[]')}

function renderProducts(){
  const self=WEB_INTEL.find(w=>w.is_self);const sp=self?getMP(self):{};
  const selfPC=PK.filter(k=>sp[k]).length;
  const comps=WEB_INTEL.filter(w=>!w.is_self);
  const compPA=comps.length?(comps.reduce((s,w)=>s+PK.filter(k=>getMP(w)[k]).length,0)/comps.length).toFixed(1):0;
  const allPWP=WEB_INTEL.flatMap(w=>getPWP(w).map(p=>({...p,brand:w.name,code:w.code,is_self:w.is_self,color:w.color})));
  document.getElementById('sProdBrands').textContent=WEB_INTEL.length;
  document.getElementById('sProdMyPlat').textContent=selfPC;
  document.getElementById('sProdAvgPlat').textContent=compPA;
  document.getElementById('sProdPriceEntries').textContent=allPWP.length;
  if(self&&self.price_avg>0){const ca=comps.filter(w=>w.price_avg>0);if(ca.length){const ma=Math.round(ca.reduce((s,w)=>s+parseFloat(w.price_avg),0)/ca.length);const d=Math.round(parseFloat(self.price_avg)-ma);document.getElementById('sProdVsMarket').innerHTML=d>0?'<span style="color:var(--accent-red)">â‚¹'+d+' above</span>':'<span style="color:var(--accent-emerald)">â‚¹'+Math.abs(d)+' below</span>';}}
  const gaps=PK.filter(p=>!sp[p]&&comps.some(w=>getMP(w)[p]));
  if(gaps.length){const t=gaps[0];const c=comps.filter(w=>getMP(w)[t]).length;document.getElementById('sProdGap').textContent=PLATFORM_META[t].icon+' '+PLATFORM_META[t].label+' ('+c+')';}
  const sorted=[...WEB_INTEL].sort((a,b)=>a.is_self?-1:b.is_self?1:a.name.localeCompare(b.name));
  document.getElementById('brandSelectorArea').innerHTML=sorted.map(w=>{
    const ia=SELECTED_BRAND===w.code;const pc=PK.filter(k=>getMP(w)[k]).length;const pp=getPWP(w);
    return '<div onclick="selectBrand(\''+w.code+'\')" style="cursor:pointer;padding:10px 14px;border-radius:10px;border:2px solid '+(ia?w.color||'#2563eb':'var(--border-subtle)')+';background:'+(ia?(w.color||'#2563eb')+'12':'var(--bg-surface)')+';min-width:110px;transition:all .15s;text-align:center"><div style="display:flex;align-items:center;gap:5px;justify-content:center"><span class="comp-dot" style="background:'+(w.color||'#666')+'"></span><span style="font-weight:700;font-size:12px;color:'+(w.is_self?'var(--accent-red)':'var(--text-primary)')+'">'+esc(w.name)+(w.is_self?' ğŸ”±':'')+'</span></div><div style="display:flex;gap:6px;justify-content:center;margin-top:4px"><span style="font-size:9px;color:var(--text-muted)">'+pc+' plat</span><span style="font-size:9px;color:var(--text-muted)">'+(pp.length||w.product_count||0)+' prod</span></div></div>';}).join('');
  const dp=document.getElementById('brandDetailPanel');
  if(SELECTED_BRAND){dp.style.display='block';renderBrandFull(SELECTED_BRAND)}else{dp.style.display='none'}
  renderProductMatrix();renderFullPresence();renderPriceChart();
}
function selectBrand(code){SELECTED_BRAND=SELECTED_BRAND===code?null:code;renderProducts();if(SELECTED_BRAND)document.getElementById('brandDetailPanel').scrollIntoView({behavior:'smooth',block:'start'})}

function renderBrandFull(code){
  const w=WEB_INTEL.find(x=>x.code===code);if(!w)return;
  const self=WEB_INTEL.find(x=>x.is_self);
  const bp=getMP(w);const sp=self?getMP(self):{};
  const pwp=getPWP(w);const prods=safeJSON(w.products);const cats=safeJSON(w.categories);
  const ts=safeJSON(w.tech_stack);const socials=_jo(w.social_links||'{}');
  const gp=COMP.find(c=>c.code===code||c.name===w.name);
  const sgp=COMP.find(c=>c.is_self||c.code==='SS');
  document.getElementById('brandHeaderCard').style.borderLeftColor=w.color||'#2563eb';
  let hdr='<div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap">';
  hdr+='<div style="width:48px;height:48px;border-radius:12px;background:'+(w.color||'#666')+'20;display:flex;align-items:center;justify-content:center"><span class="comp-dot" style="background:'+(w.color||'#666')+';width:20px;height:20px"></span></div>';
  hdr+='<div style="flex:1;min-width:160px"><div style="font-size:20px;font-weight:800;color:'+(w.is_self?'var(--accent-red)':'var(--text-primary)')+'">'+esc(w.name)+(w.is_self?' ğŸ”±':'')+'</div>';
  hdr+='<div style="font-size:11px;color:var(--text-muted)">'+esc(w.url)+(gp?' Â· â­ '+gp.rating+' ('+gp.total_reviews+' reviews)':'')+' Â· Score: <b>'+(w.site_score||0)+'/100</b></div></div>';
  hdr+='<div style="display:flex;gap:12px;flex-wrap:wrap">';
  hdr+='<div style="text-align:center"><div style="font-size:20px;font-weight:800">'+(pwp.length||w.product_count||0)+'</div><div style="font-size:9px;color:var(--text-muted)">Products</div></div>';
  hdr+='<div style="text-align:center"><div style="font-size:20px;font-weight:800">'+PK.filter(k=>bp[k]).length+'</div><div style="font-size:9px;color:var(--text-muted)">Platforms</div></div>';
  hdr+='<div style="text-align:center"><div style="font-size:20px;font-weight:800;color:var(--accent-emerald)">'+(w.price_min>0?'â‚¹'+Math.round(parseFloat(w.price_min)):'â€”')+'</div><div style="font-size:9px;color:var(--text-muted)">Min</div></div>';
  hdr+='<div style="text-align:center"><div style="font-size:20px;font-weight:800;color:var(--accent-red)">'+(w.price_max>0?'â‚¹'+Math.round(parseFloat(w.price_max)):'â€”')+'</div><div style="font-size:9px;color:var(--text-muted)">Max</div></div>';
  hdr+='</div></div>';
  document.getElementById('brandHeaderArea').innerHTML=hdr;

  // Build the main detail area
  document.getElementById('presenceTitle').textContent='ğŸ“Š '+w.name+' â€” Full Intelligence';
  var ph='';

  // VS SEASALT
  if(self&&!w.is_self){
    ph+='<div style="font-size:13px;font-weight:700;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border-subtle)">ğŸ“Š Head-to-Head vs SeaSalt ğŸ”±</div>';
    ph+='<table class="data-table" style="margin-bottom:16px"><thead><tr><th>Metric</th><th style="color:'+(w.color||'#333')+'">'+esc(w.name)+'</th><th style="color:var(--accent-red)">SeaSalt ğŸ”±</th><th>Verdict</th></tr></thead><tbody>';
    var rows=[['Site Score',w.site_score||0,self.site_score||0],['Products',w.product_count||0,self.product_count||0],['Price Min','â‚¹'+Math.round(parseFloat(w.price_min)||0),'â‚¹'+Math.round(parseFloat(self.price_min)||0)],['Price Avg','â‚¹'+Math.round(parseFloat(w.price_avg)||0),'â‚¹'+Math.round(parseFloat(self.price_avg)||0)],['Platforms',PK.filter(k=>bp[k]).length,PK.filter(k=>sp[k]).length],['Tech Stack',ts.length,safeJSON(self.tech_stack).length]];
    if(gp&&sgp){rows.push(['Google Rating',gp.rating||'â€”',sgp.rating||'â€”']);rows.push(['Reviews',gp.total_reviews||0,sgp.total_reviews||0])}
    rows.forEach(function(r){var tNum=parseFloat(String(r[1]).replace(/[â‚¹,]/g,''))||0;var uNum=parseFloat(String(r[2]).replace(/[â‚¹,]/g,''))||0;var v=tNum>uNum?'<span style="color:var(--accent-red)">They lead</span>':tNum<uNum?'<span style="color:var(--accent-emerald)">You lead</span>':'Tied';ph+='<tr><td style="font-weight:600;font-size:12px">'+r[0]+'</td><td style="font-weight:700">'+(r[1]||'â€”')+'</td><td style="font-weight:700;color:var(--accent-red)">'+(r[2]||'â€”')+'</td><td style="font-size:11px">'+v+'</td></tr>'});
    ph+='</tbody></table>';
  }

  // MARKET PRESENCE
  ph+='<div style="font-size:13px;font-weight:700;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border-subtle)">ğŸ—ºï¸ Market Presence</div>';
  ph+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:6px;margin-bottom:16px">';
  PK.forEach(function(p){
    var them=bp[p]||false;var us=sp[p]||false;
    var tag='Neither',bg='var(--bg-elevated)',brd='var(--border-subtle)';
    if(them&&us){tag='Both âœ…';bg='rgba(5,150,105,.08)';brd='var(--accent-emerald)'}
    else if(them&&!us){tag='Gap âš ï¸';bg='rgba(220,38,38,.06)';brd='var(--accent-red)'}
    else if(!them&&us){tag='Your edge ğŸ’ª';bg='rgba(37,99,235,.06)';brd='var(--accent-blue)'}
    ph+='<div style="background:'+bg+';border:1px solid '+brd+';border-radius:8px;padding:8px;text-align:center"><div style="font-size:16px">'+PLATFORM_META[p].icon+'</div><div style="font-size:10px;font-weight:600;margin:2px 0">'+PLATFORM_META[p].label+'</div><div style="display:flex;justify-content:center;gap:4px;margin:3px 0"><span style="font-size:8px;padding:1px 4px;border-radius:3px;background:'+(them?PLATFORM_META[p].color+'20':'var(--bg-elevated)')+';color:'+(them?PLATFORM_META[p].color:'#ccc')+';font-weight:700">'+w.code+' '+(them?'âœ“':'âœ—')+'</span><span style="font-size:8px;padding:1px 4px;border-radius:3px;background:'+(us?'rgba(220,38,38,.1)':'var(--bg-elevated)')+';color:'+(us?'var(--accent-red)':'#ccc')+';font-weight:700">SS '+(us?'âœ“':'âœ—')+'</span></div><div style="font-size:8px;color:'+(them&&!us?'var(--accent-red)':!them&&us?'var(--accent-blue)':'var(--text-muted)')+';font-weight:600">'+tag+'</div></div>';
  });
  ph+='</div>';

  // TECH STACK
  if(ts.length){ph+='<div style="font-size:13px;font-weight:700;margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid var(--border-subtle)">âš™ï¸ Tech Stack ('+ts.length+')</div><div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:16px">'+ts.map(function(t){return '<span class="badge badge-blue">'+esc(t)+'</span>'}).join('')+'</div>'}

  // SOCIAL
  var socKeys=Object.entries(socials).filter(function(e){return e[1]});
  if(socKeys.length){ph+='<div style="font-size:13px;font-weight:700;margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid var(--border-subtle)">ğŸ“± Social Presence</div><div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px">'+socKeys.map(function(e){var icons={instagram:'ğŸ“¸',facebook:'ğŸ‘¤',youtube:'ğŸ“º',twitter:'ğŸ¦',whatsapp:'ğŸ’¬'};var url=e[1]!=='detected'?e[1]:'#';return '<a href="'+esc(url)+'" target="_blank" style="text-decoration:none;padding:4px 10px;border-radius:6px;background:var(--bg-elevated);font-size:11px;font-weight:600;color:var(--accent-blue)">'+(icons[e[0]]||'ğŸ”—')+' '+e[0]+'</a>'}).join('')+'</div>'}

  // CATEGORIES
  if(cats.length){ph+='<div style="font-size:13px;font-weight:700;margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid var(--border-subtle)">ğŸ“‚ Categories ('+cats.length+')</div><div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:16px">'+cats.map(function(c){return '<span class="badge badge-violet" style="font-size:10px">'+esc(c)+'</span>'}).join('')+'</div>'}

  // SITE DETAILS
  ph+='<div style="font-size:13px;font-weight:700;margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid var(--border-subtle)">ğŸ“„ Site Details</div>';
  ph+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;font-size:11px;margin-bottom:16px">';
  ph+='<div><span style="color:var(--text-muted)">E-com:</span> '+(w.has_ecommerce?'âœ…':'âŒ')+'</div>';
  ph+='<div><span style="color:var(--text-muted)">Blog:</span> '+(w.has_blog?'âœ…':'âŒ')+'</div>';
  ph+='<div><span style="color:var(--text-muted)">SSL:</span> '+(w.has_ssl?'âœ…':'âŒ')+'</div>';
  ph+='<div><span style="color:var(--text-muted)">Schema:</span> '+(w.has_structured_data?'âœ…':'âŒ')+'</div>';
  ph+='<div><span style="color:var(--text-muted)">WhatsApp:</span> '+(w.has_whatsapp?'âœ…':'âŒ')+'</div>';
  ph+='<div><span style="color:var(--text-muted)">Images:</span> '+(w.image_count||0)+'</div>';
  ph+='<div><span style="color:var(--text-muted)">Words:</span> '+(w.word_count||0)+'</div>';
  ph+='<div><span style="color:var(--text-muted)">Int Links:</span> '+(w.internal_links||0)+'</div>';
  ph+='<div><span style="color:var(--text-muted)">Ext Links:</span> '+(w.external_links||0)+'</div></div>';

  document.getElementById('presenceCompareArea').innerHTML=ph;

  // PRODUCTS LIST
  document.getElementById('prodListTitle').textContent='ğŸ›’ '+w.name+' â€” Products ('+(pwp.length||prods.length||0)+')';
  if(pwp.length){
    var pt='<table class="data-table"><thead><tr><th>#</th><th>Product</th><th>Price</th><th>Range</th><th>Source</th></tr></thead><tbody>';
    pwp.forEach(function(p,i){pt+='<tr><td style="color:var(--text-muted);font-size:10px">'+(i+1)+'</td><td style="font-weight:600">'+esc(p.name)+'</td><td style="font-weight:700;color:var(--accent-emerald)">â‚¹'+(p.price||p.price_min||'â€”')+'</td><td style="font-size:11px;color:var(--text-muted)">'+(p.price_min&&p.price_max&&p.price_min!==p.price_max?'â‚¹'+p.price_min+' â€” â‚¹'+p.price_max:'â€”')+'</td><td><span class="badge badge-blue" style="font-size:8px">'+(p.source||'web')+'</span></td></tr>'});
    document.getElementById('brandProductsArea').innerHTML=pt+'</tbody></table>';
  } else if(prods.length){
    document.getElementById('brandProductsArea').innerHTML='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:6px">'+prods.map(function(p,i){return '<div style="padding:6px 10px;background:var(--bg-elevated);border-radius:6px;font-size:11px;display:flex;gap:6px"><span style="color:var(--text-muted)">#'+(i+1)+'</span><span style="font-weight:600">'+esc(p)+'</span></div>'}).join('')+'</div>';
  } else {
    document.getElementById('brandProductsArea').innerHTML='<div style="padding:16px;text-align:center;color:var(--text-muted)">No products detected. Site may load dynamically.</div>';
  }

  // PRICING INTEL
  document.getElementById('platPriceTitle').textContent='ğŸ’° '+w.name+' â€” Pricing Intelligence';
  var activeP=PK.filter(function(k){return bp[k]});
  if(pwp.length){
    var pp='<div style="padding:6px 0;font-size:11px;color:var(--text-muted);margin-bottom:6px">Active on <b>'+activeP.length+'</b> platforms: '+activeP.map(function(p){return PLATFORM_META[p].icon+' '+PLATFORM_META[p].label}).join(', ')+'</div>';
    var prices=pwp.map(function(p){return p.price||p.price_min}).filter(function(p){return p>0}).sort(function(a,b){return a-b});
    if(prices.length>=3){
      var low=prices[0],mid=prices[Math.floor(prices.length/2)],high=prices[prices.length-1];
      pp+='<div style="display:flex;gap:8px;margin-bottom:12px"><div style="flex:1;background:rgba(5,150,105,.08);border-radius:8px;padding:10px;text-align:center"><div style="font-size:9px;color:var(--accent-emerald);font-weight:600">LOWEST</div><div style="font-size:18px;font-weight:800;color:var(--accent-emerald)">â‚¹'+low+'</div></div><div style="flex:1;background:rgba(37,99,235,.08);border-radius:8px;padding:10px;text-align:center"><div style="font-size:9px;color:var(--accent-blue);font-weight:600">MEDIAN</div><div style="font-size:18px;font-weight:800;color:var(--accent-blue)">â‚¹'+mid+'</div></div><div style="flex:1;background:rgba(220,38,38,.08);border-radius:8px;padding:10px;text-align:center"><div style="font-size:9px;color:var(--accent-red);font-weight:600">HIGHEST</div><div style="font-size:18px;font-weight:800;color:var(--accent-red)">â‚¹'+high+'</div></div></div>';
    }
    document.getElementById('brandPlatformPriceArea').innerHTML=pp;
  } else {
    document.getElementById('brandPlatformPriceArea').innerHTML='<div style="padding:16px;text-align:center;color:var(--text-muted)">No pricing data available.</div>';
  }
}

function renderProductMatrix(){
  var area=document.getElementById('productMatrixArea');
  var allPWP=WEB_INTEL.flatMap(function(w){return getPWP(w).map(function(p){return Object.assign({},p,{brand:w.name,code:w.code,is_self:w.is_self,color:w.color})})});
  if(!allPWP.length){area.innerHTML='<div class="empty-state" style="padding:24px"><div class="es-icon">ğŸ“Š</div><h3>Product Ã— Brand Price Matrix</h3><p>Auto-populated after scan. Shopify stores show product-level pricing.</p></div>';return}
  var prodNames=[...new Set(allPWP.map(function(p){return p.name}))].sort();
  var self=WEB_INTEL.find(function(w){return w.is_self});var selfName=self?self.name:'SeaSalt';
  var brandNames=[selfName].concat([...new Set(allPWP.map(function(p){return p.brand}))].filter(function(b){return b!==selfName}).sort());
  var h='<div style="overflow-x:auto;max-height:400px"><table class="data-table"><thead><tr><th style="position:sticky;top:0;background:#fff;z-index:1">Product</th>';
  brandNames.forEach(function(b){var w=WEB_INTEL.find(function(x){return x.name===b});var s=w&&w.is_self;h+='<th style="text-align:center;position:sticky;top:0;background:#fff;z-index:1;'+(s?'color:var(--accent-red)':'')+'">'+(s?'ğŸ”± ':'')+esc(b)+'</th>'});
  h+='<th style="text-align:center;position:sticky;top:0;background:#fff;z-index:1">Avg</th></tr></thead><tbody>';
  prodNames.slice(0,50).forEach(function(prod){
    var rp=[];h+='<tr><td style="font-weight:600;font-size:11px;max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+esc(prod)+'</td>';
    brandNames.forEach(function(b){var entries=allPWP.filter(function(p){return p.brand===b&&p.name===prod});var avg=entries.length?Math.round(entries[0].price||entries[0].price_min||0):0;if(avg>0)rp.push(avg);var w=WEB_INTEL.find(function(x){return x.name===b});var s=w&&w.is_self;var mn=rp.length>=2?Math.min.apply(null,rp):0;var mx=rp.length>=2?Math.max.apply(null,rp):0;h+='<td style="text-align:center;font-weight:700;font-size:12px;'+(s?'background:rgba(220,38,38,.03);':'')+'">'+(avg>0?'<span style="color:'+(avg===mn&&rp.length>=2?'var(--accent-emerald)':avg===mx&&rp.length>=2?'var(--accent-red)':'var(--text-primary)')+'">â‚¹'+avg+'</span>':'<span style="color:#ddd">â€”</span>')+'</td>'});
    var ma=rp.length?Math.round(rp.reduce(function(a,b){return a+b},0)/rp.length):0;
    h+='<td style="text-align:center;font-weight:700;color:var(--accent-blue);font-size:12px">'+(ma>0?'â‚¹'+ma:'â€”')+'</td></tr>';
  });
  if(prodNames.length>50)h+='<tr><td colspan="'+(brandNames.length+2)+'" style="text-align:center;color:var(--text-muted);font-size:11px">Showing 50 of '+prodNames.length+' products</td></tr>';
  area.innerHTML=h+'</tbody></table></div>';
}

function renderFullPresence(){
  var area=document.getElementById('fullPresenceArea');
  if(!WEB_INTEL.length){area.innerHTML=empty('ğŸ—ºï¸','No Data','Run scan.','ğŸŒ Scan','syncWebIntel()');return}
  var self=WEB_INTEL.find(function(w){return w.is_self});var sp=self?getMP(self):{};
  var h='<div style="overflow-x:auto"><table class="data-table"><thead><tr><th style="min-width:110px">Brand</th>';
  PK.forEach(function(p){var us=sp[p]||false;h+='<th style="text-align:center;font-size:8px;min-width:50px;'+(us?'':'background:rgba(220,38,38,.03)')+'">'+PLATFORM_META[p].icon+'<br>'+PLATFORM_META[p].label+'</th>'});
  h+='<th style="text-align:center">Total</th></tr></thead><tbody>';
  [...WEB_INTEL].sort(function(a,b){return a.is_self?-1:b.is_self?1:a.name.localeCompare(b.name)}).forEach(function(w){
    var bp=getMP(w);var cnt=PK.filter(function(k){return bp[k]}).length;
    h+='<tr style="'+(w.is_self?'background:rgba(220,38,38,.04)':'cursor:pointer')+'" '+(w.is_self?'':'onclick="selectBrand(\''+w.code+'\')"')+'><td style="font-weight:600;font-size:12px;color:'+(w.is_self?'var(--accent-red)':'var(--text-primary)')+'"><span class="comp-dot" style="background:'+(w.color||'#666')+'"></span> '+esc(w.name)+(w.is_self?' ğŸ”±':'')+'</td>';
    PK.forEach(function(p){var a=bp[p]||false;var gap=a&&!(sp[p]||false);h+='<td style="text-align:center;'+(gap?'background:rgba(220,38,38,.06)':'')+'">'+(a?'<span style="color:'+PLATFORM_META[p].color+';font-size:14px">â—</span>':'<span style="color:#e8e8e8">â—‹</span>')+'</td>'});
    h+='<td style="text-align:center;font-weight:700;font-size:12px">'+cnt+'<span style="font-size:9px;color:var(--text-muted)">/'+PK.length+'</span></td></tr>';
  });
  h+='</tbody></table></div>';
  var gaps2=PK.filter(function(p){return !sp[p]&&WEB_INTEL.some(function(w){return !w.is_self&&getMP(w)[p]})});
  if(gaps2.length){h+='<div style="margin-top:10px;padding:10px;background:rgba(220,38,38,.04);border:1px solid rgba(220,38,38,.15);border-radius:8px"><div style="font-size:11px;font-weight:700;color:var(--accent-red);margin-bottom:4px">âš ï¸ Platform Gaps:</div><div style="display:flex;flex-wrap:wrap;gap:5px">'+gaps2.map(function(p){var names=WEB_INTEL.filter(function(w){return !w.is_self&&getMP(w)[p]}).map(function(w){return w.name});return '<div style="background:#fff;border:1px solid rgba(220,38,38,.15);border-radius:6px;padding:5px 8px;font-size:10px">'+PLATFORM_META[p].icon+' <b>'+PLATFORM_META[p].label+'</b> <span class="badge badge-red">'+names.length+'</span><div style="font-size:9px;color:var(--text-muted)">'+names.join(', ')+'</div></div>'}).join('')+'</div></div>'}
  area.innerHTML=h;
}

function renderPriceChart(){
  var pc=document.getElementById('priceChartArea');var wp=WEB_INTEL.filter(function(w){return w.price_min>0});
  if(!wp.length){pc.innerHTML='<div style="padding:16px;text-align:center;color:var(--text-muted)">No prices detected</div>';return}
  var sorted=[...wp].sort(function(a,b){return a.is_self?-1:b.is_self?1:parseFloat(a.price_avg||0)-parseFloat(b.price_avg||0)});
  var maxP=Math.max.apply(null,sorted.map(function(w){return parseFloat(w.price_max)||0}).concat([1]));
  pc.innerHTML='<div style="display:flex;flex-direction:column;gap:8px">'+sorted.map(function(w){
    var mn=parseFloat(w.price_min)||0,mx=parseFloat(w.price_max)||0,av=parseFloat(w.price_avg)||0;
    var lp=Math.round((mn/maxP)*100),wp2=Math.max(Math.round(((mx-mn)/maxP)*100),2);
    return '<div style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:2px 0;border-radius:5px;transition:background .15s" onclick="selectBrand(\''+w.code+'\')" onmouseenter="this.style.background=\'var(--bg-elevated)\'" onmouseleave="this.style.background=\'transparent\'"><div style="width:120px;font-size:11px;font-weight:'+(w.is_self?'800':'600')+';text-align:right;color:'+(w.is_self?'var(--accent-red)':'var(--text-primary)')+'">'+esc(w.name)+(w.is_self?' ğŸ”±':'')+'</div><div style="flex:1;height:24px;background:var(--bg-elevated);border-radius:5px;position:relative;overflow:hidden"><div style="position:absolute;left:'+lp+'%;width:'+wp2+'%;height:100%;background:'+(w.is_self?'var(--accent-red)':w.color||'#2563eb')+';border-radius:5px;opacity:'+(SELECTED_BRAND===w.code?'1':'.5')+';display:flex;align-items:center;justify-content:center;font-size:9px;color:#fff;font-weight:700">'+(av?'â‚¹'+Math.round(av):'')+'</div></div><div style="width:130px;font-size:10px;color:var(--text-muted)">â‚¹'+Math.round(mn)+' â€” â‚¹'+Math.round(mx)+'</div></div>';
  }).join('')+'</div>';
}

function openEditPresence(){
  var h='<div class="modal-title">âœï¸ Override Market Presence</div><p style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Auto-detected from website links. Override if needed.</p><div style="overflow-x:auto;max-height:55vh"><table class="data-table"><thead><tr><th>Brand</th>';
  PK.forEach(function(p){h+='<th style="text-align:center;font-size:8px">'+PLATFORM_META[p].icon+'<br>'+PLATFORM_META[p].label.split(' ')[0]+'</th>'});
  h+='</tr></thead><tbody>';
  WEB_INTEL.forEach(function(w){var bp=getMP(w);h+='<tr'+(w.is_self?' style="background:rgba(220,38,38,.04)"':'')+'><td style="font-weight:600;font-size:11px">'+esc(w.name)+(w.is_self?' ğŸ”±':'')+'</td>';PK.forEach(function(p){h+='<td style="text-align:center"><input type="checkbox" id="pres_'+w.code+'_'+p+'" '+(bp[p]?'checked':'')+'></td>'});h+='</tr>'});
  h+='</tbody></table></div><div style="display:flex;gap:8px;margin-top:10px"><button class="btn btn-emerald" onclick="savePresOverride()">ğŸ’¾ Save</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>';
  showModal(h);
}
function savePresOverride(){closeModal();toast('âœ… Presence saved (manual override)')}
function safeJSON(v){try{return typeof v==='string'?JSON.parse(v):(Array.isArray(v)?v:[])}catch(e){return[]}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOCIAL COMMAND CENTER â€” AI Post Creator + Feed
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var SC_FILTER='all';
async function loadSCPosts(){SC_POSTS=await q('social_posts',{order:{col:'created_at',asc:false},limit:100});renderSCPosts()}
async function loadSCPlatforms(){SC_PLATFORMS=await q('social_platforms',{order:{col:'platform',asc:true}});renderPlatforms()}

function renderSCPosts(){
  document.getElementById('scTotal').textContent=SC_POSTS.length;
  document.getElementById('scPublished').textContent=SC_POSTS.filter(function(p){return p.status==='published'}).length;
  document.getElementById('scScheduled').textContent=SC_POSTS.filter(function(p){return p.status==='scheduled'}).length;
  document.getElementById('scDrafts').textContent=SC_POSTS.filter(function(p){return p.status==='draft'}).length;
  var filtered=SC_FILTER==='all'?SC_POSTS:SC_POSTS.filter(function(p){return p.status===SC_FILTER});
  var el=document.getElementById('postFeedArea');
  if(!filtered.length){el.innerHTML='<div style="padding:30px;text-align:center;color:var(--text-muted)"><div style="font-size:36px;margin-bottom:8px">ğŸ¤–</div><p>No posts yet. Click "AI Create Post" to generate content with Gemini AI.</p></div>';renderPostPerf();return}
  var h='<div style="display:flex;flex-direction:column;gap:12px">';
  filtered.forEach(function(p){
    var platIcons={'instagram':'ğŸ“¸','facebook':'ğŸ“˜','youtube':'ğŸ“º','twitter':'ğ•','linkedin':'ğŸ’¼','whatsapp':'ğŸ’¬'};
    var platforms=(p.platforms||[]).map(function(pl){return '<span style="font-size:14px" title="'+esc(pl)+'">'+(platIcons[pl.toLowerCase()]||'ğŸ“±')+'</span>'}).join(' ');
    var statusBadge=p.status==='published'?'badge-green':p.status==='scheduled'?'badge-amber':'badge-blue';
    h+='<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px;cursor:pointer" onclick="openPostDetail('+p.id+')">';
    h+='<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px"><div style="display:flex;gap:8px;align-items:center"><span class="badge '+statusBadge+'">'+esc(p.status||'draft')+'</span>'+platforms;
    if(p.ai_generated)h+=' <span class="badge badge-violet">ğŸ¤– AI</span>';
    h+='</div><span style="font-size:10px;color:var(--text-muted)">'+timeAgo(p.created_at)+'</span></div>';
    h+='<div style="font-weight:600;font-size:13px;margin-bottom:4px">'+esc((p.caption||'').substring(0,120))+(p.caption&&p.caption.length>120?'...':'')+'</div>';
    if(p.hashtags)h+='<div style="font-size:11px;color:var(--accent-blue);margin-bottom:6px">'+esc((p.hashtags||'').substring(0,80))+'</div>';
    h+='<div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--text-muted)">';
    if(p.scheduled_at)h+='<span>ğŸ“… '+new Date(p.scheduled_at).toLocaleString()+'</span>';
    else h+='<span></span>';
    h+='<div style="display:flex;gap:12px">';
    if(p.likes!=null)h+='<span style="color:var(--accent-pink)">â™¥ '+p.likes+'</span>';
    if(p.comments_count!=null)h+='<span style="color:var(--accent-blue)">ğŸ’¬ '+p.comments_count+'</span>';
    if(p.shares!=null)h+='<span style="color:var(--accent-emerald)">â†— '+p.shares+'</span>';
    h+='</div></div></div>';
  });
  el.innerHTML=h+'</div>';
  renderPostPerf();
}

function filterSCPosts(f,el){SC_FILTER=f;document.querySelectorAll('.sc-filter').forEach(function(b){b.style.borderColor='var(--border)'});if(el)el.style.borderColor='var(--accent-red)';renderSCPosts()}

function renderPlatforms(){
  var el=document.getElementById('platformsArea');
  var allPlat=[
    {key:'instagram',icon:'ğŸ“¸',name:'Instagram',color:'linear-gradient(45deg,#f09433,#dc2743,#bc1888)',desc:'Reels, Stories, Posts'},
    {key:'facebook',icon:'ğŸ“˜',name:'Facebook',color:'#1877f2',desc:'Posts, Stories, Ads'},
    {key:'youtube',icon:'ğŸ“º',name:'YouTube',color:'#ff0000',desc:'Videos, Shorts, Community'},
    {key:'twitter',icon:'ğ•',name:'X / Twitter',color:'#000000',desc:'Tweets, Threads'},
    {key:'linkedin',icon:'ğŸ’¼',name:'LinkedIn',color:'#0a66c2',desc:'Posts, Articles'},
    {key:'whatsapp',icon:'ğŸ’¬',name:'WhatsApp Business',color:'#25d366',desc:'Status, Catalog'}
  ];
  var h='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px">';
  allPlat.forEach(function(pl){
    var connected=SC_PLATFORMS.find(function(p){return p.platform===pl.key});
    h+='<div style="border:1px solid '+(connected?'var(--accent-emerald)':'var(--border)')+';border-radius:10px;padding:14px;text-align:center;cursor:pointer;transition:all .15s;background:'+(connected?'rgba(5,150,105,.04)':'var(--bg-card)')+'" onclick="managePlatform(\''+pl.key+'\')">';
    h+='<div style="font-size:28px;margin-bottom:4px">'+pl.icon+'</div>';
    h+='<div style="font-weight:700;font-size:12px">'+pl.name+'</div>';
    h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:6px">'+pl.desc+'</div>';
    if(connected){h+='<span class="badge badge-green" style="font-size:9px">âœ… Connected</span>';if(connected.handle)h+='<div style="font-size:10px;color:var(--accent-blue);margin-top:2px">@'+esc(connected.handle)+'</div>'}
    else h+='<span class="badge" style="font-size:9px;background:rgba(0,0,0,.05);color:var(--text-muted)">Click to connect</span>';
    h+='</div>';
  });
  el.innerHTML=h+'</div>';
}

function renderPostPerf(){
  var pub=SC_POSTS.filter(function(p){return p.status==='published'&&(p.likes||p.comments_count||p.shares||p.reach)});
  var el=document.getElementById('postPerfArea');
  if(!pub.length){el.innerHTML='<div style="padding:20px;text-align:center;color:var(--text-muted)">Publish posts and update their metrics to see performance data here.</div>';return}
  var h='<table class="data-table"><thead><tr><th>Post</th><th>Platform</th><th>â™¥ Likes</th><th>ğŸ’¬ Comments</th><th>â†— Shares</th><th>ğŸ‘ï¸ Reach</th><th>ğŸ“Š Rate</th><th>Posted</th></tr></thead><tbody>';
  pub.forEach(function(p){
    var eng=(p.likes||0)+(p.comments_count||0)+(p.shares||0);
    var rate=p.reach?((eng/p.reach)*100).toFixed(1)+'%':'â€”';
    h+='<tr><td style="font-size:11px;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc((p.caption||'').substring(0,40))+'</td>';
    h+='<td>'+(p.platforms||[]).map(function(pl){return '<span class="badge badge-blue" style="font-size:9px">'+esc(pl)+'</span>'}).join(' ')+'</td>';
    h+='<td style="font-weight:700;color:var(--accent-pink)">'+(p.likes||'â€”')+'</td>';
    h+='<td style="font-weight:600">'+(p.comments_count||'â€”')+'</td>';
    h+='<td style="color:var(--accent-emerald)">'+(p.shares||'â€”')+'</td>';
    h+='<td>'+(p.reach?p.reach.toLocaleString():'â€”')+'</td>';
    h+='<td style="font-weight:700;color:'+(parseFloat(rate)>=5?'var(--accent-emerald)':'var(--accent-amber)')+'">'+rate+'</td>';
    h+='<td style="font-size:10px;color:var(--text-muted)">'+timeAgo(p.published_at||p.created_at)+'</td></tr>';
  });
  el.innerHTML=h+'</tbody></table>';
}

// â•â•â• AI POST CREATOR (Gemini) â•â•â•
function openAIPostCreator(){
  var h='<div class="modal-title">ğŸ¤– AI Post Creator</div>';
  h+='<div style="font-size:12px;color:var(--text-muted);margin-bottom:16px">Powered by Google Gemini â€” generates captions, hashtags & auto-publishes to FB + IG</div>';
  h+='<div class="field-group"><label class="field-label">What do you want to post about? *</label><textarea class="intel-input" id="aiTopic" placeholder="e.g. New mango avakaya pickle launch, behind-the-scenes making video, customer testimonial, festival offer..." style="min-height:80px"></textarea></div>';
  h+='<div class="field-group"><label class="field-label">Upload Image for Analysis (optional)</label><input type="file" id="aiImage" accept="image/*" class="intel-input" style="padding:8px"><div style="font-size:10px;color:var(--text-muted);margin-top:4px">Gemini will analyze this image and create a post about it</div></div>';
  h+='<div class="field-group"><label class="field-label">Image URL for Publishing (required for Instagram)</label><input class="intel-input" id="aiImageUrl" placeholder="https://i.imgur.com/... (public direct image URL)"><div style="font-size:10px;color:var(--text-muted);margin-top:4px">Upload your image to <a href="https://imgur.com/upload" target="_blank">imgur.com</a> and paste the direct URL here</div></div>';
  h+='<div class="field-group"><label class="field-label">Auto-Publish To</label><div style="display:flex;gap:6px;flex-wrap:wrap" id="aiPlatformPicks">';
  ['Facebook','Instagram'].forEach(function(p){
    h+='<label style="display:flex;align-items:center;gap:4px;font-size:12px;cursor:pointer;padding:4px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg-elevated)"><input type="checkbox" class="aiPlat" value="'+p.toLowerCase()+'" checked>'+p+'</label>';
  });
  ['YouTube','Twitter','LinkedIn','WhatsApp'].forEach(function(p){
    h+='<label style="display:flex;align-items:center;gap:4px;font-size:12px;cursor:pointer;padding:4px 10px;border:1px solid var(--border);border-radius:6px"><input type="checkbox" class="aiPlat" value="'+p.toLowerCase()+'">'+p+'</label>';
  });
  h+='</div></div>';
  h+='<div style="display:flex;gap:10px">';
  h+='<div class="field-group" style="flex:1"><label class="field-label">Tone</label><select class="intel-input" id="aiTone"><option value="casual">Casual & Fun</option><option value="professional">Professional</option><option value="promotional" selected>Promotional</option><option value="storytelling">Storytelling</option><option value="educational">Educational</option><option value="festive">Festive / Seasonal</option></select></div>';
  h+='<div class="field-group" style="flex:1"><label class="field-label">Language</label><select class="intel-input" id="aiLang"><option value="english">English</option><option value="telugu_english">Telugu + English Mix</option><option value="hindi_english">Hindi + English Mix</option><option value="telugu">Telugu</option></select></div>';
  h+='</div>';
  h+='<div style="display:flex;gap:10px;margin-top:12px">';
  h+='<button class="btn btn-violet" onclick="generateAIPost()" id="btnGenAI">ğŸ¤– Generate with Gemini</button>';
  h+='<button class="btn btn-ghost" onclick="closeModal()">Cancel</button>';
  h+='</div>';
  showModal(h);
}

async function generateAIPost(){
  var topic=document.getElementById('aiTopic').value.trim();
  if(!topic){toast('âŒ Tell AI what to post about');return}
  var platforms=[].slice.call(document.querySelectorAll('.aiPlat:checked')).map(function(c){return c.value});
  var tone=document.getElementById('aiTone').value;
  var lang=document.getElementById('aiLang').value;
  var imgFile=document.getElementById('aiImage').files[0];
  var imgUrl=document.getElementById('aiImageUrl').value.trim();
  var btn=document.getElementById('btnGenAI');btn.disabled=true;btn.innerHTML='<span class="spinner"></span> Gemini thinking...';

  // Store image URL for publishing later
  window._aiImageUrl=imgUrl;

  // Build image base64 if uploaded
  var imgData=null;
  if(imgFile){
    imgData=await new Promise(function(resolve){
      var reader=new FileReader();
      reader.onload=function(){resolve(reader.result.split(',')[1])};
      reader.readAsDataURL(imgFile);
    });
  }

  try{
    var r=await fetch('/.netlify/functions/gemini-ai',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'create_post',topic:topic,platforms:platforms,tone:tone,language:lang,image:imgData,image_type:imgFile?imgFile.type:null})
    });
    var d=await r.json();
    if(d.error){toast('âŒ '+d.error);btn.disabled=false;btn.innerHTML='ğŸ¤– Generate with Gemini';return}
    closeModal();
    showAIResult(d,platforms);
    toast('âœ… AI content generated!');
  }catch(e){toast('âŒ Gemini error: '+e.message)}
  btn.disabled=false;btn.innerHTML='ğŸ¤– Generate with Gemini';
}

function showAIResult(data,platforms){
  var card=document.getElementById('aiResultCard');card.style.display='block';
  var h='<div style="display:flex;flex-direction:column;gap:14px">';
  // Main caption
  h+='<div style="background:var(--bg-elevated);border-radius:10px;padding:16px"><div style="font-size:11px;font-weight:700;color:var(--accent-violet);margin-bottom:6px">ğŸ“ CAPTION</div>';
  h+='<div style="font-size:13px;line-height:1.6;white-space:pre-wrap" id="aiCaption">'+esc(data.caption||'')+'</div></div>';
  // Hashtags
  if(data.hashtags){h+='<div style="background:var(--bg-elevated);border-radius:10px;padding:16px"><div style="font-size:11px;font-weight:700;color:var(--accent-blue);margin-bottom:6px">ğŸ·ï¸ HASHTAGS</div><div style="font-size:12px;color:var(--accent-blue)" id="aiHashtags">'+esc(data.hashtags)+'</div></div>'}
  // Alt versions
  if(data.short_version){h+='<div style="background:var(--bg-elevated);border-radius:10px;padding:16px"><div style="font-size:11px;font-weight:700;color:var(--accent-amber);margin-bottom:6px">ğŸ“± SHORT VERSION (Stories/Reels)</div><div style="font-size:12px" id="aiShort">'+esc(data.short_version)+'</div></div>'}
  if(data.cta){h+='<div style="background:var(--bg-elevated);border-radius:10px;padding:16px"><div style="font-size:11px;font-weight:700;color:var(--accent-emerald);margin-bottom:6px">ğŸ¯ CALL TO ACTION</div><div style="font-size:12px">'+esc(data.cta)+'</div></div>'}
  if(data.image_ideas){h+='<div style="background:var(--bg-elevated);border-radius:10px;padding:16px"><div style="font-size:11px;font-weight:700;color:var(--accent-orange);margin-bottom:6px">ğŸ“¸ IMAGE/VIDEO IDEAS</div><div style="font-size:12px;line-height:1.5">'+esc(data.image_ideas)+'</div></div>'}
  if(data.best_time){h+='<div style="background:var(--bg-elevated);border-radius:10px;padding:12px"><div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:4px">â° BEST POSTING TIME</div><div style="font-size:12px">'+esc(data.best_time)+'</div></div>'}
  // Publishing targets
  var platIcons={facebook:'ğŸ“˜',instagram:'ğŸ“¸',youtube:'ğŸ“º',twitter:'ğ•',linkedin:'ğŸ’¼',whatsapp:'ğŸ’¬'};
  h+='<div style="background:rgba(100,50,255,0.05);border:1px solid rgba(100,50,255,0.15);border-radius:10px;padding:14px">';
  h+='<div style="font-size:11px;font-weight:700;color:var(--accent-violet);margin-bottom:8px">ğŸš€ AUTO-PUBLISH TARGETS</div>';
  h+='<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">';
  platforms.forEach(function(p){h+='<span style="font-size:11px;padding:3px 10px;background:var(--bg-elevated);border-radius:12px;border:1px solid var(--border)">'+(platIcons[p]||'')+ ' '+p.charAt(0).toUpperCase()+p.slice(1)+'</span>'});
  h+='</div>';
  if(window._aiImageUrl){
    h+='<div style="font-size:11px;color:var(--accent-emerald)">âœ… Image URL ready: '+esc(window._aiImageUrl.substring(0,50))+'...</div>';
  }else if(platforms.indexOf('instagram')>=0){
    h+='<div style="font-size:11px;color:var(--accent-amber)">âš ï¸ No image URL â€” Instagram posting will ask for one</div>';
  }
  h+='</div>';
  // Actions
  h+='<div style="display:flex;gap:8px;flex-wrap:wrap;padding-top:8px">';
  h+='<button class="btn btn-sm" style="background:linear-gradient(135deg,#6366f1,#a855f7);color:#fff;border:0;font-weight:700" onclick="autoPublishAI()" id="btnAutoPublish">ğŸš€ Auto-Publish to All</button>';
  h+='<button class="btn btn-emerald btn-sm" onclick="saveAIDraft()">ğŸ’¾ Save Draft</button>';
  h+='<button class="btn btn-amber btn-sm" onclick="scheduleAIPost()">ğŸ“… Schedule</button>';
  h+='<button class="btn btn-ghost btn-sm" onclick="copyAIContent()">ğŸ“‹ Copy All</button></div>';
  document.getElementById('aiResultArea').innerHTML=h+'</div>';
  // Store for saving
  window._aiResult=data;window._aiPlatforms=platforms;
}

async function saveAIDraft(){
  var d=window._aiResult;if(!d)return;
  var ok=await dbInsert('social_posts',{caption:d.caption,hashtags:d.hashtags||'',platforms:window._aiPlatforms||['instagram'],status:'draft',ai_generated:true,tone:d.tone||'',short_version:d.short_version||'',cta:d.cta||'',image_ideas:d.image_ideas||''});
  if(ok){toast('âœ… Saved as draft!');await loadSCPosts()}
}
async function scheduleAIPost(){
  var d=window._aiResult;if(!d)return;
  showModal('<div class="modal-title">ğŸ“… Schedule Post</div><div class="field-group"><label class="field-label">Date & Time</label><input type="datetime-local" class="intel-input" id="schedDT"></div><div style="display:flex;gap:10px;margin-top:12px"><button class="btn btn-amber" onclick="confirmSchedule()">Schedule</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>');
}
async function confirmSchedule(){
  var dt=document.getElementById('schedDT').value;if(!dt){toast('âŒ Pick a date');return}
  var d=window._aiResult;
  var ok=await dbInsert('social_posts',{caption:d.caption,hashtags:d.hashtags||'',platforms:window._aiPlatforms||['instagram'],status:'scheduled',scheduled_at:new Date(dt).toISOString(),ai_generated:true,tone:d.tone||'',short_version:d.short_version||'',cta:d.cta||'',image_ideas:d.image_ideas||''});
  if(ok){toast('âœ… Scheduled!');closeModal();await loadSCPosts()}
}
async function autoPublishAI(){
  var d=window._aiResult;if(!d)return;
  var plats=window._aiPlatforms||['facebook'];
  var fullMsg=(d.caption||'')+'\n\n'+(d.hashtags||'');
  if(d.cta)fullMsg+='\n\n'+d.cta;
  var imgUrl=window._aiImageUrl||'';
  var btn=document.getElementById('btnAutoPublish');
  btn.disabled=true;btn.innerHTML='<span class="spinner"></span> Publishing...';
  var fbResult=null,igResult=null;
  var statusParts=[];

  // === FACEBOOK ===
  if(plats.indexOf('facebook')>=0){
    toast('ğŸ“˜ Publishing to Facebook...');
    try{
      var fbBody=imgUrl?{action:'post_photo',message:fullMsg,image_url:imgUrl}:{action:'post_facebook',message:fullMsg};
      var r=await fetch('/.netlify/functions/social-post',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(fbBody)});
      fbResult=await r.json();
      if(fbResult.success){statusParts.push('ğŸ“˜ FB âœ…');toast('âœ… Facebook posted!')}
      else{statusParts.push('ğŸ“˜ FB âŒ');toast('âš ï¸ FB: '+(fbResult.error||'Failed'))}
    }catch(e){statusParts.push('ğŸ“˜ FB âŒ');toast('âš ï¸ FB error: '+e.message)}
  }

  // === INSTAGRAM ===
  if(plats.indexOf('instagram')>=0){
    if(!imgUrl){
      imgUrl=prompt('ğŸ“¸ Instagram requires a public image URL.\nUpload to imgur.com and paste the direct link:');
    }
    if(imgUrl&&imgUrl.trim()){
      toast('ğŸ“¸ Publishing to Instagram...');
      try{
        var r2=await fetch('/.netlify/functions/social-post',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'post_instagram',caption:fullMsg,image_url:imgUrl.trim()})});
        igResult=await r2.json();
        if(igResult.success){statusParts.push('ğŸ“¸ IG âœ…');toast('âœ… Instagram posted!')}
        else{statusParts.push('ğŸ“¸ IG âŒ');toast('âš ï¸ IG: '+(igResult.error||'Failed'))}
      }catch(e){statusParts.push('ğŸ“¸ IG âŒ');toast('âš ï¸ IG error: '+e.message)}
    }else{statusParts.push('ğŸ“¸ IG â­ï¸ skipped')}
  }

  // === SAVE TO DATABASE ===
  var ok=await dbInsert('social_posts',{
    caption:d.caption,hashtags:d.hashtags||'',platforms:plats,status:'published',
    published_at:new Date().toISOString(),ai_generated:true,tone:d.tone||'',
    short_version:d.short_version||'',cta:d.cta||'',image_ideas:d.image_ideas||'',
    image_url:imgUrl||'',
    post_url:fbResult&&fbResult.post_url?fbResult.post_url:'',
    fb_post_id:fbResult&&fbResult.post_id?fbResult.post_id:'',
    ig_media_id:igResult&&igResult.media_id?igResult.media_id:''
  });
  if(ok)await loadSCPosts();

  // === FINAL STATUS ===
  btn.disabled=false;
  btn.innerHTML='âœ… Published! '+statusParts.join(' Â· ');
  setTimeout(function(){btn.innerHTML='ğŸš€ Auto-Publish to All'},5000);
  toast('ğŸ‰ '+statusParts.join(' Â· '));
}
// Legacy alias
async function publishAIPost(){return autoPublishAI()}
// â•â•â• DIRECT FB POST â•â•â•
async function postToFB(caption,hashtags,cta,imageUrl){
  var msg=caption+(hashtags?'\n\n'+hashtags:'')+(cta?'\n\n'+cta:'');
  var body={action:imageUrl?'post_photo':'post_facebook',message:msg};
  if(imageUrl)body.image_url=imageUrl;
  try{
    var r=await fetch('/.netlify/functions/social-post',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    return await r.json();
  }catch(e){return{error:e.message}}
}
// â•â•â• PULL FB FEED â•â•â•
async function pullFBFeed(){
  toast('ğŸ“¡ Pulling Facebook feed...');
  try{
    var r=await fetch('/.netlify/functions/social-post',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'get_feed'})});
    var d=await r.json();
    if(d.posts&&d.posts.length){
      for(var i=0;i<d.posts.length;i++){
        var p=d.posts[i];
        var exists=SC_POSTS.find(function(x){return x.fb_post_id===p.post_id});
        if(!exists){
          await dbInsert('social_posts',{caption:p.message||'',platforms:['facebook'],status:'published',published_at:p.created_time,post_url:p.permalink,fb_post_id:p.post_id,likes:p.likes,comments_count:p.comments,shares:p.shares});
        }else{
          // Update metrics
          try{await db.from('social_posts').update({likes:p.likes,comments_count:p.comments,shares:p.shares}).eq('fb_post_id',p.post_id)}catch(e){}
        }
      }
      toast('âœ… Pulled '+d.posts.length+' posts from Facebook!');
      await loadSCPosts();
    }else{toast('â„¹ï¸ No posts found on Facebook page')}
  }catch(e){toast('âŒ '+e.message)}
}
function copyAIContent(){
  var d=window._aiResult;if(!d)return;
  var text=(d.caption||'')+'\n\n'+(d.hashtags||'')+'\n\n'+(d.short_version?'Short: '+d.short_version+'\n':'')+(d.cta?'CTA: '+d.cta:'');
  navigator.clipboard.writeText(text).then(function(){toast('ğŸ“‹ Copied!')}).catch(function(){toast('âŒ Copy failed')});
}

// â•â•â• MANUAL POST â•â•â•
function openManualPost(){
  var h='<div class="modal-title">âœï¸ Create Post</div>';
  h+='<div class="field-group"><label class="field-label">Caption *</label><textarea class="intel-input" id="mpCaption" placeholder="Write your post caption..." style="min-height:100px"></textarea></div>';
  h+='<div class="field-group"><label class="field-label">Hashtags</label><input class="intel-input" id="mpHash" placeholder="#SeaSaltPickles #AndhraPickles..."></div>';
  h+='<div class="field-group"><label class="field-label">Platforms</label><div style="display:flex;gap:6px;flex-wrap:wrap">';
  ['Instagram','Facebook','YouTube','Twitter','LinkedIn','WhatsApp'].forEach(function(p){
    h+='<label style="display:flex;align-items:center;gap:4px;font-size:12px;cursor:pointer;padding:4px 10px;border:1px solid var(--border);border-radius:6px"><input type="checkbox" class="mpPlat" value="'+p.toLowerCase()+'" '+(p==='Instagram'?'checked':'')+'>'+p+'</label>';
  });
  h+='</div></div>';
  h+='<div class="field-group"><label class="field-label">Status</label><select class="intel-input" id="mpStatus"><option value="draft">Draft</option><option value="scheduled">Scheduled</option><option value="published">Published</option></select></div>';
  h+='<div class="field-group" id="mpSchedWrap" style="display:none"><label class="field-label">Schedule Date</label><input type="datetime-local" class="intel-input" id="mpSchedDT"></div>';
  h+='<div class="field-group"><label class="field-label">Post URL (if published)</label><input class="intel-input" id="mpURL" placeholder="https://instagram.com/p/..."></div>';
  h+='<div style="display:flex;gap:10px;margin-top:12px"><button class="btn btn-primary" onclick="saveManualPost()">ğŸ’¾ Save</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>';
  h+='<script>document.getElementById("mpStatus").onchange=function(){document.getElementById("mpSchedWrap").style.display=this.value==="scheduled"?"block":"none"}<\/script>';
  showModal(h);
}
async function saveManualPost(){
  var cap=document.getElementById('mpCaption').value.trim();if(!cap){toast('âŒ Caption required');return}
  var platforms=[].slice.call(document.querySelectorAll('.mpPlat:checked')).map(function(c){return c.value});
  var status=document.getElementById('mpStatus').value;
  var row={caption:cap,hashtags:document.getElementById('mpHash').value.trim(),platforms:platforms,status:status,post_url:document.getElementById('mpURL').value.trim(),ai_generated:false};
  if(status==='scheduled'){var dt=document.getElementById('mpSchedDT').value;if(dt)row.scheduled_at=new Date(dt).toISOString()}
  if(status==='published')row.published_at=new Date().toISOString();
  if(await dbInsert('social_posts',row)){toast('âœ… Post saved!');closeModal();await loadSCPosts()}
}

// â•â•â• POST DETAIL & METRICS â•â•â•
function openPostDetail(id){
  var p=SC_POSTS.find(function(x){return x.id===id});if(!p)return;
  var h='<div class="modal-title">ğŸ“‹ Post Detail</div>';
  h+='<div style="display:flex;gap:6px;margin-bottom:12px"><span class="badge '+(p.status==='published'?'badge-green':p.status==='scheduled'?'badge-amber':'badge-blue')+'">'+esc(p.status)+'</span>';
  if(p.ai_generated)h+='<span class="badge badge-violet">ğŸ¤– AI Generated</span>';
  h+=(p.platforms||[]).map(function(pl){return '<span class="badge badge-blue">'+esc(pl)+'</span>'}).join(' ')+'</div>';
  h+='<div style="background:var(--bg-elevated);border-radius:8px;padding:14px;margin-bottom:12px"><div style="font-size:13px;line-height:1.6;white-space:pre-wrap">'+esc(p.caption||'')+'</div></div>';
  if(p.hashtags)h+='<div style="font-size:12px;color:var(--accent-blue);margin-bottom:12px">'+esc(p.hashtags)+'</div>';
  if(p.short_version)h+='<div style="background:var(--bg-elevated);border-radius:8px;padding:10px;margin-bottom:12px;font-size:11px"><b>Short version:</b> '+esc(p.short_version)+'</div>';
  if(p.cta)h+='<div style="font-size:12px;margin-bottom:12px"><b>CTA:</b> '+esc(p.cta)+'</div>';
  if(p.post_url)h+='<div style="margin-bottom:12px"><a href="'+esc(p.post_url)+'" target="_blank" style="color:var(--accent-blue);font-size:12px">ğŸ”— View Post â†’</a></div>';
  // Metrics section
  h+='<div style="font-size:13px;font-weight:700;margin-bottom:8px;padding-top:8px;border-top:1px solid var(--border-subtle)">ğŸ“Š Update Metrics</div>';
  h+='<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">';
  h+='<div class="field-group"><label class="field-label">â™¥ Likes</label><input class="intel-input" type="number" id="pmLikes" value="'+(p.likes||0)+'"></div>';
  h+='<div class="field-group"><label class="field-label">ğŸ’¬ Comments</label><input class="intel-input" type="number" id="pmComments" value="'+(p.comments_count||0)+'"></div>';
  h+='<div class="field-group"><label class="field-label">â†— Shares</label><input class="intel-input" type="number" id="pmShares" value="'+(p.shares||0)+'"></div>';
  h+='<div class="field-group"><label class="field-label">ğŸ‘ï¸ Reach</label><input class="intel-input" type="number" id="pmReach" value="'+(p.reach||0)+'"></div></div>';
  h+='<div class="field-group"><label class="field-label">Post URL</label><input class="intel-input" id="pmURL" value="'+esc(p.post_url||'')+'"></div>';
  h+='<div class="field-group"><label class="field-label">Status</label><select class="intel-input" id="pmStatus"><option value="draft" '+(p.status==='draft'?'selected':'')+'>Draft</option><option value="scheduled" '+(p.status==='scheduled'?'selected':'')+'>Scheduled</option><option value="published" '+(p.status==='published'?'selected':'')+'>Published</option></select></div>';
  h+='<div style="display:flex;gap:8px;margin-top:12px"><button class="btn btn-primary btn-sm" onclick="updatePostMetrics('+p.id+')">ğŸ’¾ Update</button><button class="btn btn-ghost btn-sm" onclick="deletePost('+p.id+')">ğŸ—‘ï¸ Delete</button><button class="btn btn-ghost btn-sm" onclick="closeModal()">Close</button></div>';
  showModal(h);
}
async function updatePostMetrics(id){
  var u={likes:parseInt(document.getElementById('pmLikes').value)||0,comments_count:parseInt(document.getElementById('pmComments').value)||0,shares:parseInt(document.getElementById('pmShares').value)||0,reach:parseInt(document.getElementById('pmReach').value)||0,post_url:document.getElementById('pmURL').value.trim(),status:document.getElementById('pmStatus').value};
  if(u.status==='published'&&!SC_POSTS.find(function(p){return p.id===id}).published_at)u.published_at=new Date().toISOString();
  try{var{error}=await db.from('social_posts').update(u).eq('id',id);if(error)throw error;toast('âœ… Updated!');closeModal();await loadSCPosts()}catch(e){toast('âŒ '+e.message)}
}
async function deletePost(id){if(!confirm('Delete this post?'))return;try{await db.from('social_posts').delete().eq('id',id);toast('ğŸ—‘ï¸ Deleted');closeModal();await loadSCPosts()}catch(e){toast('âŒ '+e.message)}}

// â•â•â• QUICK IG POST â•â•â•
function openQuickIGPost(){
  var h='<div class="modal-title">ğŸ“¸ Quick Instagram Post</div>';
  h+='<div style="font-size:12px;color:var(--text-muted);margin-bottom:16px">Post directly to @seasaltpickles Instagram</div>';
  h+='<div class="field-group"><label class="field-label">Caption *</label><textarea class="intel-input" id="qigCap" placeholder="Write your Instagram caption..." style="min-height:120px"></textarea></div>';
  h+='<div class="field-group"><label class="field-label">Image URL * (must be public)</label><input class="intel-input" id="qigImg" placeholder="https://... (JPG/PNG, publicly accessible)"></div>';
  h+='<div style="background:rgba(255,180,0,0.1);border:1px solid rgba(255,180,0,0.3);border-radius:8px;padding:10px;font-size:11px;margin-bottom:12px">âš ï¸ Instagram requires a <b>public image URL</b>. Upload your image to <a href="https://imgur.com/upload" target="_blank">imgur.com</a> or <a href="https://postimages.org" target="_blank">postimages.org</a> first, then paste the direct URL here.</div>';
  h+='<div style="display:flex;gap:10px;margin-top:12px"><button class="btn" style="background:linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);color:#fff;border:0" onclick="submitQuickIG()" id="btnQIG">ğŸ“¸ Post to Instagram Now</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>';
  showModal(h);
}
async function submitQuickIG(){
  var cap=document.getElementById('qigCap').value.trim();if(!cap){toast('âŒ Caption required');return}
  var img=document.getElementById('qigImg').value.trim();if(!img){toast('âŒ Image URL required for Instagram');return}
  var btn=document.getElementById('btnQIG');btn.disabled=true;btn.innerHTML='<span class="spinner"></span> Posting...';
  try{
    var r=await fetch('/.netlify/functions/social-post',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'post_instagram',caption:cap,image_url:img})});
    var d=await r.json();
    if(d.success){
      toast('âœ… Posted to Instagram!');
      await dbInsert('social_posts',{caption:cap,platforms:['instagram'],status:'published',published_at:new Date().toISOString(),post_url:d.post_url||'',image_url:img,ig_media_id:d.media_id||''});
      closeModal();await loadSCPosts();
    }else{toast('âŒ '+(d.error||'Failed to post'))}
  }catch(e){toast('âŒ '+e.message)}
  btn.disabled=false;btn.innerHTML='ğŸ“¸ Post to Instagram Now';
}
// â•â•â• PULL IG FEED â•â•â•
async function pullIGFeed(){
  toast('ğŸ“¡ Pulling Instagram feed...');
  try{
    var r=await fetch('/.netlify/functions/social-post',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'get_ig_feed'})});
    var d=await r.json();
    if(d.posts&&d.posts.length){
      for(var i=0;i<d.posts.length;i++){
        var p=d.posts[i];
        var exists=SC_POSTS.find(function(x){return x.ig_media_id===p.media_id});
        if(!exists){
          await dbInsert('social_posts',{caption:p.caption||'',platforms:['instagram'],status:'published',published_at:p.timestamp,post_url:p.permalink,image_url:p.media_url,ig_media_id:p.media_id,likes:p.likes,comments_count:p.comments});
        }else{
          try{await db.from('social_posts').update({likes:p.likes,comments_count:p.comments}).eq('ig_media_id',p.media_id)}catch(e){}
        }
      }
      toast('âœ… Pulled '+d.posts.length+' posts from Instagram!');
      await loadSCPosts();
    }else{toast('â„¹ï¸ No posts found on Instagram')}
  }catch(e){toast('âŒ '+e.message)}
}

// â•â•â• AUTO DAILY POST â•â•â•
async function triggerAutoPost(){
  toast('âš¡ Generating & publishing AI post...');
  try{
    var r=await fetch('/.netlify/functions/auto-post',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'generate'})});
    var txt=await r.text();
    var d;
    try{d=JSON.parse(txt)}catch(e){toast('âŒ '+txt.substring(0,200));return}
    // Always show modal with full details
    var h='<div class="modal-title">âš¡ AI Post Results</div>';
    h+='<div style="margin-bottom:16px">';
    // Show error if any
    if(d.error){h+='<div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#ef4444;padding:12px;border-radius:8px;font-size:13px;margin-bottom:10px">âŒ '+esc(d.error)+'</div>'}
    // Show platform results
    if(d.results){d.results.forEach(function(r){
      var cl=r.indexOf('POSTED')>=0?'background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);color:#10b981':r.indexOf('FAILED')>=0||r.indexOf('ERROR')>=0?'background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#ef4444':'background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);color:#f59e0b';
      h+='<div style="'+cl+';padding:10px;border-radius:8px;font-size:13px;font-weight:600;margin-bottom:6px">'+esc(r)+'</div>';
    })}
    h+='</div>';
    if(d.post){
      h+='<div style="background:var(--bg-elevated);border-radius:10px;padding:16px;margin-bottom:12px"><div style="font-size:11px;font-weight:700;color:var(--accent-violet);margin-bottom:6px">ğŸ“ CAPTION</div><div style="font-size:13px;line-height:1.6;white-space:pre-wrap">'+esc(d.post.caption||'')+'</div></div>';
      if(d.post.hashtags)h+='<div style="background:var(--bg-elevated);border-radius:10px;padding:12px;margin-bottom:12px"><div style="font-size:11px;color:var(--accent-blue)">'+esc(d.post.hashtags)+'</div></div>';
    }
    if(d.image_url)h+='<div style="margin-bottom:12px"><img src="'+esc(d.image_url)+'" style="width:100%;max-width:300px;border-radius:10px"></div>';
    if(d.facebook&&d.facebook.url)h+='<div style="margin-bottom:8px"><a href="'+esc(d.facebook.url)+'" target="_blank" style="color:var(--accent-blue);font-size:12px">ğŸ”— View on Facebook â†’</a></div>';
    h+='<div style="display:flex;gap:10px;margin-top:12px"><button class="btn btn-ghost" onclick="closeModal()">Close</button></div>';
    showModal(h);
    if(d.success)toast('âœ… Published!');
    else toast('âš ï¸ Check results above');
    await loadSCPosts();
  }catch(e){toast('âŒ '+e.message)}
}

// â•â•â• QUICK FB POST â•â•â•
function openQuickFBPost(){
  var h='<div class="modal-title">ğŸ“˜ Quick Facebook Post</div>';
  h+='<div style="font-size:12px;color:var(--text-muted);margin-bottom:16px">Post directly to Sea Salt Pickles Facebook Page</div>';
  h+='<div class="field-group"><label class="field-label">Message *</label><textarea class="intel-input" id="qfbMsg" placeholder="Write your Facebook post..." style="min-height:120px"></textarea></div>';
  h+='<div class="field-group"><label class="field-label">Image URL (optional)</label><input class="intel-input" id="qfbImg" placeholder="https://... (must be a public URL)"></div>';
  h+='<div class="field-group"><label class="field-label">Link (optional)</label><input class="intel-input" id="qfbLink" placeholder="https://seasaltpickles.com/..."></div>';
  h+='<div style="display:flex;gap:10px;margin-top:12px"><button class="btn btn-blue" onclick="submitQuickFB()" id="btnQFB">ğŸ“˜ Post to Facebook Now</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>';
  showModal(h);
}
async function submitQuickFB(){
  var msg=document.getElementById('qfbMsg').value.trim();if(!msg){toast('âŒ Message required');return}
  var img=document.getElementById('qfbImg').value.trim();
  var link=document.getElementById('qfbLink').value.trim();
  var btn=document.getElementById('btnQFB');btn.disabled=true;btn.innerHTML='<span class="spinner"></span> Posting...';
  try{
    var body=img?{action:'post_photo',message:msg,image_url:img}:{action:'post_facebook',message:msg,link:link||undefined};
    var r=await fetch('/.netlify/functions/social-post',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    var d=await r.json();
    if(d.success){
      toast('âœ… Posted to Facebook!');
      await dbInsert('social_posts',{caption:msg,platforms:['facebook'],status:'published',published_at:new Date().toISOString(),post_url:d.post_url||'',fb_post_id:d.post_id||''});
      closeModal();await loadSCPosts();
    }else{toast('âŒ '+(d.error||'Failed to post'))}
  }catch(e){toast('âŒ '+e.message)}
  btn.disabled=false;btn.innerHTML='ğŸ“˜ Post to Facebook Now';
}

// â•â•â• PLATFORM MANAGEMENT â•â•â•
function openConnectPlatforms(){
  var h='<div class="modal-title">ğŸ”— Connect Platforms</div>';
  h+='<div style="font-size:12px;color:var(--text-muted);margin-bottom:16px">Save your social media handles. Full API auto-posting requires each platform\'s developer access (Phase 2).</div>';
  ['instagram','facebook','youtube','twitter','linkedin','whatsapp'].forEach(function(pl){
    var existing=SC_PLATFORMS.find(function(p){return p.platform===pl});
    h+='<div class="field-group"><label class="field-label" style="text-transform:capitalize">'+pl+' Handle</label><input class="intel-input platHandle" data-platform="'+pl+'" value="'+esc(existing?existing.handle:'')+'" placeholder="@yourhandle or URL"></div>';
  });
  h+='<div style="display:flex;gap:10px;margin-top:12px"><button class="btn btn-violet" onclick="savePlatforms()">ğŸ’¾ Save All</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>';
  showModal(h);
}
function managePlatform(key){openConnectPlatforms()}
async function savePlatforms(){
  var inputs=document.querySelectorAll('.platHandle');var saved=0;
  for(var i=0;i<inputs.length;i++){
    var inp=inputs[i];var pl=inp.dataset.platform;var handle=inp.value.trim();
    if(!handle)continue;
    var existing=SC_PLATFORMS.find(function(p){return p.platform===pl});
    if(existing){try{await db.from('social_platforms').update({handle:handle,updated_at:new Date().toISOString()}).eq('id',existing.id);saved++}catch(e){}}
    else{if(await dbInsert('social_platforms',{platform:pl,handle:handle,connected:true}))saved++}
  }
  toast('âœ… '+saved+' platforms saved');closeModal();await loadSCPlatforms();
}

document.addEventListener('DOMContentLoaded',()=>{if(db)loadAll();else toast('âš ï¸ Supabase not connected')});
</script>
<!-- MOBILE BOTTOM NAV -->
<div class="mobile-nav">
<div class="mobile-nav-inner">
<div class="mob-tab active" onclick="mobileGo('competitors',this)" data-page="competitors"><div class="mob-icon">ğŸ†</div>Intel</div>
<div class="mob-tab" onclick="mobileGo('social-command',this)" data-page="social-command"><div class="mob-icon">ğŸš€</div>Post</div>
<div class="mob-tab" onclick="mobileGo('web-intel',this)" data-page="web-intel"><div class="mob-icon">ğŸŒ</div>Sites</div>
<div class="mob-tab" onclick="mobileGo('social-spy',this)" data-page="social-spy"><div class="mob-icon">ğŸ”</div>Social</div>
<div class="mob-tab" onclick="toggleMobileMenu()" data-page="more"><div class="mob-icon">â˜°</div>More</div>
</div>
</div>
<!-- MOBILE SLIDE MENU -->
<div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="closeMobileMenu()"></div>
<div class="mobile-menu" id="mobileMenu">
<div style="padding:20px;border-bottom:1px solid var(--border-subtle)">
<div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">ğŸ”±</span><div><div style="font-weight:800;font-size:16px">SeaSalt</div><div style="font-size:10px;color:var(--accent-red);font-weight:600;letter-spacing:1px">INTELLIGENCE HUB</div></div></div>
</div>
<div style="padding:8px">
<div class="nav-item" onclick="mobileGo('competitors',this);closeMobileMenu()"><span class="icon">ğŸ†</span><span class="nav-text">Competitors</span></div>
<div class="nav-item" onclick="mobileGo('social-command',this);closeMobileMenu()"><span class="icon">ğŸš€</span><span class="nav-text">Social Command</span></div>
<div class="nav-item" onclick="mobileGo('social-spy',this);closeMobileMenu()"><span class="icon">ğŸ”</span><span class="nav-text">Social Spy</span></div>
<div class="nav-item" onclick="mobileGo('insights',this);closeMobileMenu()"><span class="icon">ğŸ§ </span><span class="nav-text">Insights</span></div>
<div class="nav-item" onclick="mobileGo('content-studio',this);closeMobileMenu()"><span class="icon">ğŸ¨</span><span class="nav-text">Content Studio</span></div>
<div class="nav-item" onclick="mobileGo('social-listeners',this);closeMobileMenu()"><span class="icon">ğŸ“¡</span><span class="nav-text">Social Listeners</span></div>
<div class="nav-item" onclick="mobileGo('engagers',this);closeMobileMenu()"><span class="icon">ğŸ‘¥</span><span class="nav-text">Engagers</span></div>
<div class="nav-item" onclick="mobileGo('web-intel',this);closeMobileMenu()"><span class="icon">ğŸŒ</span><span class="nav-text">Website Intel</span></div>
<div class="nav-item" onclick="mobileGo('products',this);closeMobileMenu()"><span class="icon">ğŸ›’</span><span class="nav-text">Products & Prices</span></div>
<div class="nav-item" onclick="mobileGo('ad-library',this);closeMobileMenu()"><span class="icon">ğŸ“º</span><span class="nav-text">Ad Library</span></div>
<div class="nav-item" onclick="mobileGo('keyword-tracker',this);closeMobileMenu()"><span class="icon">ğŸ”‘</span><span class="nav-text">Keyword Tracker</span></div>
</div>
<div style="padding:12px 16px;border-top:1px solid var(--border-subtle);margin-top:8px">
<div style="display:flex;gap:8px"><a href="https://seasaltpickles.com" target="_blank" class="btn btn-ghost btn-sm" style="flex:1;justify-content:center">ğŸŒ Store</a><a href="#" class="btn btn-ghost btn-sm" style="flex:1;justify-content:center" onclick="closeMobileMenu()">ğŸ—„ï¸ Supabase</a></div>
<div style="margin-top:8px;font-size:10px;color:var(--text-muted);text-align:center"><span class="status-dot" id="statusDotMob" style="background:var(--accent-emerald)"></span> Connected Â· <span id="lastSyncMob"></span></div>
</div>
</div>
<script>
function toggleMobileMenu(){var m=document.getElementById('mobileMenu'),o=document.getElementById('mobileMenuOverlay');m.classList.toggle('open');o.classList.toggle('show')}
function closeMobileMenu(){document.getElementById('mobileMenu').classList.remove('open');document.getElementById('mobileMenuOverlay').classList.remove('show')}
function mobileGo(p,el){
  go(p,null);
  // Update mobile bottom nav active state
  document.querySelectorAll('.mob-tab').forEach(function(t){t.classList.remove('active')});
  if(el&&el.classList.contains('mob-tab'))el.classList.add('active');
  // Also update sidebar nav for consistency
  document.querySelectorAll('.sidebar .nav-item').forEach(function(n){n.classList.remove('active')});
  var sideItem=document.querySelector('.sidebar .nav-item[onclick*="'+p+'"]');
  if(sideItem)sideItem.classList.add('active');
}
</script>
</body></html>
