<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SeaSalt Intelligence Hub</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="/_config.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg-deep:#f8f9fa;--bg-surface:#ffffff;--bg-card:#ffffff;--bg-elevated:#f1f3f5;--border:#e2e5e9;--border-subtle:#eceef1;--text-primary:#1a1a2e;--text-secondary:#4a5568;--text-muted:#8896a6;--accent-red:#dc2626;--accent-orange:#ea580c;--accent-amber:#d97706;--accent-emerald:#059669;--accent-blue:#2563eb;--accent-violet:#7c3aed;--accent-pink:#db2777}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg-deep);color:var(--text-primary);min-height:100vh;display:flex;overflow:hidden}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#d0d5dd;border-radius:10px}
.sidebar{width:240px;min-width:240px;background:#ffffff;border-right:1px solid var(--border);display:flex;flex-direction:column;height:100vh;z-index:50;box-shadow:2px 0 8px rgba(0,0,0,.04)}
.sidebar-brand{padding:20px 20px 16px;border-bottom:1px solid var(--border-subtle)}.sidebar-brand h1{font-size:18px;font-weight:800}.sidebar-brand p{font-size:11px;color:var(--accent-red);font-weight:600;letter-spacing:1.5px;text-transform:uppercase;margin-top:2px}
.sidebar-section{padding:16px 12px 4px;font-size:10px;font-weight:700;color:var(--text-muted);letter-spacing:1.8px;text-transform:uppercase}
.sidebar-nav{flex:1;overflow-y:auto;padding:4px 8px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;font-size:13.5px;font-weight:500;color:var(--text-secondary);transition:all .15s;margin-bottom:2px;position:relative;text-decoration:none}
.nav-item:hover{background:#f1f3f5;color:var(--text-primary)}.nav-item.active{background:linear-gradient(135deg,rgba(220,38,38,.08),rgba(234,88,12,.05));color:var(--accent-red);font-weight:600}
.nav-item.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:20px;background:var(--accent-red);border-radius:0 3px 3px 0}
.nav-item .icon{font-size:16px;width:22px;text-align:center}
.sidebar-footer{padding:12px 16px;border-top:1px solid var(--border-subtle)}.status-dot{width:7px;height:7px;border-radius:50%;display:inline-block;animation:pulse-dot 2s infinite}
@keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:.4}}
.main-content{flex:1;display:flex;flex-direction:column;height:100vh;overflow:hidden}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;background:#ffffff;border-bottom:1px solid var(--border);min-height:58px}
.topbar-left h2{font-size:18px;font-weight:700}.topbar-left .subtitle{font-size:12px;color:var(--text-muted)}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;font-size:12.5px;font-weight:600;cursor:pointer;border:none;transition:all .15s;font-family:inherit}
.btn-primary{background:var(--accent-red);color:#fff}.btn-primary:hover{background:#dc2626}.btn-ghost{background:#f8f9fa;color:var(--text-secondary);border:1px solid var(--border)}.btn-ghost:hover{background:var(--border);color:var(--text-primary)}
.btn-blue{background:var(--accent-blue);color:#fff}.btn-emerald{background:var(--accent-emerald);color:#fff}.btn-orange{background:var(--accent-orange);color:#fff}.btn-violet{background:var(--accent-violet);color:#fff}
.btn-sm{padding:6px 12px;font-size:11.5px}.btn:disabled{opacity:.5;cursor:not-allowed}
.page-content{flex:1;overflow-y:auto;padding:24px 28px}.page{display:none}.page.active{display:block}
.card{background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:20px;transition:all .2s;box-shadow:0 1px 3px rgba(0,0,0,.06)}.card:hover{border-color:var(--accent-blue);box-shadow:0 4px 12px rgba(0,0,0,.08)}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}.card-title{font-size:14px;font-weight:700}.card-subtitle{font-size:11px;color:var(--text-muted);margin-top:2px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:18px 20px;position:relative;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.stat-card.red::before{background:var(--accent-red)}.stat-card.blue::before{background:var(--accent-blue)}.stat-card.emerald::before{background:var(--accent-emerald)}.stat-card.amber::before{background:var(--accent-amber)}.stat-card.violet::before{background:var(--accent-violet)}.stat-card.orange::before{background:var(--accent-orange)}.stat-card.pink::before{background:var(--accent-pink)}
.stat-label{font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.8px}.stat-value{font-size:28px;font-weight:800;margin:6px 0 2px;letter-spacing:-1px}.stat-change{font-size:11px;font-weight:600}.stat-change.up{color:var(--accent-emerald)}.stat-change.down{color:var(--accent-red)}
.data-table{width:100%;border-collapse:collapse}.data-table th{text-align:left;font-size:10px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;padding:10px 14px;border-bottom:1px solid var(--border-subtle)}
.data-table td{padding:12px 14px;font-size:13px;color:var(--text-secondary);border-bottom:1px solid var(--border-subtle)}.data-table tr:hover td{background:#f8f9fa;color:var(--text-primary)}.data-table tr:last-child td{border-bottom:none}
.badge{display:inline-flex;align-items:center;padding:3px 8px;border-radius:6px;font-size:10.5px;font-weight:700}
.badge-red{background:rgba(220,38,38,.1);color:#dc2626}.badge-green{background:rgba(5,150,105,.1);color:#059669}.badge-blue{background:rgba(37,99,235,.1);color:#2563eb}.badge-amber{background:rgba(217,119,6,.1);color:#d97706}.badge-violet{background:rgba(124,58,237,.1);color:#7c3aed}.badge-orange{background:rgba(234,88,12,.1);color:#ea580c}
.stars{color:#fbbf24;font-size:13px}.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}.comp-dot{width:10px;height:10px;border-radius:50%;display:inline-block}
.chart-bar-container{display:flex;align-items:end;gap:6px;height:120px;padding-top:8px}.chart-bar{flex:1;border-radius:4px 4px 0 0;transition:height .5s;position:relative;min-width:24px}.chart-bar-label{position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);font-size:9px;color:var(--text-muted);white-space:nowrap}
.intel-input{background:#f8f9fa;border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text-primary);font-size:13px;font-family:inherit;width:100%;transition:border-color .2s}.intel-input:focus{outline:none;border-color:var(--accent-blue);box-shadow:0 0 0 3px rgba(37,99,235,.1)}.intel-input::placeholder{color:var(--text-muted)}
textarea.intel-input{resize:vertical;min-height:80px}select.intel-input{appearance:none;padding-right:32px}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}.animate-in{animation:fadeIn .35s ease-out}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(4px);z-index:100;align-items:center;justify-content:center}.modal-overlay.show{display:flex}
.modal-box{background:#ffffff;border:1px solid var(--border);border-radius:16px;padding:28px;width:90%;max-width:600px;max-height:85vh;overflow-y:auto;animation:slideUp .3s ease;box-shadow:0 20px 60px rgba(0,0,0,.15)}.modal-title{font-size:18px;font-weight:700;margin-bottom:4px}
.toast-container{position:fixed;top:20px;right:20px;z-index:200;display:flex;flex-direction:column;gap:8px}
.toast{background:#ffffff;border:1px solid var(--border);border-radius:10px;padding:12px 18px;font-size:13px;font-weight:500;display:flex;align-items:center;gap:8px;animation:slideUp .3s ease;box-shadow:0 8px 30px rgba(0,0,0,.12)}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-muted)}.empty-state .es-icon{font-size:48px;margin-bottom:12px}.empty-state h3{font-size:18px;font-weight:700;color:var(--text-secondary);margin-bottom:6px}.empty-state p{font-size:13px;max-width:400px;margin:0 auto 16px}
.insight-card{background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:20px;border-left:3px solid;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.insight-card.opportunity{border-left-color:var(--accent-emerald)}.insight-card.threat{border-left-color:var(--accent-red)}.insight-card.trend{border-left-color:var(--accent-blue)}.insight-card.action{border-left-color:var(--accent-amber)}
.social-profile{display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;transition:background .15s}.social-profile:hover{background:#f1f3f5}
.social-avatar{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent-red);border-radius:50%;animation:spin .6s linear infinite;display:inline-block}@keyframes spin{to{transform:rotate(360deg)}}
.field-group{margin-bottom:12px}.field-label{font-size:11px;font-weight:600;color:var(--text-muted);display:block;margin-bottom:4px}
@media(max-width:768px){.sidebar{width:60px;min-width:60px}.sidebar .nav-text,.sidebar-brand p,.sidebar-section,.sidebar-footer span{display:none}.grid-2{grid-template-columns:1fr}.stats-grid{grid-template-columns:1fr 1fr}.page-content{padding:16px}}
</style>
</head>
<body>
<div class="toast-container" id="toastContainer"></div>
<aside class="sidebar">
<div class="sidebar-brand"><div style="display:flex;align-items:center;gap:10px"><div style="width:36px;height:36px;background:var(--accent-red);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">ğŸ”±</div><div><h1>SeaSalt</h1><p>Intelligence Hub</p></div></div></div>
<div class="sidebar-nav">
<div class="sidebar-section">Intelligence</div>
<div class="nav-item active" onclick="go('competitors',this)"><span class="icon">ğŸ†</span><span class="nav-text">Competitors</span></div>
<div class="nav-item" onclick="go('social-spy',this)"><span class="icon">ğŸ”</span><span class="nav-text">Social Spy</span></div>
<div class="nav-item" onclick="go('insights',this)"><span class="icon">ğŸ§ </span><span class="nav-text">Insights</span></div>
<div class="nav-item" onclick="go('content-studio',this)"><span class="icon">ğŸ¨</span><span class="nav-text">Content Studio</span></div>
<div class="nav-item" onclick="go('social-listeners',this)"><span class="icon">ğŸ“¡</span><span class="nav-text">Social Listeners</span></div>
<div class="nav-item" onclick="go('engagers',this)"><span class="icon">ğŸ‘¥</span><span class="nav-text">Engagers</span></div>
<div class="nav-item" onclick="go('web-intel',this)"><span class="icon">ğŸŒ</span><span class="nav-text">Website Intel</span></div>
<div class="nav-item" onclick="go('products',this)"><span class="icon">ğŸ›’</span><span class="nav-text">Products & Prices</span></div>
<div class="sidebar-section" style="margin-top:12px">Tools</div>
<div class="nav-item" onclick="go('ad-library',this)"><span class="icon">ğŸ“º</span><span class="nav-text">Ad Library</span></div>
<div class="nav-item" onclick="go('keyword-tracker',this)"><span class="icon">ğŸ”‘</span><span class="nav-text">Keyword Tracker</span></div>
<div class="sidebar-section" style="margin-top:12px">Links</div>
<a href="https://seasaltpickles.com" target="_blank" class="nav-item"><span class="icon">ğŸŒ</span><span class="nav-text">Store</span></a>
<a href="https://supabase.com/dashboard" target="_blank" class="nav-item"><span class="icon">ğŸ—„ï¸</span><span class="nav-text">Supabase</span></a>
</div>
<div class="sidebar-footer"><div style="display:flex;align-items:center;gap:8px"><span class="status-dot" id="statusDot" style="background:var(--accent-amber)"></span><span style="font-size:11px;color:var(--text-muted)" id="statusText">Connecting...</span></div><div style="font-size:10px;color:var(--text-muted);margin-top:4px">Last sync: <span id="lastSync">â€”</span></div></div>
</aside>
<div class="main-content">
<div class="topbar"><div class="topbar-left"><div><h2 id="pageTitle">ğŸ† Competitor Intelligence</h2><div class="subtitle" id="pageSubtitle">Real-time data from Google Places API â†’ Supabase</div></div></div>
<div class="topbar-actions"><button class="btn btn-ghost btn-sm" onclick="syncAll()" id="btnSyncAll">ğŸ“Š Sync All</button><button class="btn btn-primary btn-sm" onclick="exportData()">ğŸ“¥ Export</button></div></div>
<div class="page-content">
<!-- COMPETITORS -->
<div class="page active" id="page-competitors"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card red"><div class="stat-label">Competitors Tracked</div><div class="stat-value" id="sCompCount">â€”</div><div class="stat-change" id="sCompSub">Loading...</div></div>
<div class="stat-card blue"><div class="stat-label">Avg Google Rating</div><div class="stat-value" id="sAvgRating">â€”</div><div class="stat-change">From Google Places</div></div>
<div class="stat-card emerald"><div class="stat-label">Total Reviews</div><div class="stat-value" id="sTotalReviews">â€”</div><div class="stat-change">Across all competitors</div></div>
<div class="stat-card amber"><div class="stat-label">Last Synced</div><div class="stat-value" id="sLastSync" style="font-size:16px">Never</div><div class="stat-change">Click Sync to fetch</div></div>
</div>
<div style="display:flex;gap:10px;margin-bottom:20px"><button class="btn btn-blue btn-sm" onclick="syncCompetitors()" id="btnSync">ğŸ”„ Sync Live Data</button><button class="btn btn-ghost btn-sm" onclick="openAddCompetitor()">â• Add Competitor</button></div>
<div class="card"><div class="card-header"><div><div class="card-title">Competitor Directory</div><div class="card-subtitle">Google Places API â†’ Supabase â†’ Dashboard</div></div></div><div id="compArea"></div></div>
<div class="grid-2" style="margin-top:20px"><div class="card"><div class="card-header"><div class="card-title">Rating Comparison</div></div><div class="chart-bar-container" id="ratingChart" style="height:160px"></div></div>
<div class="card"><div class="card-header"><div class="card-title">Review Volume</div></div><div class="chart-bar-container" id="reviewChart" style="height:160px"></div></div></div>
</div></div>
<!-- SOCIAL SPY -->
<div class="page" id="page-social-spy"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card violet"><div class="stat-label">With Social URLs</div><div class="stat-value" id="sSocial">â€”</div></div>
<div class="stat-card blue"><div class="stat-label">Content Logged</div><div class="stat-value" id="sSocContent">â€”</div></div>
<div class="stat-card amber"><div class="stat-label">Hashtags Tracked</div><div class="stat-value" id="sSocHash">â€”</div></div>
</div>
<div style="display:flex;gap:10px;margin-bottom:20px"><button class="btn btn-violet btn-sm" onclick="openAddSocial()">â• Add Social URLs</button><button class="btn btn-ghost btn-sm" onclick="openLogPost()">ğŸ“ Log Post</button><button class="btn btn-ghost btn-sm" onclick="openAddHashtag()">ğŸ·ï¸ Add Hashtag</button></div>
<div class="grid-2"><div class="card"><div class="card-header"><div class="card-title">Social Profiles</div></div><div id="socProfiles"></div></div>
<div class="card"><div class="card-header"><div class="card-title">Logged Posts</div></div><div id="socPosts"></div></div></div>
<div class="card" style="margin-top:16px"><div class="card-header"><div class="card-title">Hashtag Tracker</div></div><div id="hashArea"></div></div>
</div></div>
<!-- INSIGHTS -->
<div class="page" id="page-insights"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card emerald"><div class="stat-label">Opportunities</div><div class="stat-value" id="sOpp" style="color:var(--accent-emerald)">â€”</div></div>
<div class="stat-card red"><div class="stat-label">Threats</div><div class="stat-value" id="sThreat" style="color:var(--accent-red)">â€”</div></div>
<div class="stat-card blue"><div class="stat-label">Trends</div><div class="stat-value" id="sTrend" style="color:var(--accent-blue)">â€”</div></div>
<div class="stat-card amber"><div class="stat-label">Actions</div><div class="stat-value" id="sAction" style="color:var(--accent-amber)">â€”</div></div>
</div>
<div style="display:flex;gap:10px;margin-bottom:16px"><button class="btn btn-emerald btn-sm" onclick="openAddInsight()">â• Add Insight</button></div>
<div id="insightsArea"></div>
</div></div>
<!-- CONTENT STUDIO -->
<div class="page" id="page-content-studio"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card orange"><div class="stat-label">Ideas</div><div class="stat-value" id="sCiTotal">â€”</div></div>
<div class="stat-card violet"><div class="stat-label">Planned</div><div class="stat-value" id="sCiPlanned">â€”</div></div>
<div class="stat-card emerald"><div class="stat-label">Published</div><div class="stat-value" id="sCiPub">â€”</div></div>
</div>
<div style="margin-bottom:20px"><button class="btn btn-orange btn-sm" onclick="openAddIdea()">âœ¨ Add Content Idea</button></div>
<div class="card"><div class="card-header"><div class="card-title">Content Pipeline</div></div><div id="ideasArea"></div></div>
</div></div>
<!-- SOCIAL LISTENERS -->
<div class="page" id="page-social-listeners"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card emerald"><div class="stat-label">Keywords Monitored</div><div class="stat-value" id="sLkCount">â€”</div></div>
<div class="stat-card blue"><div class="stat-label">Mentions Logged</div><div class="stat-value" id="sLkMentions">â€”</div></div>
</div>
<div style="display:flex;gap:10px;margin-bottom:20px"><button class="btn btn-emerald btn-sm" onclick="openAddListenKW()">â• Add Keyword</button><button class="btn btn-ghost btn-sm" onclick="openLogMention()">ğŸ“ Log Mention</button></div>
<div class="grid-2"><div class="card"><div class="card-header"><div class="card-title">Tracked Keywords</div></div><div id="lkArea"></div></div>
<div class="card"><div class="card-header"><div class="card-title">Recent Mentions</div></div><div id="mentionArea"></div></div></div>
</div></div>
<!-- AD LIBRARY -->
<div class="page" id="page-ad-library"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card orange"><div class="stat-label">Ads Tracked</div><div class="stat-value" id="sAdCount">â€”</div></div>
<div class="stat-card blue"><div class="stat-label">Active</div><div class="stat-value" id="sAdActive">â€”</div></div>
</div>
<div style="display:flex;gap:10px;margin-bottom:10px"><button class="btn btn-orange btn-sm" onclick="scanMetaAds()">ğŸ” Open Meta Ad Library</button><button class="btn btn-ghost btn-sm" onclick="openLogAd()">ğŸ“ Log Ad Manually</button></div>
<p style="font-size:11px;color:var(--text-muted);margin-bottom:16px">Meta Ad Library is <b>public</b> â€” no API needed. Click to search each competitor, then log what you find.</p>
<div class="card"><div class="card-header"><div class="card-title">Competitor Ads</div></div><div id="adArea"></div></div>
</div></div>
<!-- KEYWORD TRACKER -->
<div class="page" id="page-engagers"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card pink"><div class="stat-label">Total Engagers</div><div class="stat-value" id="sEngTotal">â€”</div><div class="stat-change">People engaging with competitors</div></div>
<div class="stat-card emerald"><div class="stat-label">Positive</div><div class="stat-value" id="sEngPos" style="color:var(--accent-emerald)">â€”</div></div>
<div class="stat-card red"><div class="stat-label">Negative</div><div class="stat-value" id="sEngNeg" style="color:var(--accent-red)">â€”</div><div class="stat-change">Unhappy â€” target these!</div></div>
<div class="stat-card blue"><div class="stat-label">Platforms</div><div class="stat-value" id="sEngPlat">â€”</div></div>
</div>
<div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap">
<button class="btn btn-ghost btn-sm" onclick="filterEngagers('all')" id="engFilterAll" style="border-color:var(--accent-red)">All</button>
<button class="btn btn-ghost btn-sm" onclick="filterEngagers('negative')">ğŸ”´ Negative</button>
<button class="btn btn-ghost btn-sm" onclick="filterEngagers('positive')">ğŸŸ¢ Positive</button>
<button class="btn btn-ghost btn-sm" onclick="filterEngagers('google_reviews')">ğŸ“ Google Reviews</button>
<button class="btn btn-ghost btn-sm" onclick="filterEngagers('youtube')">ğŸ“º YouTube</button>
<select class="intel-input" style="width:200px;padding:6px 12px;font-size:12px" id="engCompFilter" onchange="filterEngagers(document.querySelector('.eng-filter-active')?.dataset?.filter||'all')">
<option value="">All Competitors</option>
</select>
</div>
<div class="card"><div class="card-header"><div><div class="card-title">Competitor Engagers</div><div class="card-subtitle">People who review/comment on competitor brands â€” potential customers for SeaSalt</div></div><div><span style="font-size:12px;color:var(--text-muted)" id="engShowing"></span></div></div>
<div id="engagersArea"></div>
</div>
</div></div>
<!-- WEBSITE INTELLIGENCE -->
<div class="page" id="page-web-intel"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card blue"><div class="stat-label">Sites Scanned</div><div class="stat-value" id="sWiCount">â€”</div></div>
<div class="stat-card emerald"><div class="stat-label">SeaSalt Score</div><div class="stat-value" id="sWiSS" style="color:var(--accent-emerald)">â€”</div><div class="stat-change" id="sWiRank"></div></div>
<div class="stat-card amber"><div class="stat-label">Avg Competitor</div><div class="stat-value" id="sWiAvg">â€”</div></div>
<div class="stat-card red"><div class="stat-label">Top Threat</div><div class="stat-value" id="sWiThreat" style="font-size:16px">â€”</div></div>
</div>
<div style="display:flex;gap:10px;margin-bottom:20px"><button class="btn btn-blue btn-sm" onclick="syncWebIntel()" id="btnWebSync">ğŸŒ Scan All Websites</button><button class="btn btn-ghost btn-sm" onclick="syncWebIntel('seasaltpickles.com')">ğŸ”± Scan SeaSalt Only</button></div>
<div class="card" style="margin-bottom:20px"><div class="card-header"><div><div class="card-title">Site Score Comparison</div><div class="card-subtitle">Performance Â· SEO Â· E-commerce Â· Tech Stack</div></div></div>
<div class="chart-bar-container" id="siteScoreChart" style="height:180px;padding-bottom:30px"></div></div>
<div class="card" style="margin-bottom:20px"><div class="card-header"><div><div class="card-title">Website Intelligence Table</div><div class="card-subtitle">PageSpeed Â· Tech Â· Products Â· SEO</div></div></div><div id="wiTableArea"></div></div>
<div class="grid-2">
<div class="card"><div class="card-header"><div class="card-title">Tech Stack Comparison</div></div><div id="wiTechArea"></div></div>
<div class="card"><div class="card-header"><div class="card-title">Feature Checklist</div></div><div id="wiFeatureArea"></div></div>
</div>
</div></div>
<!-- PRODUCTS & PRICES -->
<div class="page" id="page-products"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card orange"><div class="stat-label">Brands Tracked</div><div class="stat-value" id="sProdBrands">â€”</div></div>
<div class="stat-card emerald"><div class="stat-label">Avg Min Price</div><div class="stat-value" id="sProdMinAvg">â€”</div></div>
<div class="stat-card blue"><div class="stat-label">Avg Max Price</div><div class="stat-value" id="sProdMaxAvg">â€”</div></div>
<div class="stat-card violet"><div class="stat-label">E-commerce Sites</div><div class="stat-value" id="sProdEcom">â€”</div></div>
<div class="stat-card red"><div class="stat-label">Cheapest Brand</div><div class="stat-value" id="sProdCheapest" style="font-size:16px">â€”</div></div>
<div class="stat-card amber"><div class="stat-label">Product Types</div><div class="stat-value" id="sProdTypes">â€”</div></div>
</div>

<!-- Market Presence Map -->
<div class="card" style="margin-bottom:20px">
<div class="card-header"><div><div class="card-title">ğŸ—ºï¸ Market Presence Map</div><div class="card-subtitle">Where each competitor sells â€” Own Website Â· Marketplaces Â· Aggregators</div></div>
<button class="btn btn-ghost btn-sm" onclick="openEditPresence()">âœï¸ Edit Platforms</button></div>
<div id="presenceMapArea"></div></div>

<!-- Price Range Comparison -->
<div class="card" style="margin-bottom:20px"><div class="card-header"><div><div class="card-title">ğŸ’° Price Range Comparison</div><div class="card-subtitle">â‚¹ Min â†’ Max price detected on each website</div></div></div>
<div id="priceChartArea" style="padding:12px 0"></div></div>

<!-- Similar Products & Avg Price -->
<div class="card" style="margin-bottom:20px"><div class="card-header"><div><div class="card-title">ğŸ·ï¸ Product Groups & Avg Pricing</div><div class="card-subtitle">Similar products grouped across brands with average market price</div></div></div>
<div id="prodGroupArea"></div></div>

<!-- Platform Price Comparison -->
<div class="card" style="margin-bottom:20px"><div class="card-header"><div><div class="card-title">ğŸ“Š Platform Price Variation</div><div class="card-subtitle">Price differences across platforms for the same brand</div></div>
<button class="btn btn-ghost btn-sm" onclick="openAddPlatformPrice()">â• Add Price Data</button></div>
<div id="platformPriceArea"></div></div>

<!-- Products & Categories Table -->
<div class="card" style="margin-bottom:20px"><div class="card-header"><div><div class="card-title">ğŸ›’ Products & Categories by Brand</div><div class="card-subtitle">Scraped from competitor websites</div></div></div><div id="prodTableArea"></div></div>

<!-- Category Cloud -->
<div class="card"><div class="card-header"><div class="card-title">ğŸ“‚ Product Categories Detected</div></div><div id="prodCatsArea"></div></div>
</div></div>
<!-- KEYWORD TRACKER -->
<div class="page" id="page-keyword-tracker"><div class="animate-in">
<div class="stats-grid">
<div class="stat-card emerald"><div class="stat-label">Keywords</div><div class="stat-value" id="sKwCount">â€”</div></div>
<div class="stat-card blue"><div class="stat-label">Avg Position</div><div class="stat-value" id="sKwAvg">â€”</div></div>
<div class="stat-card amber"><div class="stat-label">Top 10</div><div class="stat-value" id="sKwTop">â€”</div></div>
</div>
<div style="margin-bottom:20px"><button class="btn btn-emerald btn-sm" onclick="openAddSEOKW()">â• Add Keyword</button></div>
<div class="card"><div class="card-header"><div class="card-title">SEO Keyword Rankings</div></div><div id="kwArea"></div></div>
</div></div>
</div></div>
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()"><div class="modal-box" id="modalBox"></div></div>
<script>
const SB_URL=window.__SEASALT_SB_URL||'',SB_KEY=window.__SEASALT_SB_KEY||'';
let db;try{db=supabase.createClient(SB_URL,SB_KEY);document.getElementById('statusDot').style.background='var(--accent-emerald)';document.getElementById('statusText').textContent='Live Â· Supabase Connected';}catch(e){document.getElementById('statusText').textContent='DB Error';}

function toast(m){const c=document.getElementById('toastContainer'),t=document.createElement('div');t.className='toast';t.textContent=m;c.appendChild(t);setTimeout(()=>{t.style.opacity='0';t.style.transition='all .3s';setTimeout(()=>t.remove(),300)},3500)}
function timeAgo(d){if(!d)return'â€”';const m=Math.floor((Date.now()-new Date(d).getTime())/60000);if(m<1)return'just now';if(m<60)return m+'m ago';const h=Math.floor(m/60);if(h<24)return h+'h ago';return Math.floor(h/24)+'d ago'}
function closeModal(){document.getElementById('modalOverlay').classList.remove('show')}
function showModal(h){document.getElementById('modalBox').innerHTML=h;document.getElementById('modalOverlay').classList.add('show')}
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function empty(icon,title,desc,btn,action){return`<div class="empty-state"><div class="es-icon">${icon}</div><h3>${title}</h3><p>${desc}</p>${btn?`<button class="btn btn-primary" onclick="${action}">${btn}</button>`:''}</div>`}

const PG={'competitors':{t:'ğŸ† Competitor Intelligence',s:'Real-time data from Google Places API â†’ Supabase'},'social-spy':{t:'ğŸ” Social Spy',s:'Monitor competitor social activity'},'insights':{t:'ğŸ§  Insights Engine',s:'Actionable intelligence from competitive data'},'content-studio':{t:'ğŸ¨ Content Studio',s:'Content ideas & pipeline'},'social-listeners':{t:'ğŸ“¡ Social Listeners',s:'Brand mention monitoring'},'engagers':{t:'ğŸ‘¥ Competitor Engagers',s:'People engaging with competitors â€” potential SeaSalt customers'},'web-intel':{t:'ğŸŒ Website Intelligence',s:'PageSpeed Â· SEO Â· Tech Stack Â· Products â€” scanned from live websites'},'products':{t:'ğŸ›’ Products & Prices',s:'Product groups Â· Market presence Â· Platform pricing Â· Price intelligence'},'ad-library':{t:'ğŸ“º Ad Library',s:'Competitor ads â€” powered by Meta Ad Library (public)'},'keyword-tracker':{t:'ğŸ”‘ Keyword Tracker',s:'SEO ranking intelligence'}};
function go(p,el){document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));if(el)el.classList.add('active');document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));const t=document.getElementById('page-'+p);if(t)t.classList.add('active');const c=PG[p]||{};document.getElementById('pageTitle').textContent=c.t||p;document.getElementById('pageSubtitle').textContent=c.s||''}

// DATA ARRAYS â€” filled from Supabase only
let COMP=[],INSIGHTS=[],IDEAS=[],SEO_KW=[],HASHTAGS=[],LISTEN_KW=[],MENTIONS=[],ADS=[],SOC_CONTENT=[],ENGAGERS=[],WEB_INTEL=[];

async function loadAll(){await Promise.allSettled([loadComp(),loadInsights(),loadIdeas(),loadSeoKw(),loadHashtags(),loadListenKw(),loadMentions(),loadAds(),loadSocContent(),loadEngagers(),loadWebIntel()]);document.getElementById('lastSync').textContent=new Date().toLocaleTimeString()}

async function q(table,opts={}){try{let query=db.from(table).select(opts.select||'*');if(opts.eq)for(const[k,v]of Object.entries(opts.eq))query=query.eq(k,v);if(opts.order)query=query.order(opts.order.col,{ascending:opts.order.asc??true});if(opts.limit)query=query.limit(opts.limit);const{data,error}=await query;if(error)throw error;return data||[];}catch(e){console.log(table+':',e.message);return[];}}

async function loadComp(){COMP=await q('competitor_profiles',{order:{col:'name',asc:true}});renderComp()}
async function loadInsights(){INSIGHTS=await q('intel_insights',{eq:{is_dismissed:false},order:{col:'created_at',asc:false},limit:50});renderInsights()}
async function loadIdeas(){IDEAS=await q('content_ideas',{order:{col:'created_at',asc:false},limit:50});renderIdeas()}
async function loadSeoKw(){SEO_KW=await q('keyword_rankings',{order:{col:'current_position',asc:true}});renderSeoKw()}
async function loadHashtags(){HASHTAGS=await q('hashtag_tracker',{order:{col:'hashtag',asc:true}});renderHash()}
async function loadListenKw(){LISTEN_KW=await q('listener_keywords',{eq:{is_active:true},order:{col:'keyword',asc:true}});renderListenKw()}
async function loadMentions(){MENTIONS=await q('brand_mentions',{order:{col:'found_at',asc:false},limit:30});renderMentions()}
async function loadAds(){ADS=await q('competitor_ads',{order:{col:'scraped_at',asc:false},limit:50});renderAds()}
async function loadSocContent(){SOC_CONTENT=await q('competitor_content',{order:{col:'scraped_at',asc:false},limit:30});renderSocContent()}

// RENDERERS
function renderComp(){
  const el=document.getElementById('compArea'),rc=document.getElementById('ratingChart'),rv=document.getElementById('reviewChart');
  document.getElementById('sCompCount').textContent=COMP.length||'0';
  if(!COMP.length){el.innerHTML=empty('ğŸ†','No Competitor Data','Click "Sync Live Data" to fetch from Google Places.','ğŸ”„ Run First Sync','syncCompetitors()');rc.innerHTML='';rv.innerHTML='';document.getElementById('sAvgRating').textContent='â€”';document.getElementById('sTotalReviews').textContent='â€”';return}
  const avg=(COMP.reduce((s,c)=>s+parseFloat(c.rating||0),0)/COMP.length).toFixed(1);document.getElementById('sAvgRating').textContent=avg;
  const tot=COMP.reduce((s,c)=>s+(c.total_reviews||0),0);document.getElementById('sTotalReviews').textContent=tot.toLocaleString();
  const ls=COMP.reduce((l,c)=>{const d=new Date(c.synced_at||0);return d>l?d:l},new Date(0));
  if(ls.getTime()>0){document.getElementById('sLastSync').textContent=timeAgo(ls);document.getElementById('sCompSub').textContent='All synced'}
  el.innerHTML=`<table class="data-table"><thead><tr><th></th><th>Competitor</th><th>Rating</th><th>Reviews</th><th>YT Subs</th><th>Score</th><th>Threat</th><th>Synced</th></tr></thead><tbody>${COMP.map(c=>`<tr><td><span class="comp-dot" style="background:${c.color||'#666'}"></span></td><td><div style="font-weight:600;color:var(--text-primary)">${esc(c.name)}</div><div style="font-size:11px;color:var(--text-muted)">${esc(c.website||c.url||'')}${c.youtube_url?` Â· <a href="${esc(c.youtube_url)}" target="_blank" style="color:var(--accent-red)">YT</a>`:''}</div></td><td>${c.rating?`<span class="stars">${'â˜…'.repeat(Math.round(c.rating))}</span> <b>${parseFloat(c.rating).toFixed(1)}</b>`:'â€”'}</td><td style="font-weight:600">${c.total_reviews?c.total_reviews.toLocaleString():'â€”'}</td><td>${c.youtube_subscribers?c.youtube_subscribers.toLocaleString():'â€”'}</td><td><b style="color:${(c.social_score||0)>=70?'var(--accent-red)':(c.social_score||0)>=40?'var(--accent-amber)':'var(--accent-emerald)'}">${c.social_score||0}</b><span style="font-size:10px;color:var(--text-muted)">/100</span></td><td><span class="badge ${c.threat_level==='critical'?'badge-red':c.threat_level==='high'?'badge-orange':c.threat_level==='medium'?'badge-amber':'badge-green'}">${(c.threat_level||'â€”').toUpperCase()}</span></td><td style="font-size:11px;color:var(--text-muted)">${timeAgo(c.synced_at)}</td></tr>`).join('')}</tbody></table>`;
  const mx=5;rc.innerHTML=COMP.slice(0,8).map(c=>`<div class="chart-bar" style="height:${(parseFloat(c.rating||0)/mx)*100}%;background:${c.color||'var(--accent-blue)'}"><span class="chart-bar-label">${c.code||''}<br>${parseFloat(c.rating||0).toFixed(1)}</span></div>`).join('');
  const mr=Math.max(...COMP.map(c=>c.total_reviews||0),1);rv.innerHTML=COMP.slice(0,8).map(c=>`<div class="chart-bar" style="height:${((c.total_reviews||0)/mr)*100}%;background:${c.color||'var(--accent-blue)'}"><span class="chart-bar-label">${c.code||''}<br>${c.total_reviews||0}</span></div>`).join('')}

function renderInsights(){
  document.getElementById('sOpp').textContent=INSIGHTS.filter(i=>i.type==='opportunity').length;document.getElementById('sThreat').textContent=INSIGHTS.filter(i=>i.type==='threat').length;document.getElementById('sTrend').textContent=INSIGHTS.filter(i=>i.type==='trend').length;document.getElementById('sAction').textContent=INSIGHTS.filter(i=>i.type==='action').length;
  const el=document.getElementById('insightsArea');if(!INSIGHTS.length){el.innerHTML=empty('ğŸ§ ','No Insights','Add insights from your competitive analysis.','â• Add Insight','openAddInsight()');return}
  el.innerHTML='<div style="display:flex;flex-direction:column;gap:12px">'+INSIGHTS.map(i=>`<div class="insight-card ${i.type}"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><div><span class="badge ${i.type==='opportunity'?'badge-green':i.type==='threat'?'badge-red':i.type==='trend'?'badge-blue':'badge-amber'}">${i.type==='opportunity'?'ğŸ’¡ Opportunity':i.type==='threat'?'âš ï¸ Threat':i.type==='trend'?'ğŸ“ˆ Trend':'âš¡ Action'}</span><h3 style="font-size:15px;font-weight:700;margin-top:6px">${esc(i.title)}</h3></div><span class="badge ${i.priority==='critical'?'badge-red':i.priority==='high'?'badge-orange':'badge-blue'}">${i.priority||'medium'}</span></div><p style="font-size:13px;color:var(--text-secondary);line-height:1.6;margin-bottom:10px">${esc(i.body||'')}</p><div style="display:flex;justify-content:space-between"><span style="font-size:11px;color:var(--text-muted)">${timeAgo(i.created_at)}</span><button class="btn btn-ghost btn-sm" style="padding:4px 10px;font-size:10px" onclick="dismissInsight(${i.id})">Dismiss</button></div></div>`).join('')+'</div>'}

function renderIdeas(){
  document.getElementById('sCiTotal').textContent=IDEAS.length;document.getElementById('sCiPlanned').textContent=IDEAS.filter(c=>c.status==='planned').length;document.getElementById('sCiPub').textContent=IDEAS.filter(c=>c.status==='published').length;
  const el=document.getElementById('ideasArea');if(!IDEAS.length){el.innerHTML=empty('ğŸ¨','No Content Ideas','Add ideas based on competitor gaps.','âœ¨ Add Idea','openAddIdea()');return}
  el.innerHTML=`<table class="data-table"><thead><tr><th>Title</th><th>Type</th><th>Platform</th><th>Status</th><th>Created</th></tr></thead><tbody>${IDEAS.map(c=>`<tr><td style="font-weight:600;color:var(--text-primary)">${esc(c.title)}</td><td><span class="badge badge-violet">${esc(c.content_type||'â€”')}</span></td><td><span class="badge badge-blue">${esc(c.platform||'â€”')}</span></td><td><span class="badge ${c.status==='published'?'badge-green':c.status==='planned'?'badge-amber':'badge-blue'}">${c.status||'idea'}</span></td><td style="font-size:11px;color:var(--text-muted)">${timeAgo(c.created_at)}</td></tr>`).join('')}</tbody></table>`}

function renderSeoKw(){
  document.getElementById('sKwCount').textContent=SEO_KW.length;const avg=SEO_KW.length?(SEO_KW.reduce((s,k)=>s+(k.current_position||0),0)/SEO_KW.length).toFixed(1):'â€”';document.getElementById('sKwAvg').textContent=avg;document.getElementById('sKwTop').textContent=SEO_KW.filter(k=>(k.current_position||99)<=10).length;
  const el=document.getElementById('kwArea');if(!SEO_KW.length){el.innerHTML=empty('ğŸ”‘','No Keywords','Track your SEO rankings.','â• Add Keyword','openAddSEOKW()');return}
  el.innerHTML=`<table class="data-table"><thead><tr><th>Keyword</th><th>Position</th><th>Change</th><th>Volume</th><th>Difficulty</th></tr></thead><tbody>${SEO_KW.map(k=>{const ch=k.change||0;return`<tr><td style="font-weight:600;color:var(--text-primary)">${esc(k.keyword)}</td><td><span style="font-size:18px;font-weight:800;color:${(k.current_position||99)<=5?'var(--accent-emerald)':(k.current_position||99)<=15?'var(--accent-amber)':'var(--accent-red)'}">#${k.current_position||'â€”'}</span></td><td><span class="stat-change ${ch>0?'up':ch<0?'down':''}" style="font-size:13px;font-weight:700">${ch>0?'â†‘'+ch:ch<0?'â†“'+Math.abs(ch):'â€”'}</span></td><td>${esc(k.search_volume||'â€”')}</td><td><span class="badge ${k.difficulty==='Low'?'badge-green':k.difficulty==='High'?'badge-red':'badge-amber'}">${k.difficulty||'â€”'}</span></td></tr>`}).join('')}</tbody></table>`}

function renderHash(){
  document.getElementById('sSocHash').textContent=HASHTAGS.length;const el=document.getElementById('hashArea');
  if(!HASHTAGS.length){el.innerHTML='<div class="empty-state" style="padding:30px"><p>Add hashtags to track</p></div>';return}
  el.innerHTML=`<table class="data-table"><thead><tr><th>Hashtag</th><th>Posts</th><th>Engagement</th><th>Growth</th><th>Trend</th></tr></thead><tbody>${HASHTAGS.map(h=>`<tr><td style="font-weight:700;color:var(--accent-blue)">${esc(h.hashtag)}</td><td>${esc(h.total_posts||'â€”')}</td><td>${esc(h.avg_engagement||'â€”')}</td><td>${esc(h.growth_rate||'â€”')}</td><td>${h.trend==='up'?'ğŸ“ˆ':'â¡ï¸'}</td></tr>`).join('')}</tbody></table>`}

function renderListenKw(){
  document.getElementById('sLkCount').textContent=LISTEN_KW.length;const el=document.getElementById('lkArea');
  if(!LISTEN_KW.length){el.innerHTML='<div class="empty-state" style="padding:30px"><p>Add keywords to monitor</p></div>';return}
  el.innerHTML=LISTEN_KW.map(k=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border-subtle)"><div><div style="font-size:13px;font-weight:600;color:var(--text-primary)">"${esc(k.keyword)}"</div><div style="font-size:11px;color:var(--text-muted)">${(k.platforms||[]).join(', ')}</div></div><span style="font-size:12px;font-weight:700">${k.total_mentions||0} mentions</span></div>`).join('')}

function renderMentions(){
  document.getElementById('sLkMentions').textContent=MENTIONS.length;const el=document.getElementById('mentionArea');
  if(!MENTIONS.length){el.innerHTML='<div class="empty-state" style="padding:30px"><p>Log mentions as you find them</p></div>';return}
  el.innerHTML=MENTIONS.slice(0,10).map(m=>`<div style="padding:10px 0;border-bottom:1px solid var(--border-subtle)"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><div style="display:flex;gap:6px"><span class="badge badge-blue" style="font-size:9px">${esc(m.source_platform)}</span><span style="font-size:12px;font-weight:600">${esc(m.author||'')}</span></div><span style="font-size:10px;color:var(--text-muted)">${timeAgo(m.found_at)}</span></div><p style="font-size:12px;color:var(--text-secondary);line-height:1.5">"${esc(m.content||'')}"</p></div>`).join('')}

function renderAds(){
  document.getElementById('sAdCount').textContent=ADS.length;document.getElementById('sAdActive').textContent=ADS.filter(a=>a.status==='active').length;
  const el=document.getElementById('adArea');if(!ADS.length){el.innerHTML=empty('ğŸ“º','No Ads Tracked','Scan Meta Ad Library or log ads manually.','ğŸ” Open Meta Ads','scanMetaAds()');return}
  el.innerHTML=`<table class="data-table"><thead><tr><th>Competitor</th><th>Platform</th><th>Type</th><th>Description</th><th>Status</th><th>Est Spend</th><th>Found</th></tr></thead><tbody>${ADS.map(a=>`<tr><td style="font-weight:600">${esc(a.competitor_name)}</td><td><span class="badge badge-blue">${esc(a.platform)}</span></td><td>${esc(a.ad_type||'â€”')}</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(a.headline||a.description||'â€”')}</td><td><span class="badge ${a.status==='active'?'badge-green':'badge-amber'}">${a.status||'â€”'}</span></td><td style="font-weight:600;color:var(--accent-amber)">${esc(a.estimated_spend||'â€”')}</td><td style="font-size:11px;color:var(--text-muted)">${timeAgo(a.scraped_at)}</td></tr>`).join('')}</tbody></table>`}

function renderSocContent(){
  const ws=COMP.filter(c=>c.instagram_url||c.youtube_url||c.facebook_url);document.getElementById('sSocial').textContent=ws.length;document.getElementById('sSocContent').textContent=SOC_CONTENT.length;
  const sp=document.getElementById('socProfiles');
  if(!ws.length)sp.innerHTML='<div class="empty-state" style="padding:30px"><p>Add social URLs to competitor profiles</p></div>';
  else sp.innerHTML=ws.map(c=>`<div class="social-profile"><div class="social-avatar" style="background:${c.color}20;color:${c.color}">${c.code}</div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:var(--text-primary)">${esc(c.name)}</div><div style="font-size:11px;color:var(--text-muted)">${c.instagram_url?'ğŸ“¸ IG ':''}${c.youtube_url?'ğŸ“¹ YT ':''}${c.facebook_url?'ğŸ“˜ FB':''}</div></div>${c.instagram_followers?`<div style="font-size:12px;font-weight:700">${c.instagram_followers.toLocaleString()}</div>`:''}</div>`).join('');
  const sc=document.getElementById('socPosts');
  if(!SOC_CONTENT.length)sc.innerHTML='<div class="empty-state" style="padding:30px"><p>Log competitor posts</p></div>';
  else sc.innerHTML=SOC_CONTENT.slice(0,8).map(p=>`<div class="social-profile"><div style="flex:1"><div style="font-size:13px;font-weight:600;color:var(--text-primary)">${esc(p.caption||p.post_type||'Post')}</div><div style="font-size:11px;color:var(--text-muted)">${esc(p.competitor_name)} Â· ${esc(p.platform)}</div></div>${p.likes?`<div style="font-size:12px;font-weight:700;color:var(--accent-pink)">â™¥ ${p.likes.toLocaleString()}</div>`:''}</div>`).join('')}

// SYNC
async function syncCompetitors(){const b=document.getElementById('btnSync');b.disabled=true;b.innerHTML='<span class="spinner"></span> Syncing...';toast('ğŸ”„ Calling Google Places API...');try{const r=await fetch('/.netlify/functions/intel-sync');const d=await r.json();if(d.error){toast('âŒ '+d.error)}else{toast('âœ… '+d.success+'/'+d.total+' synced');await loadComp()}document.getElementById('lastSync').textContent=new Date().toLocaleTimeString()}catch(e){toast('âŒ '+e.message)}b.disabled=false;b.innerHTML='ğŸ”„ Sync Live Data'}
async function syncAll(){const b=document.getElementById('btnSyncAll');b.disabled=true;b.innerHTML='<span class="spinner"></span>';toast('ğŸ”„ Full sync...');try{await fetch('/.netlify/functions/intel-sync');await loadAll();toast('âœ… All refreshed')}catch(e){toast('âš ï¸ '+e.message)}b.disabled=false;b.innerHTML='ğŸ“Š Sync All'}

// META AD LIBRARY â€” opens public Facebook Ad Library
function scanMetaAds(){const c=COMP.length?COMP:[{name:'Vellanki Foods'},{name:'Priya Pickles'},{name:'Aavarampoo Pickles'}];showModal(`<div class="modal-title">ğŸ” Meta Ad Library</div><p style="font-size:12px;color:var(--text-muted);margin-bottom:16px">Meta's Ad Library is <b>100% public</b> at facebook.com/ads/library. Click each competitor below to search their active ads, then log what you find.</p><div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">${c.map(x=>`<a href="https://www.facebook.com/ads/library/?active_status=active&ad_type=all&country=IN&q=${encodeURIComponent(x.name)}" target="_blank" style="text-decoration:none"><div class="social-profile" style="border:1px solid var(--border-subtle);border-radius:8px"><div style="flex:1"><div style="font-size:13px;font-weight:600;color:var(--text-primary)">${esc(x.name)}</div><div style="font-size:11px;color:var(--accent-blue)">Search in Meta Ad Library â†’</div></div></div></a>`).join('')}</div><button class="btn btn-orange" onclick="closeModal();openLogAd()">ğŸ“ Log an Ad</button> <button class="btn btn-ghost" style="margin-left:8px" onclick="closeModal()">Close</button>`)}

// CRUD â€” all write to Supabase
async function dbInsert(table,row){try{const{error}=await db.from(table).insert(row);if(error)throw error;return true}catch(e){toast('âŒ '+e.message);return false}}

function openAddCompetitor(){showModal(`<div class="modal-title">â• Add Competitor</div><div class="field-group"><label class="field-label">Name *</label><input class="intel-input" id="f1" placeholder="Business name"></div><div class="field-group"><label class="field-label">Code (2-4 letters) *</label><input class="intel-input" id="f2" maxlength="4" placeholder="e.g. VF"></div><div class="field-group"><label class="field-label">Website</label><input class="intel-input" id="f3" placeholder="domain.com"></div><div class="field-group"><label class="field-label">Google Search Query</label><input class="intel-input" id="f4" placeholder="Business Name City"></div><div class="field-group"><label class="field-label">Threat Level</label><select class="intel-input" id="f5"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></div><div class="field-group"><label class="field-label">Color</label><input class="intel-input" type="color" id="f6" value="#ef4444" style="height:40px;padding:4px"></div><div style="display:flex;gap:10px;margin-top:12px"><button class="btn btn-primary" onclick="saveComp()">Add</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`)}
async function saveComp(){const n=document.getElementById('f1').value.trim(),c=document.getElementById('f2').value.trim().toUpperCase();if(!n||!c){toast('âŒ Name & Code required');return}if(await dbInsert('competitor_profiles',{name:n,code:c,url:document.getElementById('f3').value.trim(),search_query:document.getElementById('f4').value.trim(),threat_level:document.getElementById('f5').value,color:document.getElementById('f6').value})){toast('âœ… '+n+' added!');closeModal();await loadComp()}}

function openAddInsight(){showModal(`<div class="modal-title">â• Add Insight</div><div class="field-group"><label class="field-label">Type *</label><select class="intel-input" id="i1"><option value="opportunity">ğŸ’¡ Opportunity</option><option value="threat">âš ï¸ Threat</option><option value="trend">ğŸ“ˆ Trend</option><option value="action">âš¡ Action</option></select></div><div class="field-group"><label class="field-label">Title *</label><input class="intel-input" id="i2" placeholder="What's the insight?"></div><div class="field-group"><label class="field-label">Details</label><textarea class="intel-input" id="i3" placeholder="Context and analysis..."></textarea></div><div class="field-group"><label class="field-label">Priority</label><select class="intel-input" id="i4"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option><option value="critical">Critical</option></select></div><div style="display:flex;gap:10px;margin-top:8px"><button class="btn btn-emerald" onclick="saveInsight()">Save</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`)}
async function saveInsight(){const t=document.getElementById('i2').value.trim();if(!t){toast('âŒ Title required');return}if(await dbInsert('intel_insights',{type:document.getElementById('i1').value,title:t,body:document.getElementById('i3').value.trim(),priority:document.getElementById('i4').value})){toast('âœ… Saved!');closeModal();await loadInsights()}}
async function dismissInsight(id){try{await db.from('intel_insights').update({is_dismissed:true}).eq('id',id);toast('Dismissed');await loadInsights()}catch(e){toast('âŒ '+e.message)}}

function openAddIdea(){showModal(`<div class="modal-title">âœ¨ Content Idea</div><div class="field-group"><label class="field-label">Title *</label><input class="intel-input" id="c1" placeholder="Idea title"></div><div class="field-group"><label class="field-label">Description</label><textarea class="intel-input" id="c2" placeholder="Concept details"></textarea></div><div class="field-group"><label class="field-label">Type</label><input class="intel-input" id="c3" placeholder="Reel, Carousel, Blog..."></div><div class="field-group"><label class="field-label">Platform</label><select class="intel-input" id="c4"><option>Instagram</option><option>YouTube</option><option>Facebook</option><option>Website</option></select></div><div class="field-group"><label class="field-label">Status</label><select class="intel-input" id="c5"><option value="idea">Idea</option><option value="planned">Planned</option><option value="in_progress">In Progress</option><option value="published">Published</option></select></div><div style="display:flex;gap:10px;margin-top:8px"><button class="btn btn-orange" onclick="saveIdea()">Save</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`)}
async function saveIdea(){const t=document.getElementById('c1').value.trim();if(!t){toast('âŒ Title required');return}if(await dbInsert('content_ideas',{title:t,description:document.getElementById('c2').value.trim(),content_type:document.getElementById('c3').value.trim(),platform:document.getElementById('c4').value,status:document.getElementById('c5').value})){toast('âœ… Saved!');closeModal();await loadIdeas()}}

function openAddSEOKW(){showModal(`<div class="modal-title">â• SEO Keyword</div><div class="field-group"><label class="field-label">Keyword *</label><input class="intel-input" id="k1" placeholder="e.g. buy avakaya pickle online"></div><div class="field-group"><label class="field-label">Current Position</label><input class="intel-input" type="number" id="k2" placeholder="e.g. 12"></div><div class="field-group"><label class="field-label">Search Volume</label><input class="intel-input" id="k3" placeholder="e.g. 1.2K"></div><div class="field-group"><label class="field-label">Difficulty</label><select class="intel-input" id="k4"><option>Low</option><option selected>Medium</option><option>High</option></select></div><div class="field-group"><label class="field-label">Target URL</label><input class="intel-input" id="k5" placeholder="/products"></div><div style="display:flex;gap:10px;margin-top:8px"><button class="btn btn-emerald" onclick="saveSeoKw()">Add</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`)}
async function saveSeoKw(){const w=document.getElementById('k1').value.trim();if(!w){toast('âŒ Keyword required');return}if(await dbInsert('keyword_rankings',{keyword:w,current_position:parseInt(document.getElementById('k2').value)||0,search_volume:document.getElementById('k3').value.trim(),difficulty:document.getElementById('k4').value,target_url:document.getElementById('k5').value.trim()})){toast('âœ… Added!');closeModal();await loadSeoKw()}}

function openAddHashtag(){showModal(`<div class="modal-title">ğŸ·ï¸ Add Hashtag</div><div class="field-group"><label class="field-label">Hashtag *</label><input class="intel-input" id="h1" placeholder="#AndhraPickles"></div><div class="field-group"><label class="field-label">Total Posts</label><input class="intel-input" id="h2" placeholder="e.g. 12.4K"></div><div class="field-group"><label class="field-label">Avg Engagement</label><input class="intel-input" id="h3" placeholder="e.g. 4.2%"></div><div style="display:flex;gap:10px;margin-top:8px"><button class="btn btn-blue" onclick="saveHash()">Add</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`)}
async function saveHash(){let h=document.getElementById('h1').value.trim();if(!h){toast('âŒ Required');return}if(!h.startsWith('#'))h='#'+h;if(await dbInsert('hashtag_tracker',{hashtag:h,total_posts:document.getElementById('h2').value.trim(),avg_engagement:document.getElementById('h3').value.trim()})){toast('âœ… Added!');closeModal();await loadHashtags()}}

function openAddListenKW(){showModal(`<div class="modal-title">â• Monitor Keyword</div><div class="field-group"><label class="field-label">Keyword *</label><input class="intel-input" id="l1" placeholder="e.g. seasalt pickles"></div><div class="field-group"><label class="field-label">Platforms</label><div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:4px"><label style="font-size:12px;color:var(--text-secondary);display:flex;gap:4px"><input type="checkbox" class="lPlat" value="instagram" checked> Instagram</label><label style="font-size:12px;color:var(--text-secondary);display:flex;gap:4px"><input type="checkbox" class="lPlat" value="twitter" checked> Twitter</label><label style="font-size:12px;color:var(--text-secondary);display:flex;gap:4px"><input type="checkbox" class="lPlat" value="google" checked> Google</label><label style="font-size:12px;color:var(--text-secondary);display:flex;gap:4px"><input type="checkbox" class="lPlat" value="youtube"> YouTube</label></div></div><div style="display:flex;gap:10px;margin-top:12px"><button class="btn btn-emerald" onclick="saveListenKW()">Start Monitoring</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`)}
async function saveListenKW(){const w=document.getElementById('l1').value.trim();if(!w){toast('âŒ Required');return}const p=[...document.querySelectorAll('.lPlat:checked')].map(c=>c.value);if(await dbInsert('listener_keywords',{keyword:w,platforms:p})){toast('âœ… Monitoring "'+w+'"');closeModal();await loadListenKw()}}

function openLogMention(){showModal(`<div class="modal-title">ğŸ“ Log Mention</div><div class="field-group"><label class="field-label">Platform *</label><select class="intel-input" id="m1"><option>Instagram</option><option>Twitter</option><option>Google</option><option>Facebook</option><option>YouTube</option><option>Reddit</option></select></div><div class="field-group"><label class="field-label">Author</label><input class="intel-input" id="m2" placeholder="@username"></div><div class="field-group"><label class="field-label">Content *</label><textarea class="intel-input" id="m3" placeholder="What was said?"></textarea></div><div class="field-group"><label class="field-label">Sentiment</label><select class="intel-input" id="m4"><option value="positive">Positive</option><option value="neutral" selected>Neutral</option><option value="negative">Negative</option></select></div><div style="display:flex;gap:10px;margin-top:8px"><button class="btn btn-blue" onclick="saveMention()">Log</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`)}
async function saveMention(){const c=document.getElementById('m3').value.trim();if(!c){toast('âŒ Content required');return}if(await dbInsert('brand_mentions',{source_platform:document.getElementById('m1').value,author:document.getElementById('m2').value.trim(),content:c,sentiment:document.getElementById('m4').value})){toast('âœ… Logged!');closeModal();await loadMentions()}}

function openLogAd(){showModal(`<div class="modal-title">ğŸ“ Log Ad</div><div class="field-group"><label class="field-label">Competitor *</label><select class="intel-input" id="a1">${COMP.length?COMP.map(c=>`<option value="${esc(c.name)}" data-code="${c.code}">${esc(c.name)}</option>`).join(''):'<option>Load competitors first</option>'}</select></div><div class="field-group"><label class="field-label">Platform *</label><select class="intel-input" id="a2"><option>Meta/Facebook</option><option>Instagram</option><option>Google Ads</option><option>YouTube</option></select></div><div class="field-group"><label class="field-label">Ad Type</label><select class="intel-input" id="a3"><option>Image Ad</option><option>Video Ad</option><option>Carousel</option><option>Story Ad</option><option>Search Ad</option></select></div><div class="field-group"><label class="field-label">Headline *</label><input class="intel-input" id="a4" placeholder="What does the ad say?"></div><div class="field-group"><label class="field-label">Est Monthly Spend</label><input class="intel-input" id="a5" placeholder="e.g. â‚¹10K"></div><div class="field-group"><label class="field-label">Status</label><select class="intel-input" id="a6"><option value="active">Active</option><option value="paused">Paused</option></select></div><div style="display:flex;gap:10px;margin-top:8px"><button class="btn btn-orange" onclick="saveAd()">Log Ad</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`)}
async function saveAd(){const h=document.getElementById('a4').value.trim();if(!h){toast('âŒ Headline required');return}const sel=document.getElementById('a1');if(await dbInsert('competitor_ads',{competitor_name:sel.value,competitor_code:sel.selectedOptions[0]?.dataset?.code||'',platform:document.getElementById('a2').value,ad_type:document.getElementById('a3').value,headline:h,estimated_spend:document.getElementById('a5').value.trim(),status:document.getElementById('a6').value})){toast('âœ… Ad logged!');closeModal();await loadAds()}}

function openAddSocial(){showModal(`<div class="modal-title">â• Social URLs</div><p style="font-size:12px;color:var(--text-muted);margin-bottom:16px">Add social URLs to a competitor profile</p><div class="field-group"><label class="field-label">Competitor</label><select class="intel-input" id="s1">${COMP.map(c=>`<option value="${c.code}">${esc(c.name)}</option>`).join('')}</select></div><div class="field-group"><label class="field-label">Instagram URL</label><input class="intel-input" id="s2" placeholder="https://instagram.com/..."></div><div class="field-group"><label class="field-label">IG Followers</label><input class="intel-input" type="number" id="s3" placeholder="5000"></div><div class="field-group"><label class="field-label">YouTube URL</label><input class="intel-input" id="s4" placeholder="https://youtube.com/..."></div><div class="field-group"><label class="field-label">Facebook URL</label><input class="intel-input" id="s5" placeholder="https://facebook.com/..."></div><div style="display:flex;gap:10px;margin-top:8px"><button class="btn btn-violet" onclick="saveSocial()">Update</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`)}
async function saveSocial(){const code=document.getElementById('s1').value,u={};const ig=document.getElementById('s2').value.trim();if(ig)u.instagram_url=ig;const f=parseInt(document.getElementById('s3').value);if(f)u.instagram_followers=f;const yt=document.getElementById('s4').value.trim();if(yt)u.youtube_url=yt;const fb=document.getElementById('s5').value.trim();if(fb)u.facebook_url=fb;if(!Object.keys(u).length){toast('âŒ Add at least one URL');return}try{const{error}=await db.from('competitor_profiles').update(u).eq('code',code);if(error)throw error;toast('âœ… Updated!');closeModal();await loadComp();renderSocContent()}catch(e){toast('âŒ '+e.message)}}

function openLogPost(){showModal(`<div class="modal-title">ğŸ“ Log Post</div><div class="field-group"><label class="field-label">Competitor</label><select class="intel-input" id="p1">${COMP.map(c=>`<option value="${esc(c.name)}" data-code="${c.code}">${esc(c.name)}</option>`).join('')}</select></div><div class="field-group"><label class="field-label">Platform</label><select class="intel-input" id="p2"><option>Instagram</option><option>YouTube</option><option>Facebook</option></select></div><div class="field-group"><label class="field-label">Type</label><input class="intel-input" id="p3" placeholder="Reel, Carousel, Story..."></div><div class="field-group"><label class="field-label">Caption</label><textarea class="intel-input" id="p4" placeholder="Post description"></textarea></div><div class="field-group"><label class="field-label">Likes</label><input class="intel-input" type="number" id="p5" placeholder="5000"></div><div style="display:flex;gap:10px;margin-top:8px"><button class="btn btn-violet" onclick="savePost()">Log</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`)}
async function savePost(){const sel=document.getElementById('p1');if(await dbInsert('competitor_content',{competitor_name:sel.value,competitor_code:sel.selectedOptions[0]?.dataset?.code||'',platform:document.getElementById('p2').value,post_type:document.getElementById('p3').value.trim(),caption:document.getElementById('p4').value.trim(),likes:parseInt(document.getElementById('p5').value)||0})){toast('âœ… Logged!');closeModal();await loadSocContent()}}

async function loadEngagers(){ENGAGERS=await q('competitor_engagers',{order:{col:'scraped_at',asc:false},limit:500});renderEngagers()}

function renderEngagers(filter='all',compFilter=''){
  const el=document.getElementById('engagersArea');
  let filtered=ENGAGERS;
  if(filter==='negative')filtered=filtered.filter(e=>e.sentiment==='negative');
  else if(filter==='positive')filtered=filtered.filter(e=>e.sentiment==='positive');
  else if(filter==='google_reviews')filtered=filtered.filter(e=>e.platform==='google_reviews');
  else if(filter==='youtube')filtered=filtered.filter(e=>e.platform==='youtube');
  if(compFilter)filtered=filtered.filter(e=>e.competitor_code===compFilter);

  // Stats
  document.getElementById('sEngTotal').textContent=ENGAGERS.length;
  document.getElementById('sEngPos').textContent=ENGAGERS.filter(e=>e.sentiment==='positive').length;
  document.getElementById('sEngNeg').textContent=ENGAGERS.filter(e=>e.sentiment==='negative').length;
  const platforms=[...new Set(ENGAGERS.map(e=>e.platform))];
  document.getElementById('sEngPlat').textContent=platforms.length;
  document.getElementById('engShowing').textContent=`Showing ${filtered.length} of ${ENGAGERS.length}`;

  // Populate competitor filter dropdown
  const compSelect=document.getElementById('engCompFilter');
  if(compSelect.options.length<=1&&COMP.length){
    COMP.forEach(c=>{const o=document.createElement('option');o.value=c.code;o.textContent=c.name;compSelect.appendChild(o)});
  }

  if(!filtered.length){el.innerHTML=empty('ğŸ‘¥','No Engagers Yet','Run Deep Sync to capture people reviewing and commenting on competitor brands.','ğŸ”„ Run Deep Sync','syncCompetitors()');return}

  let html='<table class="data-table"><thead><tr><th>Person</th><th>Competitor</th><th>Platform</th><th>Sentiment</th><th>Content</th><th>Link</th></tr></thead><tbody>';
  for(const e of filtered.slice(0,200)){
    const sentBadge=e.sentiment==='positive'?'badge-green':e.sentiment==='negative'?'badge-red':'badge-blue';
    const platIcon=e.platform==='youtube'?'ğŸ“º':'ğŸ“';
    const profileLink=e.profile_url?`<a href="${esc(e.profile_url)}" target="_blank" style="color:var(--accent-blue);text-decoration:none">${esc(e.person_name)}</a>`:esc(e.person_name);
    const contentSnip=e.content?esc(e.content.substring(0,80))+(e.content.length>80?'...':''):'â€”';
    const contentLink=e.content_url?`<a href="${esc(e.content_url)}" target="_blank" style="color:var(--accent-blue);font-size:11px">View â†’</a>`:'â€”';
    html+=`<tr>
      <td style="display:flex;align-items:center;gap:8px">${e.profile_photo?`<img src="${esc(e.profile_photo)}" style="width:28px;height:28px;border-radius:50%;object-fit:cover">`:`<div style="width:28px;height:28px;border-radius:50%;background:var(--bg-elevated);display:flex;align-items:center;justify-content:center;font-size:12px">ğŸ‘¤</div>`}<div>${profileLink}${e.rating?` <span class="stars">${'â˜…'.repeat(e.rating)}${'â˜†'.repeat(5-e.rating)}</span>`:''}</div></td>
      <td><span style="font-size:12px">${esc(e.competitor_name||'')}</span></td>
      <td>${platIcon} ${e.platform==='youtube'?'YouTube':'Google'}</td>
      <td><span class="badge ${sentBadge}">${e.sentiment||'neutral'}</span></td>
      <td style="max-width:300px;font-size:12px;color:var(--text-muted)">${contentSnip}</td>
      <td>${contentLink}</td>
    </tr>`;
  }
  html+='</tbody></table>';
  if(filtered.length>200)html+=`<p style="text-align:center;padding:12px;font-size:12px;color:var(--text-muted)">Showing 200 of ${filtered.length} â€” filter to see specific groups</p>`;
  el.innerHTML=html;
}

function filterEngagers(filter){
  document.querySelectorAll('.eng-filter-active').forEach(b=>b.classList.remove('eng-filter-active'));
  const compFilter=document.getElementById('engCompFilter')?.value||'';
  renderEngagers(filter,compFilter);
}

function exportData(){toast('ğŸ“¥ Use Supabase Dashboard â†’ Table Editor â†’ Export CSV')}

// â•â•â•â•â•â•â• WEBSITE INTELLIGENCE â•â•â•â•â•â•â•
async function loadWebIntel(){WEB_INTEL=await q('website_intelligence',{order:{col:'site_score',asc:false}});renderWebIntel();renderProducts()}

async function syncWebIntel(site){
  const b=document.getElementById('btnWebSync');b.disabled=true;b.innerHTML='<span class="spinner"></span> Scanning...';
  toast('ğŸŒ Scanning websites â€” this takes 3-5 minutes...');
  try{
    let url='/.netlify/functions/web-intel';
    if(site)url+='?site='+encodeURIComponent(site);
    const r=await fetch(url);const d=await r.json();
    if(d.error){toast('âŒ '+d.error)}
    else{toast('âœ… '+d.total_sites+' websites scanned');await loadWebIntel()}
  }catch(e){toast('âŒ '+e.message)}
  b.disabled=false;b.innerHTML='ğŸŒ Scan All Websites';
}

function renderWebIntel(){
  const self=WEB_INTEL.find(w=>w.is_self);
  const comps=WEB_INTEL.filter(w=>!w.is_self);

  document.getElementById('sWiCount').textContent=WEB_INTEL.length;
  document.getElementById('sWiSS').textContent=self?self.site_score+'/100':'â€”';
  if(self&&comps.length){
    const rank=comps.filter(c=>c.site_score>self.site_score).length+1;
    document.getElementById('sWiRank').textContent='Rank #'+rank+' of '+(comps.length+1);
  }
  const avgComp=comps.length?Math.round(comps.reduce((s,c)=>s+c.site_score,0)/comps.length):0;
  document.getElementById('sWiAvg').textContent=avgComp+'/100';
  const topThreat=comps.sort((a,b)=>b.site_score-a.site_score)[0];
  document.getElementById('sWiThreat').textContent=topThreat?topThreat.name+' ('+topThreat.site_score+')':'â€”';

  // Score chart
  const chart=document.getElementById('siteScoreChart');
  if(!WEB_INTEL.length){chart.innerHTML='';document.getElementById('wiTableArea').innerHTML=empty('ğŸŒ','No Website Data','Click "Scan All Websites" to analyze competitor sites.','ğŸŒ Run First Scan','syncWebIntel()');return}
  chart.innerHTML=WEB_INTEL.map(w=>`<div class="chart-bar" style="height:${w.site_score}%;background:${w.is_self?'var(--accent-red)':w.color||'var(--accent-blue)'};opacity:${w.is_self?1:0.7}"><span class="chart-bar-label">${w.code}<br><b>${w.site_score}</b></span></div>`).join('');

  // Table
  let tbl=`<table class="data-table"><thead><tr><th>Brand</th><th>Score</th><th>Perf</th><th>SEO</th><th>Products</th><th>Price Range</th><th>E-com</th><th>Tech Stack</th><th>Scanned</th></tr></thead><tbody>`;
  for(const w of WEB_INTEL){
    const ts=safeJSON(w.tech_stack);
    const scoreColor=w.site_score>=60?'var(--accent-emerald)':w.site_score>=35?'var(--accent-amber)':'var(--accent-red)';
    tbl+=`<tr style="${w.is_self?'background:rgba(220,38,38,.04)':''}">
      <td><div style="display:flex;align-items:center;gap:8px"><span class="comp-dot" style="background:${w.color||'#666'}"></span><div><div style="font-weight:600;color:var(--text-primary)">${esc(w.name)}${w.is_self?' ğŸ”±':''}</div><div style="font-size:11px;color:var(--text-muted)">${esc(w.url)}</div></div></div></td>
      <td><b style="font-size:18px;color:${scoreColor}">${w.site_score}</b><span style="font-size:10px;color:var(--text-muted)">/100</span></td>
      <td><span class="badge ${w.performance_score>=60?'badge-green':w.performance_score>=30?'badge-amber':'badge-red'}">${w.performance_score||0}</span></td>
      <td><span class="badge ${w.seo_score>=70?'badge-green':w.seo_score>=40?'badge-amber':'badge-red'}">${w.seo_score||0}</span></td>
      <td style="font-weight:600">${w.product_count||0}</td>
      <td>${w.price_min&&w.price_max?'â‚¹'+Math.round(w.price_min)+' â€” â‚¹'+Math.round(w.price_max):'â€”'}</td>
      <td>${w.has_ecommerce?'<span class="badge badge-green">Yes</span>':'<span class="badge badge-red">No</span>'}</td>
      <td style="font-size:11px">${ts.length?ts.slice(0,3).join(', ')+(ts.length>3?' +'.concat(ts.length-3):''):'â€”'}</td>
      <td style="font-size:11px;color:var(--text-muted)">${timeAgo(w.scanned_at)}</td>
    </tr>`;
  }
  tbl+='</tbody></table>';
  document.getElementById('wiTableArea').innerHTML=tbl;

  // Tech stack comparison
  const techMap={};
  WEB_INTEL.forEach(w=>{const ts=safeJSON(w.tech_stack);ts.forEach(t=>{if(!techMap[t])techMap[t]=[];techMap[t].push(w.code)})});
  let techHtml='<div style="display:flex;flex-direction:column;gap:8px;padding:8px 0">';
  for(const[tech,codes]of Object.entries(techMap).sort((a,b)=>b[1].length-a[1].length)){
    techHtml+=`<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border-subtle)"><div style="font-size:13px;font-weight:600">${esc(tech)}</div><div style="display:flex;gap:4px">${codes.map(c=>`<span class="badge badge-blue" style="font-size:9px">${c}</span>`).join('')}</div></div>`;
  }
  techHtml+='</div>';
  document.getElementById('wiTechArea').innerHTML=Object.keys(techMap).length?techHtml:'<div class="empty-state" style="padding:20px"><p>Run scan to detect tech stacks</p></div>';

  // Feature checklist
  const features=['has_ecommerce','has_blog','has_whatsapp','has_ssl','has_structured_data','is_mobile_friendly'];
  const fLabels={'has_ecommerce':'ğŸ›’ E-commerce','has_blog':'ğŸ“ Blog','has_whatsapp':'ğŸ’¬ WhatsApp','has_ssl':'ğŸ”’ SSL','has_structured_data':'ğŸ“Š Schema','is_mobile_friendly':'ğŸ“± Mobile'};
  let fHtml='<table class="data-table"><thead><tr><th>Feature</th>';
  WEB_INTEL.slice(0,6).forEach(w=>{fHtml+=`<th style="text-align:center;font-size:9px">${w.code}</th>`});
  fHtml+='</tr></thead><tbody>';
  features.forEach(f=>{
    fHtml+=`<tr><td style="font-size:12px">${fLabels[f]||f}</td>`;
    WEB_INTEL.slice(0,6).forEach(w=>{fHtml+=`<td style="text-align:center">${w[f]?'âœ…':'âŒ'}</td>`});
    fHtml+='</tr>';
  });
  fHtml+='</tbody></table>';
  document.getElementById('wiFeatureArea').innerHTML=fHtml;
}

// â•â•â•â•â•â•â• PRODUCTS & PRICES â•â•â•â•â•â•â•
// â•â•â•â•â•â•â• MARKET PRESENCE DATA (editable â€” stored in localStorage for now) â•â•â•â•â•â•â•
const DEFAULT_PRESENCE = {
  'SS': { website: true, swiggy: false, zomato: false, amazon: false, flipkart: false, bigbasket: false, jiomart: false, blinkit: false, instagram_shop: true, whatsapp: true },
  'VF': { website: true, swiggy: true, zomato: false, amazon: true, flipkart: true, bigbasket: false, jiomart: false, blinkit: false, instagram_shop: true, whatsapp: true },
  'PP': { website: true, swiggy: false, zomato: false, amazon: true, flipkart: true, bigbasket: true, jiomart: true, blinkit: false, instagram_shop: false, whatsapp: false },
  'SP': { website: true, swiggy: false, zomato: false, amazon: false, flipkart: false, bigbasket: false, jiomart: false, blinkit: false, instagram_shop: true, whatsapp: true },
  'FH': { website: true, swiggy: false, zomato: false, amazon: false, flipkart: false, bigbasket: false, jiomart: false, blinkit: false, instagram_shop: true, whatsapp: true },
  'JF': { website: true, swiggy: false, zomato: false, amazon: false, flipkart: false, bigbasket: false, jiomart: false, blinkit: false, instagram_shop: true, whatsapp: true },
  'JD': { website: true, swiggy: true, zomato: true, amazon: false, flipkart: false, bigbasket: false, jiomart: false, blinkit: false, instagram_shop: true, whatsapp: true },
  'NF': { website: true, swiggy: false, zomato: false, amazon: true, flipkart: false, bigbasket: false, jiomart: false, blinkit: false, instagram_shop: true, whatsapp: true },
  'SG': { website: true, swiggy: false, zomato: false, amazon: false, flipkart: false, bigbasket: false, jiomart: false, blinkit: false, instagram_shop: false, whatsapp: true },
  'AM': { website: true, swiggy: false, zomato: false, amazon: true, flipkart: false, bigbasket: false, jiomart: false, blinkit: false, instagram_shop: false, whatsapp: true },
  'KF': { website: true, swiggy: false, zomato: false, amazon: false, flipkart: false, bigbasket: false, jiomart: false, blinkit: false, instagram_shop: true, whatsapp: true }
};

const PLATFORM_META = {
  website: { icon: 'ğŸŒ', label: 'Own Website', color: '#2563eb' },
  swiggy: { icon: 'ğŸŸ ', label: 'Swiggy Instamart', color: '#fc8019' },
  zomato: { icon: 'ğŸ”´', label: 'Zomato / Hyperpure', color: '#e23744' },
  amazon: { icon: 'ğŸ“¦', label: 'Amazon', color: '#ff9900' },
  flipkart: { icon: 'ğŸ›’', label: 'Flipkart', color: '#2874f0' },
  bigbasket: { icon: 'ğŸ§º', label: 'BigBasket', color: '#84c225' },
  jiomart: { icon: 'ğŸ”µ', label: 'JioMart', color: '#0078ad' },
  blinkit: { icon: 'âš¡', label: 'Blinkit', color: '#f7d600' },
  instagram_shop: { icon: 'ğŸ“¸', label: 'Instagram Shop', color: '#e1306c' },
  whatsapp: { icon: 'ğŸ’¬', label: 'WhatsApp Orders', color: '#25d366' }
};

// Standard product types for grouping across brands
const PRODUCT_GROUPS = [
  { name: 'Chicken Pickle', keywords: ['chicken','chk','kodi'] },
  { name: 'Mutton Pickle', keywords: ['mutton','goat','mamsam'] },
  { name: 'Prawns / Shrimp Pickle', keywords: ['prawn','shrimp','royyala'] },
  { name: 'Fish Pickle', keywords: ['fish','chepala'] },
  { name: 'Avakaya (Raw Mango)', keywords: ['avakaya','avakay','avakai','raw mango','mango pickle'] },
  { name: 'Gongura Pickle', keywords: ['gongura','sorrel'] },
  { name: 'Tomato Pickle', keywords: ['tomato'] },
  { name: 'Lemon Pickle', keywords: ['lemon','nimma'] },
  { name: 'Garlic Pickle', keywords: ['garlic','velluli'] },
  { name: 'Mixed Veg Pickle', keywords: ['mixed','mix veg'] },
  { name: 'Mango Thokku', keywords: ['thokku','tokku'] },
  { name: 'Red Chilli Pickle', keywords: ['red chilli','mirchi','mirapakay'] },
  { name: 'Pandu Mirchi', keywords: ['pandu','pandumirchi'] },
  { name: 'Kakarakaya (Bitter Gourd)', keywords: ['kakarakaya','bitter gourd','bitter guard'] },
  { name: 'Ginger Pickle', keywords: ['ginger','allam'] },
  { name: 'Biryani Masala', keywords: ['biryani'] },
  { name: 'Podi / Powder', keywords: ['podi','powder','karam'] },
  { name: 'Sweets', keywords: ['sweet','halwa','laddu','ladoo','mysore pak','bobbatlu'] }
];

function getMarketPresence(){
  try { const s = localStorage.getItem('seasalt_presence'); return s ? JSON.parse(s) : DEFAULT_PRESENCE; }
  catch(e){ return DEFAULT_PRESENCE; }
}
function saveMarketPresence(data){
  localStorage.setItem('seasalt_presence', JSON.stringify(data));
}

// Platform price data (user-entered â€” persisted in localStorage)
function getPlatformPrices(){
  try { const s = localStorage.getItem('seasalt_platform_prices'); return s ? JSON.parse(s) : []; }
  catch(e){ return []; }
}
function savePlatformPrices(data){
  localStorage.setItem('seasalt_platform_prices', JSON.stringify(data));
}

function renderProducts(){
  const withProducts=WEB_INTEL.filter(w=>w.product_count>0);
  const withPrices=WEB_INTEL.filter(w=>w.price_min>0);
  const withEcom=WEB_INTEL.filter(w=>w.has_ecommerce);
  const presence=getMarketPresence();

  // Stats
  document.getElementById('sProdBrands').textContent=WEB_INTEL.length||'0';
  document.getElementById('sProdEcom').textContent=withEcom.length;
  if(withPrices.length){
    document.getElementById('sProdMinAvg').textContent='â‚¹'+Math.round(withPrices.reduce((s,w)=>s+parseFloat(w.price_min),0)/withPrices.length);
    document.getElementById('sProdMaxAvg').textContent='â‚¹'+Math.round(withPrices.reduce((s,w)=>s+parseFloat(w.price_max),0)/withPrices.length);
    const cheapest=withPrices.reduce((a,b)=>parseFloat(a.price_min)<parseFloat(b.price_min)?a:b);
    document.getElementById('sProdCheapest').textContent=cheapest.name+' (â‚¹'+Math.round(parseFloat(cheapest.price_min))+')';
  }

  // Count unique product types detected
  const allProds = WEB_INTEL.flatMap(w=>safeJSON(w.products));
  const detectedGroups = PRODUCT_GROUPS.filter(g=>allProds.some(p=>g.keywords.some(k=>p.toLowerCase().includes(k))));
  document.getElementById('sProdTypes').textContent=detectedGroups.length;

  // â•â•â• 1. MARKET PRESENCE MAP â•â•â•
  renderPresenceMap(presence);

  // â•â•â• 2. PRICE RANGE CHART â•â•â•
  const pc=document.getElementById('priceChartArea');
  if(!withPrices.length){pc.innerHTML='<div class="empty-state" style="padding:20px"><p>Run website scan to detect prices</p></div>'}
  else{
    const maxP=Math.max(...withPrices.map(w=>parseFloat(w.price_max)||0),1);
    pc.innerHTML='<div style="display:flex;flex-direction:column;gap:10px">'+withPrices.map(w=>{
      const mn=parseFloat(w.price_min)||0,mx=parseFloat(w.price_max)||0,av=parseFloat(w.price_avg)||0;
      const leftPct=Math.round((mn/maxP)*100);
      const widthPct=Math.max(Math.round(((mx-mn)/maxP)*100),2);
      return`<div style="display:flex;align-items:center;gap:12px">
        <div style="width:130px;font-size:12px;font-weight:600;text-align:right;color:${w.is_self?'var(--accent-red)':'var(--text-primary)'}">${esc(w.name)}${w.is_self?' ğŸ”±':''}</div>
        <div style="flex:1;height:28px;background:var(--bg-elevated);border-radius:6px;position:relative;overflow:hidden">
          <div style="position:absolute;left:${leftPct}%;width:${widthPct}%;height:100%;background:${w.is_self?'var(--accent-red)':w.color||'var(--accent-blue)'};border-radius:6px;opacity:0.7;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;font-weight:600">${av?'â‚¹'+Math.round(av):''}</div>
        </div>
        <div style="width:160px;font-size:11px;color:var(--text-muted)">â‚¹${Math.round(mn)} â€” â‚¹${Math.round(mx)}${av?' (avg â‚¹'+Math.round(av)+')':''}</div>
      </div>`;
    }).join('')+'</div>';
  }

  // â•â•â• 3. PRODUCT GROUPS â•â•â•
  renderProductGroups();

  // â•â•â• 4. PLATFORM PRICE COMPARISON â•â•â•
  renderPlatformPrices();

  // â•â•â• 5. PRODUCTS TABLE â•â•â•
  const pt=document.getElementById('prodTableArea');
  if(!WEB_INTEL.length){pt.innerHTML=empty('ğŸ›’','No Product Data','Run website scan to extract products and categories.','ğŸŒ Scan Websites','syncWebIntel()');return}
  let pHtml=`<table class="data-table"><thead><tr><th>Brand</th><th>Products</th><th>Categories</th><th>Price Min</th><th>Price Max</th><th>Price Avg</th><th>E-com</th><th>Platforms</th></tr></thead><tbody>`;
  for(const w of WEB_INTEL){
    const prods=safeJSON(w.products);
    const cats=safeJSON(w.categories);
    const bp=presence[w.code]||{};
    const platCount=Object.values(bp).filter(v=>v).length;
    pHtml+=`<tr style="${w.is_self?'background:rgba(220,38,38,.04)':''}">
      <td style="font-weight:600;color:var(--text-primary)">${esc(w.name)}${w.is_self?' ğŸ”±':''}</td>
      <td><span style="font-weight:700">${w.product_count||0}</span>${prods.length?`<div style="font-size:10px;color:var(--text-muted);margin-top:2px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${prods.slice(0,3).map(p=>esc(p)).join(', ')}${prods.length>3?' +'+(prods.length-3)+' more':''}</div>`:''}</td>
      <td>${cats.length?cats.slice(0,4).map(c=>`<span class="badge badge-violet" style="margin:1px;font-size:9px">${esc(c)}</span>`).join('')+(cats.length>4?`<span style="font-size:10px;color:var(--text-muted)"> +${cats.length-4}</span>`:''):'â€”'}</td>
      <td style="font-weight:600;color:var(--accent-emerald)">${w.price_min>0?'â‚¹'+Math.round(parseFloat(w.price_min)):'â€”'}</td>
      <td style="font-weight:600;color:var(--accent-red)">${w.price_max>0?'â‚¹'+Math.round(parseFloat(w.price_max)):'â€”'}</td>
      <td>${w.price_avg>0?'â‚¹'+Math.round(parseFloat(w.price_avg)):'â€”'}</td>
      <td>${w.has_ecommerce?'<span class="badge badge-green">âœ“</span>':'<span class="badge badge-red">âœ—</span>'}</td>
      <td><span class="badge badge-blue">${platCount}</span></td>
    </tr>`;
  }
  pHtml+='</tbody></table>';
  pt.innerHTML=pHtml;

  // â•â•â• 6. CATEGORY CLOUD â•â•â•
  const allCats={};
  WEB_INTEL.forEach(w=>{const cats=safeJSON(w.categories);cats.forEach(c=>{if(!allCats[c])allCats[c]=[];allCats[c].push(w.code)})});
  const catEl=document.getElementById('prodCatsArea');
  if(!Object.keys(allCats).length){catEl.innerHTML='<div class="empty-state" style="padding:20px"><p>No categories detected yet</p></div>';return}
  catEl.innerHTML='<div style="display:flex;flex-wrap:wrap;gap:8px;padding:8px">'+Object.entries(allCats).sort((a,b)=>b[1].length-a[1].length).map(([cat,codes])=>`<div style="background:var(--bg-elevated);border-radius:8px;padding:8px 12px;font-size:12px"><div style="font-weight:600">${esc(cat)}</div><div style="font-size:10px;color:var(--text-muted);margin-top:2px">${codes.join(', ')} (${codes.length} brand${codes.length>1?'s':''})</div></div>`).join('')+'</div>';
}

// â•â•â• RENDER: Market Presence Map â•â•â•
function renderPresenceMap(presence){
  const area=document.getElementById('presenceMapArea');
  if(!WEB_INTEL.length){area.innerHTML=empty('ğŸ—ºï¸','No Data','Run website scan first.','ğŸŒ Scan Websites','syncWebIntel()');return}

  const platforms=Object.keys(PLATFORM_META);
  let html=`<div style="overflow-x:auto"><table class="data-table"><thead><tr><th style="min-width:120px">Brand</th>`;
  for(const p of platforms){
    html+=`<th style="text-align:center;font-size:9px;min-width:65px">${PLATFORM_META[p].icon}<br>${PLATFORM_META[p].label}</th>`;
  }
  html+=`<th style="text-align:center">Total</th></tr></thead><tbody>`;

  for(const w of WEB_INTEL){
    const bp=presence[w.code]||{};
    const count=Object.values(bp).filter(v=>v).length;
    html+=`<tr style="${w.is_self?'background:rgba(220,38,38,.04)':''}">
      <td style="font-weight:600;color:${w.is_self?'var(--accent-red)':'var(--text-primary)'}"><span class="comp-dot" style="background:${w.color||'#666'}"></span> ${esc(w.name)}${w.is_self?' ğŸ”±':''}</td>`;
    for(const p of platforms){
      const active=bp[p]||false;
      html+=`<td style="text-align:center">${active?`<span style="color:${PLATFORM_META[p].color};font-size:16px">â—</span>`:'<span style="color:#ddd;font-size:14px">â—‹</span>'}</td>`;
    }
    html+=`<td style="text-align:center;font-weight:700">${count}<span style="font-size:10px;color:var(--text-muted)">/${platforms.length}</span></td></tr>`;
  }
  html+='</tbody></table></div>';

  // Platform summary
  const platformCounts=platforms.map(p=>({
    key:p, ...PLATFORM_META[p],
    count:WEB_INTEL.filter(w=>(presence[w.code]||{})[p]).length
  })).sort((a,b)=>b.count-a.count);

  html+=`<div style="display:flex;flex-wrap:wrap;gap:8px;padding:12px 0">${platformCounts.map(p=>
    `<div style="background:${p.count>0?p.color+'15':'var(--bg-elevated)'};border:1px solid ${p.count>0?p.color+'40':'var(--border-subtle)'};border-radius:8px;padding:8px 12px;min-width:100px;text-align:center">
      <div style="font-size:18px">${p.icon}</div>
      <div style="font-size:11px;font-weight:600;margin-top:2px">${p.label}</div>
      <div style="font-size:20px;font-weight:800;color:${p.color}">${p.count}</div>
      <div style="font-size:10px;color:var(--text-muted)">brands</div>
    </div>`
  ).join('')}</div>`;

  area.innerHTML=html;
}

// â•â•â• RENDER: Product Groups â•â•â•
function renderProductGroups(){
  const area=document.getElementById('prodGroupArea');
  if(!WEB_INTEL.length){area.innerHTML='<div class="empty-state" style="padding:20px"><p>No product data yet</p></div>';return}

  const groups=[];
  for(const g of PRODUCT_GROUPS){
    const matches=[];
    for(const w of WEB_INTEL){
      const prods=safeJSON(w.products);
      const prices=[...safeJSON(w.categories)]; // not prices, but we use price_min/max
      const found=prods.filter(p=>g.keywords.some(k=>p.toLowerCase().includes(k)));
      if(found.length>0){
        matches.push({ brand: w.name, code: w.code, color: w.color, is_self: w.is_self,
          products: found, price_min: parseFloat(w.price_min)||0, price_max: parseFloat(w.price_max)||0, price_avg: parseFloat(w.price_avg)||0 });
      }
    }
    if(matches.length>0){
      const avgPrice=matches.filter(m=>m.price_avg>0).length>0?Math.round(matches.filter(m=>m.price_avg>0).reduce((s,m)=>s+m.price_avg,0)/matches.filter(m=>m.price_avg>0).length):0;
      groups.push({ ...g, matches, avgPrice });
    }
  }

  if(!groups.length){area.innerHTML='<div class="empty-state" style="padding:20px"><p>No products detected yet â€” scan websites to auto-detect product types</p></div>';return}

  let html='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;padding:8px">';
  for(const g of groups.sort((a,b)=>b.matches.length-a.matches.length)){
    html+=`<div style="background:var(--bg-elevated);border-radius:10px;padding:14px;border:1px solid var(--border-subtle)">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
        <div style="font-size:14px;font-weight:700">${esc(g.name)}</div>
        <span class="badge badge-blue">${g.matches.length} brand${g.matches.length>1?'s':''}</span>
      </div>
      ${g.avgPrice>0?`<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Market Avg: <span style="font-weight:700;color:var(--accent-emerald);font-size:14px">â‚¹${g.avgPrice}</span></div>`:''}
      <div style="display:flex;flex-direction:column;gap:4px">
        ${g.matches.map(m=>`<div style="display:flex;align-items:center;gap:6px;font-size:12px">
          <span class="comp-dot" style="background:${m.color||'#666'};width:8px;height:8px"></span>
          <span style="font-weight:600;color:${m.is_self?'var(--accent-red)':'var(--text-primary)'}${m.is_self?';font-weight:700':''}">${esc(m.brand)}${m.is_self?' ğŸ”±':''}</span>
          ${m.price_avg>0?`<span style="margin-left:auto;color:var(--text-muted);font-size:11px">~â‚¹${Math.round(m.price_avg)}</span>`:''}
        </div>`).join('')}
      </div>
    </div>`;
  }
  html+='</div>';
  area.innerHTML=html;
}

// â•â•â• RENDER: Platform Price Comparison â•â•â•
function renderPlatformPrices(){
  const area=document.getElementById('platformPriceArea');
  const prices=getPlatformPrices();

  if(!prices.length){
    area.innerHTML=`<div class="empty-state" style="padding:30px">
      <div class="es-icon">ğŸ“Š</div>
      <h3>Track Price Variations Across Platforms</h3>
      <p>Add price data from Amazon, Swiggy, Zomato, etc. to compare how competitors price the same product differently on each platform.</p>
      <button class="btn btn-primary btn-sm" onclick="openAddPlatformPrice()">â• Add First Price Entry</button>
    </div>`;
    return;
  }

  // Group by brand
  const byBrand={};
  prices.forEach(p=>{
    if(!byBrand[p.brand])byBrand[p.brand]={};
    if(!byBrand[p.brand][p.product])byBrand[p.brand][p.product]={};
    byBrand[p.brand][p.product][p.platform]=p.price;
  });

  let html=`<div style="overflow-x:auto"><table class="data-table"><thead><tr><th>Brand</th><th>Product</th>`;
  const platKeys=[...new Set(prices.map(p=>p.platform))];
  for(const pk of platKeys){
    const meta=PLATFORM_META[pk]||{icon:'ğŸª',label:pk};
    html+=`<th style="text-align:center">${meta.icon} ${meta.label}</th>`;
  }
  html+=`<th style="text-align:center">Î” Variation</th></tr></thead><tbody>`;

  for(const [brand, products] of Object.entries(byBrand)){
    for(const [product, platforms] of Object.entries(products)){
      const pvals=Object.values(platforms).filter(v=>v>0);
      const variation=pvals.length>=2?Math.round(Math.max(...pvals)-Math.min(...pvals)):0;
      const variationPct=pvals.length>=2?Math.round(((Math.max(...pvals)-Math.min(...pvals))/Math.min(...pvals))*100):0;
      html+=`<tr>
        <td style="font-weight:600">${esc(brand)}</td>
        <td>${esc(product)}</td>`;
      for(const pk of platKeys){
        const val=platforms[pk];
        const isMin=val&&pvals.length>=2&&val===Math.min(...pvals);
        const isMax=val&&pvals.length>=2&&val===Math.max(...pvals);
        html+=`<td style="text-align:center;font-weight:600;${isMin?'color:var(--accent-emerald)':isMax?'color:var(--accent-red)':''}">${val?'â‚¹'+val:'â€”'}</td>`;
      }
      html+=`<td style="text-align:center"><span class="badge ${variationPct>15?'badge-red':variationPct>5?'badge-amber':'badge-green'}">${variation>0?'â‚¹'+variation+' ('+variationPct+'%)':'â€”'}</span></td></tr>`;
    }
  }
  html+='</tbody></table></div>';
  area.innerHTML=html;
}

// â•â•â• MODAL: Edit Market Presence â•â•â•
function openEditPresence(){
  const presence=getMarketPresence();
  const platforms=Object.keys(PLATFORM_META);
  let html=`<div class="modal-title">âœï¸ Edit Market Presence</div>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px">Mark which platforms each brand operates on</p>
    <div style="overflow-x:auto;max-height:60vh"><table class="data-table"><thead><tr><th>Brand</th>`;
  for(const p of platforms) html+=`<th style="text-align:center;font-size:9px">${PLATFORM_META[p].icon}<br>${PLATFORM_META[p].label.split(' ')[0]}</th>`;
  html+=`</tr></thead><tbody>`;

  for(const w of WEB_INTEL){
    const bp=presence[w.code]||{};
    html+=`<tr><td style="font-weight:600;font-size:12px">${esc(w.name)}</td>`;
    for(const p of platforms){
      html+=`<td style="text-align:center"><input type="checkbox" id="pres_${w.code}_${p}" ${bp[p]?'checked':''}></td>`;
    }
    html+=`</tr>`;
  }
  html+=`</tbody></table></div>
    <div style="display:flex;gap:10px;margin-top:12px">
      <button class="btn btn-emerald" onclick="savePresenceFromModal()">ğŸ’¾ Save</button>
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
    </div>`;
  showModal(html);
}

function savePresenceFromModal(){
  const presence=getMarketPresence();
  const platforms=Object.keys(PLATFORM_META);
  for(const w of WEB_INTEL){
    if(!presence[w.code])presence[w.code]={};
    for(const p of platforms){
      const cb=document.getElementById('pres_'+w.code+'_'+p);
      presence[w.code][p]=cb?cb.checked:false;
    }
  }
  saveMarketPresence(presence);
  closeModal();
  renderProducts();
  toast('âœ… Market presence updated');
}

// â•â•â• MODAL: Add Platform Price â•â•â•
function openAddPlatformPrice(){
  const brands=WEB_INTEL.map(w=>w.name);
  const platforms=Object.keys(PLATFORM_META);
  let html=`<div class="modal-title">â• Add Platform Price Data</div>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px">Track how the same product is priced across different platforms</p>
    <div class="field-group"><label class="field-label">Brand *</label>
      <select class="intel-input" id="ppBrand">${brands.map(b=>`<option>${b}</option>`).join('')}</select></div>
    <div class="field-group"><label class="field-label">Product Name *</label>
      <input class="intel-input" id="ppProduct" placeholder="e.g. Chicken Pickle 250g"></div>
    <div class="field-group"><label class="field-label">Platform *</label>
      <select class="intel-input" id="ppPlatform">${platforms.map(p=>`<option value="${p}">${PLATFORM_META[p].icon} ${PLATFORM_META[p].label}</option>`).join('')}</select></div>
    <div class="field-group"><label class="field-label">Price (â‚¹) *</label>
      <input class="intel-input" type="number" id="ppPrice" placeholder="e.g. 299"></div>
    <div style="display:flex;gap:10px;margin-top:8px">
      <button class="btn btn-emerald" onclick="savePlatformPrice()">ğŸ’¾ Save</button>
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
    </div>`;
  showModal(html);
}

function savePlatformPrice(){
  const brand=document.getElementById('ppBrand').value;
  const product=document.getElementById('ppProduct').value.trim();
  const platform=document.getElementById('ppPlatform').value;
  const price=parseFloat(document.getElementById('ppPrice').value);
  if(!product||!price){toast('âš ï¸ Fill all fields');return}
  const prices=getPlatformPrices();
  // Update existing or add new
  const existing=prices.findIndex(p=>p.brand===brand&&p.product===product&&p.platform===platform);
  if(existing>=0)prices[existing].price=price;
  else prices.push({brand,product,platform,price,added:new Date().toISOString()});
  savePlatformPrices(prices);
  closeModal();
  renderProducts();
  toast('âœ… Price added: '+brand+' '+product+' on '+PLATFORM_META[platform].label+' = â‚¹'+price);
}

function safeJSON(v){try{return typeof v==='string'?JSON.parse(v):(Array.isArray(v)?v:[])}catch(e){return[]}}

document.addEventListener('DOMContentLoaded',()=>{if(db)loadAll();else toast('âš ï¸ Supabase not connected')});
</script>
</body></html>
